<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Lucene," />





  <link rel="alternate" href="/atom.xml" title="IT草根" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="引言Lucene6.0于2016年4月8日发布，要求最低Java版本是Java 8。
相信大多数公司的数据库都需要采用分库分表等一些策略，而对于某些特定的业务需求，分别从不同的库不同的表中去检索特定的数据显得比较繁琐，而Lucene正好可以解决某些特殊需求，对于不同库不同表中的数据先建立全量索引，然后将需要检索的数据写入某个单独的表中，供其它业务需求方查询，以后的每天只需要做增量索引并写入数据表即">
<meta property="og:type" content="article">
<meta property="og:title" content="Lucene 6.0 实战（1）-创建索引">
<meta property="og:url" content="http://www.codepub.cn/2016/05/20/Lucene-6-0-in-action-1-Index-creation/index.html">
<meta property="og:site_name" content="IT草根">
<meta property="og:description" content="引言Lucene6.0于2016年4月8日发布，要求最低Java版本是Java 8。
相信大多数公司的数据库都需要采用分库分表等一些策略，而对于某些特定的业务需求，分别从不同的库不同的表中去检索特定的数据显得比较繁琐，而Lucene正好可以解决某些特殊需求，对于不同库不同表中的数据先建立全量索引，然后将需要检索的数据写入某个单独的表中，供其它业务需求方查询，以后的每天只需要做增量索引并写入数据表即">
<meta property="og:updated_time" content="2016-06-09T01:24:59.660Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lucene 6.0 实战（1）-创建索引">
<meta name="twitter:description" content="引言Lucene6.0于2016年4月8日发布，要求最低Java版本是Java 8。
相信大多数公司的数据库都需要采用分库分表等一些策略，而对于某些特定的业务需求，分别从不同的库不同的表中去检索特定的数据显得比较繁琐，而Lucene正好可以解决某些特殊需求，对于不同库不同表中的数据先建立全量索引，然后将需要检索的数据写入某个单独的表中，供其它业务需求方查询，以后的每天只需要做增量索引并写入数据表即">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 6264291807601886000,
      author: '博主'
    }
  };
</script>

  <title> Lucene 6.0 实战（1）-创建索引 | IT草根 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?2c61418f187553bcc869b755930233ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">IT草根</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">WangXu's 代码馆 BLOG</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-resume">
          <a href="/resume" rel="section">
            
              <i class="menu-item-icon fa fa-book fa-fw"></i> <br />
            
            简历
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links" rel="section">
            
              <i class="menu-item-icon fa fa-link fa-fw"></i> <br />
            
            友链
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'CEs2u-bRR6iHSt4ynbFA','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Lucene 6.0 实战（1）-创建索引
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-20T21:25:37+08:00" content="2016-05-20">
              2016-05-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          
		
		
			<!-- 在下面的位置加上如下代码 -->
			<span id="busuanzi_container_page_pv">&nbsp; | &nbsp; 热度&nbsp; <span id="busuanzi_value_page_pv"></span>°C</span>    
			<!-- 在上面的位置加上如上代码 -->  
		
		  
          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/20/Lucene-6-0-in-action-1-Index-creation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/20/Lucene-6-0-in-action-1-Index-creation/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="引言">引言</h3><p><strong>Lucene6.0</strong>于<strong>2016年4月8日</strong>发布，要求最低Java版本是<strong>Java 8</strong>。</p>
<p>相信大多数公司的数据库都需要采用分库分表等一些策略，而对于某些特定的业务需求，分别从不同的库不同的表中去检索特定的数据显得比较繁琐，而Lucene正好可以解决某些特殊需求，对于不同库不同表中的数据先建立全量索引，然后将需要检索的数据写入某个单独的表中，供其它业务需求方查询，以后的每天只需要做增量索引并写入数据表即可。</p>
<p>鉴于最近一直在做Lucene相关方面的工作，而本人一向又比较喜欢使用最新发布的版本，而网络上这类资源极少，故将一些要点及示例整理出来，本文主要从实战角度来介绍Lucene 6.0的使用，不涉及过多原理方面的东西，但是对于一些核心点也会有所提及。</p>
<h3 id="Lucene为什么这么流行">Lucene为什么这么流行</h3><p>Lucene是一个高效的，基于Java的全文检索库，生活中数据主要分为两种：结构化数据和非结构化数据。一般使用的XML、JSON、数据库等都是结构化数据，非结构化数据也叫全文数据，而这种全文数据正是Lucene的用武之地。全文检索主要有两个过程，索引创建（Indexing）和搜索索引（Search）。</p>
<p>Lucene是很多搜索引擎的一个基础实现，被很多大公司所采用，例如Netflix，MySpace，LinkedIn，Twitter，IBM等。可以通过如下几点特性对Lucene有个大概的认识</p>
<ul>
<li>在现代的硬件上一小时可以索引150GB的数据</li>
<li>索引20GB的文本文件，产生的索引文件大概是4-6GB</li>
<li>只需要1MB的堆内存</li>
<li>可定制的排序模型</li>
<li>支持多种查询类型</li>
<li>通过特定的字段搜索</li>
<li>通过特定的字段排序</li>
<li>近实时的索引和搜索</li>
<li>Faceting，Grouping，Highlighting，Suggestions等</li>
</ul>
<p>鉴于Lucene这么多强大的特性以及流行度，有很多种基于Lucene的搜索技术，其中最流行的两个是<strong>Apache Solr</strong>和<strong>Elastic search</strong>，当然还有许多其它不同语言的Lucene实现：</p>
<ul>
<li><strong>CLucene</strong>: Lucene implementation in C++ (<a href="http://sourceforge.net/projects/clucene/" target="_blank" rel="external">http://sourceforge.net/projects/clucene/</a>)</li>
<li><strong>Lucene.Net</strong>: Lucene implementation in Microsoft.NET (<a href="http://incubator.apache.org/lucene.net/" target="_blank" rel="external">http://incubator.apache.org/lucene.net/</a>)</li>
<li><strong>Lucene4c</strong>: Lucene implementation in C (<a href="http://incubator.apache.org/lucene4c/" target="_blank" rel="external">http://incubator.apache.org/lucene4c/</a>)</li>
<li><strong>LuceneKit</strong>: Lucene implementation in Objective-C, Cocoa/GNUstep support (<a href="https://github.com/tcurdt/lucenekit" target="_blank" rel="external">https://github.com/tcurdt/lucenekit</a>)</li>
<li><strong>Lupy</strong>: Lucene implementation in Python (RETIRED) (<a href="http://www.divmod.org/projects/lupy" target="_blank" rel="external">http://www.divmod.org/projects/lupy</a>)</li>
<li><strong>NLucene</strong>: This is another Lucene implementation in .NET (out of date) (<a href="http://sourceforge.net/projects/nlucene/" target="_blank" rel="external">http://sourceforge.net/projects/nlucene/</a>)</li>
<li><strong>Zend Search</strong>: Lucene implementation in the Zend Framework for PHP 5 (<a href="http://framework.zend.com/manual/en/zend.search.html" target="_blank" rel="external">http://framework.zend.com/manual/en/zend.search.html</a>)</li>
<li><strong>Plucene</strong>: Lucene implementation in Perl (<a href="http://search.cpan.org/search?query=plucene&amp;mode=all" target="_blank" rel="external">http://search.cpan.org/search?query=plucene&amp;mode=all</a>)</li>
<li><strong>KinoSearch</strong>: This is a new Lucene implementation in Perl (<a href="http://www.rectangular.com/kinosearch/" target="_blank" rel="external">http://www.rectangular.com/kinosearch/</a>)</li>
<li><strong>PyLucene</strong>: This is GCJ-compiled version of Java Lucene integrated with Python (<a href="http://pylucene.osafoundation.org/" target="_blank" rel="external">http://pylucene.osafoundation.org/</a>)</li>
<li><strong>MUTIS</strong>: Lucene implementation in Delphi (<a href="http://mutis.sourceforge.net/" target="_blank" rel="external">http://mutis.sourceforge.net/</a>)</li>
<li><strong>Ferret</strong>: Lucene implementation in Ruby (<a href="http://ferret.davebalmain.com/trac/" target="_blank" rel="external">http://ferret.davebalmain.com/trac/</a>)</li>
<li><strong>Montezuma</strong>: Lucene implementation in Common Lisp (<a href="http://www.cliki.net/Montezuma" target="_blank" rel="external">http://www.cliki.net/Montezuma</a>)</li>
</ul>
<h3 id="存储索引">存储索引</h3><p>索引由Lucene按照特定的格式创建，而创建出来的索引必然要存储在文件系统之上，Lucene在文件系统中存储索引的最基本的抽象实现类是BaseDirectory，该类继承自Directory，BaseDirectory有两个主要的实现类：</p>
<ul>
<li>FSDirectory：在文件系统上存储索引文件，有六个子类，如下是三个常用的子类<ul>
<li>SimpleFSDirectory：使用Files.newByteChannel实现，对并发支持不好，它会在多线程读取同一份文件时进行同步操作</li>
<li>NIOFSDirectory：使用Java NIO中的FileChannel去读取同一份文件，可以避免同步操作，但是由于Windows平台上存在<a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6265734" target="_blank" rel="external">Sun JRE bug</a>，所以在Windows平台上不推荐使用</li>
<li>MMapDirectory：在读取的时候使用内存映射IO，如果你的虚拟内存足够容纳索引文件大小的话，这是一个很棒的选择</li>
</ul>
</li>
<li>RAMDirectory：在内存中暂存索引文件，只对小索引好，大索引会出现频繁GC</li>
</ul>
<p>通常情况下，如果索引文件存储在文件系统之上，我们无需自己选择使用FSDirectory的某个实现子类，只要使用FSDirectory中的open(Path path)方法即可，英文doc如下：</p>
<blockquote>
<p>Creates an FSDirectory instance, trying to pick the best implementation given the current environment. The directory returned uses the NativeFSLockFactory. The directory is created at the named location if it does not yet exist.</p>
</blockquote>
<p>该方法可以自动根据当前使用的系统环境而选择一个最佳的实现子类，其选择策略是</p>
<ul>
<li>对于Linux，MacOSX，Solaris，Windows 64-bit JREs返回MMapDirectory</li>
<li>对于其它非Windows上的JREs，返回NIOFSDirectory</li>
<li>对于其它Windows上的JREs，返回SimpleFSDirectory</li>
</ul>
<p><strong>MMapDirectory</strong>就目前来说，是比较好的实现。它使用virtual memory和mmap来访问磁盘文件。一般的方法都是依赖系统调用在文件系统cache以及Java heap之间拷贝数据。那么怎么才能直接访问文件系统cache呢？这就是mmap的作用！</p>
<p>简单说MMapDirectory就是把lucene的索引当作swap file来处理。mmap()系统调用让OS把整个索引文件映射到虚拟地址空间，这样Lucene就会觉得索引在内存中。然后Lucene就可以像访问一个超大的byte[]数据（在Java中这个数据被封装在ByteBuffer接口里）一样访问磁盘上的索引文件。Lucene在访问虚拟空间中的索引时，不需要任何的系统调用，CPU里的MMU（memory management unit）和TLB（translation lookaside buffers, 它cache了频繁被访问的page）会处理所有的映射工作。如果数据还在磁盘上，那么MMU会发起一个中断，OS将会把数据加载进文件系统Cache。如果数据已经在cache里了，MMU/TLB会直接把数据映射到内存，这只需要访问内存，速度很快。程序员不需要关心paging in/out，所有的这些都交给OS。而且，这种情况下没有并发的干扰，唯一的问题就是Java的ByteBuffer封装后的byte[]稍微慢一些，但是Java里要想用mmap就只能用这个接口。还有一个很大的优点就是所有的内存issue都由OS来负责，这样没有GC的问题。</p>
<h3 id="索引核心类">索引核心类</h3><p>执行简单的索引过程需要用到以下几个类：</p>
<ul>
<li><strong>IndexWriter</strong>：负责创建索引或打开已有索引</li>
<li><strong>IndexWriterConfig</strong>：持有创建IndexWriter的所有配置项</li>
<li><strong>Directory</strong>：描述了Lucene索引的存放位置，它的子类负责具体指定索引的存储路径</li>
<li><strong>Analyzer</strong>：负责文本分析，从被索引文本文件中提取出语汇单元。对于文本分析器Analyzer，需要注意一点，就是使用哪种Analyzer进行索引创建，查询的时候也要使用哪种Analyzer查询，否则查询结果不正确。</li>
<li><strong>Document</strong>：代表一些域（Field）的集合，你可以将Document对象理解为虚拟文档-例如Web页面、E-mail信息或者文本文件</li>
<li><strong>Field</strong>：索引中的每个文档都包含一个或多个不同命名的域，每个域都有一个域名和对应的域值</li>
<li><strong>FieldType</strong>：描述了Field的各种属性，在不使用某种具体的Field类型（例如StringField，TextField）时需要用到此类</li>
</ul>
<h3 id="创建索引">创建索引</h3><p>索引的创建方式有三种，通过IndexWriterConfig.OpenMode进行指定，分别是</p>
<ul>
<li>CREATE：创建一个新的索引或者覆写已经存在的索引</li>
<li>APPEND：打开一个已经存在的索引</li>
<li>CREATE_OR_APPEND：如果不存在则创建新的索引，如果存在则追加索引</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 创建索引写入器</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> indexPath</span><br><span class="line"> * <span class="doctag">@param</span> create</span><br><span class="line"> * <span class="doctag">@throws</span> IOException</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IndexWriter <span class="title">getIndexWriter</span><span class="params">(String indexPath, <span class="keyword">boolean</span> create)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer());</span><br><span class="line">    <span class="keyword">if</span> (create) &#123;</span><br><span class="line">        indexWriterConfig.setOpenMode(IndexWriterConfig.OpenMode.CREATE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        indexWriterConfig.setOpenMode(IndexWriterConfig.OpenMode.CREATE_OR_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">    Directory directory = FSDirectory.open(Paths.get(indexPath));</span><br><span class="line">    IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</span><br><span class="line">    <span class="keyword">return</span> indexWriter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果仅仅做测试用，还可以将索引文件存储在内存之中，此时需要使用RAMDirectory<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LuceneDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Directory directory;</span><br><span class="line">    <span class="keyword">private</span> String[] ids = &#123;<span class="string">"1"</span>, <span class="string">"2"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String[] unIndex = &#123;<span class="string">"Netherlands"</span>, <span class="string">"Italy"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String[] unStored = &#123;<span class="string">"Amsterdam has lots of bridges"</span>, <span class="string">"Venice has lots of canals"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> String[] text = &#123;<span class="string">"Amsterdam"</span>, <span class="string">"Venice"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> IndexWriter indexWriter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer());</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        directory = <span class="keyword">new</span> RAMDirectory();</span><br><span class="line">        <span class="comment">//指定将索引创建信息打印到控制台</span></span><br><span class="line">        indexWriterConfig.setInfoStream(System.out);</span><br><span class="line">        indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</span><br><span class="line">        indexWriterConfig = (IndexWriterConfig) indexWriter.getConfig();</span><br><span class="line">        FieldType fieldType = <span class="keyword">new</span> FieldType();</span><br><span class="line">        fieldType.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);</span><br><span class="line">        fieldType.setStored(<span class="keyword">true</span>);<span class="comment">//存储</span></span><br><span class="line">        fieldType.setTokenized(<span class="keyword">true</span>);<span class="comment">//分词</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ids.length; i++) &#123;</span><br><span class="line">            Document document = <span class="keyword">new</span> Document();</span><br><span class="line">            document.add(<span class="keyword">new</span> Field(<span class="string">"id"</span>, ids[i], fieldType));</span><br><span class="line">            document.add(<span class="keyword">new</span> Field(<span class="string">"country"</span>, unIndex[i], fieldType));</span><br><span class="line">            document.add(<span class="keyword">new</span> Field(<span class="string">"contents"</span>, unStored[i], fieldType));</span><br><span class="line">            document.add(<span class="keyword">new</span> Field(<span class="string">"city"</span>, text[i], fieldType));</span><br><span class="line">            indexWriter.addDocument(document);</span><br><span class="line">        &#125;</span><br><span class="line">        indexWriter.commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>NOTES</strong>：在调用IndexWriter的close()方法时会自动调用commit()方法，在调用commit()方法时会自动调用flush()方法。所以一般无需这样操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">indexWriter.flush();</span><br><span class="line">indexWriter.commit();</span><br><span class="line">indexWriter.close();</span><br></pre></td></tr></table></figure></p>
<p>控制台输出索引创建信息如下：</p>
<blockquote>
<p>IFD 0 [2016-05-19T07:10:21.127Z; main]: init: current segments file is “segments”; deletionPolicy=org.apache.lucene.index.KeepOnlyLastCommitDeletionPolicy@691a7f8f<br>IFD 0 [2016-05-19T07:10:21.167Z; main]: delete []<br>IFD 0 [2016-05-19T07:10:21.167Z; main]: now checkpoint “” [0 segments ; isCommit = false]<br>IFD 0 [2016-05-19T07:10:21.167Z; main]: delete []<br>IFD 0 [2016-05-19T07:10:21.167Z; main]: 0 msec to checkpoint<br>IW 0 [2016-05-19T07:10:21.167Z; main]: init: create=true<br>IW 0 [2016-05-19T07:10:21.168Z; main]:<br>…<br>…<br>DW 0 [2016-05-19T07:10:21.271Z; main]: main finishFullFlush success=true<br>IW 0 [2016-05-19T07:10:21.271Z; main]: startCommit(): start<br>IW 0 [2016-05-19T07:10:21.271Z; main]:   skip startCommit(): no changes pending<br>IFD 0 [2016-05-19T07:10:21.271Z; main]: delete []<br>IW 0 [2016-05-19T07:10:21.271Z; main]: commit: pendingCommit == null; skip<br>IW 0 [2016-05-19T07:10:21.271Z; main]: commit: took 0.4 msec<br>IW 0 [2016-05-19T07:10:21.271Z; main]: commit: done<br>IW 0 [2016-05-19T07:10:21.271Z; main]: rollback<br>IW 0 [2016-05-19T07:10:21.271Z; main]: all running merges have aborted<br>IW 0 [2016-05-19T07:10:21.271Z; main]: rollback: done finish merges<br>DW 0 [2016-05-19T07:10:21.271Z; main]: abort<br>DW 0 [2016-05-19T07:10:21.271Z; main]: done abort success=true<br>IW 0 [2016-05-19T07:10:21.271Z; main]: rollback: infos=_0(6.0.0):c2<br>IFD 0 [2016-05-19T07:10:21.271Z; main]: now checkpoint “_0(6.0.0):c2” [1 segments ; isCommit = false]<br>IFD 0 [2016-05-19T07:10:21.272Z; main]: delete []<br>IFD 0 [2016-05-19T07:10:21.272Z; main]: 0 msec to checkpoint<br>IFD 0 [2016-05-19T07:10:21.272Z; main]: delete []<br>IFD 0 [2016-05-19T07:10:21.272Z; main]: delete []</p>
</blockquote>
<h3 id="删除文档">删除文档</h3><p>在IndexWriter中提供了从索引中删除Document的接口，分别是</p>
<ul>
<li>deleteDocuments(Query… queries)：删除所有匹配到查询语句的Document</li>
<li>deleteDocuments(Term… terms)：删除所有包含有terms的Document</li>
<li>deleteAll()：删除索引中所有的Document</li>
</ul>
<p>NOTES: deleteDocuments(Term… terms)方法，只接受Term参数，而Term只提供如下四个构造函数</p>
<ul>
<li>Term(String fld, BytesRef bytes)</li>
<li>Term(String fld, BytesRefBuilder bytesBuilder)</li>
<li>Term(String fld, String text)</li>
<li>Term(String fld)</li>
</ul>
<p>所以我们无法使用deleteDocuments(Term… terms)去删除一些非String值的Field，例如IntPoint，LongPoint，FloatPoint，DoublePoint等。这时候就需要借助传递Query实例的方法去删除包含某些特定类型Field的Document。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RAMDirectory ramDirectory = <span class="keyword">new</span> RAMDirectory();</span><br><span class="line">    IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(ramDirectory, <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer()));</span><br><span class="line">    Document document = <span class="keyword">new</span> Document();</span><br><span class="line">    document.add(<span class="keyword">new</span> IntPoint(<span class="string">"ID"</span>, <span class="number">1</span>));</span><br><span class="line">    indexWriter.addDocument(document);</span><br><span class="line">    indexWriter.commit();</span><br><span class="line">    <span class="comment">//无法删除ID为1的</span></span><br><span class="line">    indexWriter.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"ID"</span>, <span class="string">"1"</span>));</span><br><span class="line">    indexWriter.commit();</span><br><span class="line">    DirectoryReader open = DirectoryReader.open(ramDirectory);</span><br><span class="line">    IndexSearcher indexSearcher = <span class="keyword">new</span> IndexSearcher(open);</span><br><span class="line">    Query query = IntPoint.newExactQuery(<span class="string">"ID"</span>, <span class="number">1</span>);</span><br><span class="line">    TopDocs search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">    <span class="comment">//命中，1，说明并未删除</span></span><br><span class="line">    System.out.println(search.totalHits);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用Query删除</span></span><br><span class="line">    indexWriter.deleteDocuments(query);</span><br><span class="line">    indexWriter.commit();</span><br><span class="line">    indexSearcher = <span class="keyword">new</span> IndexSearcher(DirectoryReader.openIfChanged(open));</span><br><span class="line">    search = indexSearcher.search(query, <span class="number">10</span>);</span><br><span class="line">    <span class="comment">//未命中，0，说明已经删除</span></span><br><span class="line">    System.out.println(search.totalHits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考资料<br>【1】<a href="http://www.cnblogs.com/huangfox/p/3616298.html" target="_blank" rel="external">http://www.cnblogs.com/huangfox/p/3616298.html</a></p>

      
    </div>

    <div>
      
        
<div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton", disable="enable", onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}", style="cursor: pointer; border: 0; outline: 0; border-radius: 100%; padding: 0; margin: 0; letter-spacing: normal; text-transform: none; text-indent: 0px; text-shadow: none">
    <span onmouseover="this.style.color='rgb(236,96,0)';this.style.background='rgb(204,204,204)'" onMouseOut="this.style.color='#fff';this.style.background='rgb(236,96,0)'" style="display: inline-block; width: 70px; height: 70px; border-radius: 100%; line-height: 81px; color: #fff; font: 400 35px/75px 'microsofty'; background: rgb(236,96,0)">赏</span>
  </button>
  <div id="QR" style="display: none;">
    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="http://7xig3q.com1.z0.glb.clouddn.com/weixin-donate.png" alt="Wang Xu WeChat Pay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>微信打赏</p>
      </div>
    
    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="http://7xig3q.com1.z0.glb.clouddn.com/alipay-donate.png" alt="Wang Xu Alipay" style="width: 200px; max-width: 100%; display: inline-block"/>
        <p>支付宝打赏</p>
      </div>
    
  </div>
<div>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Lucene/" rel="tag">#Lucene</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/05/11/The-correct-way-to-use-java-jar-run-an-executable-jar-package-under-Linux/" rel="next" title="Linux下使用java -jar运行可执行jar包的正确方式">
                <i class="fa fa-chevron-left"></i> Linux下使用java -jar运行可执行jar包的正确方式
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/05/20/Lucene-6-0-in-action-2-All-kinds-of-Field-and-sort-operations/" rel="prev" title="Lucene 6.0实战（2）-各种Field及排序操作">
                Lucene 6.0实战（2）-各种Field及排序操作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/05/20/Lucene-6-0-in-action-1-Index-creation/"
     data-title="Lucene 6.0 实战（1）-创建索引"
     data-content=""
     data-url="http://www.codepub.cn/2016/05/20/Lucene-6-0-in-action-1-Index-creation/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="monthly" data-num-items="8"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/05/20/Lucene-6-0-in-action-1-Index-creation/"
           data-title="Lucene 6.0 实战（1）-创建索引" data-url="http://www.codepub.cn/2016/05/20/Lucene-6-0-in-action-1-Index-creation/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/author.jpg"
               alt="Wang Xu" />
          <p class="site-author-name" itemprop="name">Wang Xu</p>
          <p class="site-description motion-element" itemprop="description">志不强者智不达，言不信者行不果</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">57</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/shijiebei2009" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/codepub" target="_blank">
                  
                    <i class="fa fa-linkedin"></i> Linkedin
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://stackoverflow.com/users/4204922/eric-wang" target="_blank">
                  
                    <i class="fa fa-stackoverflow"></i> Stackoverflow
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/codepub.cn" target="_blank">
                  
                    <i class="fa fa-zhihu"></i> ZhiHu
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/shijiebei2009/" target="_blank">
                  
                    <i class="fa fa-douban"></i> DouBan
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1779238484" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lucene为什么这么流行"><span class="nav-number">2.</span> <span class="nav-text">Lucene为什么这么流行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存储索引"><span class="nav-number">3.</span> <span class="nav-text">存储索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引核心类"><span class="nav-number">4.</span> <span class="nav-text">索引核心类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建索引"><span class="nav-number">5.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除文档"><span class="nav-number">6.</span> <span class="nav-text">删除文档</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Xu</span>&nbsp;&nbsp;&nbsp;
  <a href="http://tongji.baidu.com/web/welcome/ico?s=2c61418f187553bcc869b755930233ab" target="_blank">百度统计</a>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
  <span id="busuanzi_container_site_pv">本站总访问量 <span id="busuanzi_value_site_pv"></span> 次</span><span id="busuanzi_container_site_uv">&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;访客数 <span id="busuanzi_value_site_uv"></span> 人次</span><span id="busuanzi_container_page_pv">&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次</span>
</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"codepub"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  


<a href="https://github.com/shijiebei2009"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
</body>
</html>
