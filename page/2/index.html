<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="IT草根, 代码馆, http://codepub.cn/" />





  <link rel="alternate" href="/atom.xml" title="IT草根" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="志不强者智不达，言不信者行不果">
<meta property="og:type" content="website">
<meta property="og:title" content="IT草根">
<meta property="og:url" content="http://www.codepub.cn/page/2/index.html">
<meta property="og:site_name" content="IT草根">
<meta property="og:description" content="志不强者智不达，言不信者行不果">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IT草根">
<meta name="twitter:description" content="志不强者智不达，言不信者行不果">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> IT草根 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61517808-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?2c61418f187553bcc869b755930233ab";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">IT草根</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">WangXu's 代码馆 BLOG</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-resume">
          <a href="/resume" rel="section">
            
            简历
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links" rel="section">
            
            友链
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/08/29/Selenium-simulated-user-login-alipay-account-query-transaction-details/" itemprop="url">
                  使用Selenium模拟用户登录支付宝账户查询交易详情
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-08-29T21:39:00+08:00" content="2015-08-29">
              2015-08-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/29/Selenium-simulated-user-login-alipay-account-query-transaction-details/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/29/Selenium-simulated-user-login-alipay-account-query-transaction-details/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Selenium简介">Selenium简介</h3><p><code>Selenium</code>是一个用于Web应用程序测试的工具。<code>Selenium</code>测试直接运行在浏览器中，就像真正的用户在操作一样。支持的浏览器包括IE、Mozilla Firefox、Chrome等。这个工具的主要功能包括：测试与浏览器的兼容性——测试你的应用程序看是否能够很好得工作在不同浏览器和操作系统之上。测试系统功能——创建回归测试检验软件功能和用户需求。支持自动录制动作和自动生成<code>.Net</code>、<code>Java</code>、<code>Perl</code>等不同语言的测试脚本。<code>Selenium</code>是<code>ThoughtWorks</code>专门为Web应用程序编写的一个验收测试工具。</p>
<h3 id="Selenium的优势">Selenium的优势</h3><p>据<code>Selenium</code>主页所说，与其他测试工具相比，使用<code>Selenium</code>的最大好处是：<code>Selenium</code>测试直接在浏览器中运行，就像真实用户所做的一样。<code>Selenium</code>测试可以在<code>Windows</code>、<code>Linux</code>和<code>Macintosh</code>上的<code>Internet Explorer</code>、<code>Mozilla</code>和<code>Firefox</code>中运行。其他测试工具都不能覆盖如此多的平台。使用<code>Selenium</code>和在浏览器中运行测试还有很多其他好处。下面是主要的两大好处：</p>
<ul>
<li>通过编写模仿用户操作的<code>Selenium</code>测试脚本，可以从终端用户的角度来测试应用程序</li>
<li>通过在不同浏览器中运行测试，更容易发现浏览器的不兼容性</li>
</ul>
<p><code>Selenium</code>的核心，也称<code>browser bot</code>，是用<code>JavaScript</code>编写的。这使得测试脚本可以在受支持的浏览器中运行。<code>browser bot</code>负责执行从测试脚本接收到的命令，测试脚本要么是用<code>HTML</code>的表布局编写的，要么是使用一种受支持的编程语言编写的。</p>
<h3 id="Selenium-WebDriver">Selenium-WebDriver</h3><p><code>Selenium-WebDriver</code>支持如下浏览器，在所有支持这些浏览器的操作系统中能都运行良好。</p>
<ul>
<li>Google Chrome 12.0.712.0+</li>
<li>Internet Explorer 6, 7, 8, 9 - 32 and 64-bit where applicable</li>
<li>Firefox 3.0, 3.5, 3.6, 4.0, 5.0, 6, 7</li>
<li>Opera 11.5+</li>
<li>HtmlUnit 2.9</li>
<li>Android – 2.3+ for phones and tablets (devices &amp; emulators)</li>
<li>iOS 3+ for phones (devices &amp; emulators) and 3.2+ for tablets (devices &amp; emulators)</li>
</ul>
<h3 id="Selenium开发环境">Selenium开发环境</h3><p>如欲使用Java语言，那么JDK的环境是必备的。使用<code>Selenium</code>来驱动浏览器，那么必须要有<a href="http://pan.baidu.com/s/1o6quY5G" target="_blank" rel="external">浏览器驱动包</a>，同样还需要<a href="http://pan.baidu.com/s/1o6vKGh8" target="_blank" rel="external">Selenium的Jar包</a>，点击下载即可。</p>
<h3 id="Selenium启动浏览器">Selenium启动浏览器</h3><h4 id="启动Firefox">启动Firefox</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//后一个参数是Firefox的安装路径</span></span><br><span class="line">System.setProperty(<span class="string">"webdriver.firefox.bin"</span>, <span class="string">"C:/Program Files (x86)/Mozilla Firefox/firefox.exe"</span>);</span><br><span class="line">WebDriver driver = <span class="keyword">new</span> FirefoxDriver();</span><br><span class="line">driver.get(<span class="string">"www.baidu.com"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="启动Chrome">启动Chrome</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//后一个参数是Chrome浏览器的驱动，需要下载</span></span><br><span class="line">System.setProperty(<span class="string">"webdriver.chrome.driver"</span>, <span class="string">"D:/chromedriver.exe"</span>);</span><br><span class="line">WebDriver driver = <span class="keyword">new</span> ChromeDriver();</span><br><span class="line">driver.get(<span class="string">"www.baidu.com"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="启动IE">启动IE</h4><p>作为开发人员，建议您应该远离IE，虽然我不太愿意提供IE的启动方式给您！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">"webdriver.ie.driver"</span>, <span class="string">"D:/IEDriverServer.exe"</span>);</span><br><span class="line">WebDriver driver = <span class="keyword">new</span> InternetExplorerDriver();</span><br><span class="line">driver.get(<span class="string">"www.baidu.com"</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="常见问题的处理方法">常见问题的处理方法</h3><blockquote>
<p>How to select any element from the web element with “display: none” attribute using Selenium ?<br>特别是在处理因为<code>&lt;select&gt;</code>标签中带有<code>style=&#39;display:none&#39;</code>而无法设置option的情况时很有效！</p>
</blockquote>
<p>方法：</p>
<blockquote>
<p>Use execute_script() to set the display property of that element and then use the Selenium Select for selecting a required value.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavascriptExecutor js = (JavascriptExecutor) driver;<span class="comment">//将driver对象强转成JavascriptExecutor</span></span><br><span class="line">js.executeScript(<span class="string">"document.getElementById('J-select-range').style.display='inline';"</span>);<span class="comment">//修改display的值，也可以修改为display='list-item'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Element is not currently visible and may not be manipulated</p>
</blockquote>
<p>一般这种错误是因为父元素有<code>style=&#39;display:none&#39;</code>属性或者是页面还没有加载完全，最简单的就是使用<code>Thread.sleep(1000);</code>休息一秒之后再操作。当然也可以使用until方法直到其出现再对其进行操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WebDriverWait wait = <span class="keyword">new</span> WebDriverWait(driver, <span class="number">300</span>);</span><br><span class="line">WebElement selectElement = wait.until(ExpectedConditions.visibilityOfElementLocated(By.id(<span class="string">"formLevel:levels_input"</span>)));</span><br><span class="line">Select select = <span class="keyword">new</span> Select(selectElement);</span><br><span class="line">select.selectByVisibleText(<span class="string">"SECURITY"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="模拟用户登录支付宝查询交易信息的程序">模拟用户登录支付宝查询交易信息的程序</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openqa.selenium.By;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.JavascriptExecutor;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.WebDriver;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.WebElement;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.chrome.ChromeDriver;</span><br><span class="line"><span class="keyword">import</span> org.openqa.selenium.support.ui.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 注意此流程适应于旧版支付宝，新版支付宝页面未测试</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@author</span> Wang Xu 2015/8/29</span><br><span class="line"> * <span class="doctag">@version</span> V1.0.0</span><br><span class="line"> * <span class="doctag">@since</span> V1.0.0</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeleniumAlipay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> WebDriver driver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    定义自己的休眠方法，精简代码量</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    登录操作，负责将界面跳转到交易记录界面</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//        启动火狐浏览器</span></span><br><span class="line"><span class="comment">//        System.setProperty("webdriver.firefox.bin", "C:/Program Files (x86)/Mozilla Firefox/firefox.exe");</span></span><br><span class="line"><span class="comment">//        WebDriver driver = new FirefoxDriver();</span></span><br><span class="line"><span class="comment">//        启动Chrome浏览器</span></span><br><span class="line">        System.setProperty(<span class="string">"webdriver.chrome.driver"</span>, <span class="string">"D:/chromedriver.exe"</span>);</span><br><span class="line">        driver = <span class="keyword">new</span> ChromeDriver();</span><br><span class="line"><span class="comment">//        获取登录页面</span></span><br><span class="line">        driver.get(<span class="string">"https://auth.alipay.com/login/index.htm?goto=https%3A%2F%2Fwww.alipay.com%2F"</span>);</span><br><span class="line"><span class="comment">//        获取用户名输入框</span></span><br><span class="line">        driver.findElement(By.id(<span class="string">"J-input-user"</span>)).clear();</span><br><span class="line">        driver.findElement(By.id(<span class="string">"J-input-user"</span>)).sendKeys(<span class="string">"支付宝账户"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        休息500ms，否则，速度太快，会将密码内容填充到用户名输入框中</span></span><br><span class="line">        sleep(<span class="number">500</span>);</span><br><span class="line"><span class="comment">//        获取密码输入框</span></span><br><span class="line">        driver.findElement(By.id(<span class="string">"password_rsainput"</span>)).clear();</span><br><span class="line">        driver.findElement(By.id(<span class="string">"password_rsainput"</span>)).sendKeys(<span class="string">"密码"</span>);</span><br><span class="line"><span class="comment">//        休息8秒等待用户输入验证码</span></span><br><span class="line">        sleep(<span class="number">8000</span>);</span><br><span class="line"><span class="comment">//        当前URL 0 ：https://authsu18.alipay.com/login/certCheck.htm?goto=https%3A%2F%2Fwww.alipay.com%2F</span></span><br><span class="line">        System.out.println(<span class="string">"当前URL 0 ："</span> + driver.getCurrentUrl());</span><br><span class="line">        driver.get(<span class="string">"https://www.alipay.com/"</span>);</span><br><span class="line"><span class="comment">//        点击个人用户登录</span></span><br><span class="line">        driver.findElement(By.className(<span class="string">"personal-login"</span>)).click();</span><br><span class="line"><span class="comment">//        当前URL 1 ：https://www.alipay.com/</span></span><br><span class="line">        System.out.println(<span class="string">"当前URL 1 ："</span> + driver.getCurrentUrl());</span><br><span class="line">        sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        WebElement myAlipay = driver.findElement(By.className(<span class="string">"am-button-innerNav,button-myalipay"</span>));</span><br><span class="line">        System.out.println(<span class="string">"myAlipay isSelected ："</span> + myAlipay.isSelected());<span class="comment">//false</span></span><br><span class="line">        System.out.println(<span class="string">"myAlipay isEnabled ："</span> + myAlipay.isEnabled());<span class="comment">//true</span></span><br><span class="line">        System.out.println(<span class="string">"myAlipay isDisplayed ："</span> + myAlipay.isDisplayed());<span class="comment">//true</span></span><br><span class="line"><span class="comment">//        点击进入我的支付宝按钮</span></span><br><span class="line">        driver.findElement(By.className(<span class="string">"am-button-innerNav,button-myalipay"</span>)).click();</span><br><span class="line"><span class="comment">//        当前URL 2 ：https://my.alipay.com/portal/i.htm</span></span><br><span class="line">        System.out.println(<span class="string">"当前URL 2 ："</span> + driver.getCurrentUrl());</span><br><span class="line"><span class="comment">//        boolean selected1 = driver.findElement(By.className("fn-ml10")).isSelected();</span></span><br><span class="line"><span class="comment">//        System.out.println("收支明细是否选中：" + selected1);</span></span><br><span class="line"><span class="comment">//        org.openqa.selenium.NoSuchElementException: no such keyword: Element was not in a form, so could not submit.</span></span><br><span class="line"><span class="comment">//        driver.findElement(By.className("fn-ml10")).submit();//跳转收支明细</span></span><br><span class="line"><span class="comment">//        Exception in thread "main" org.openqa.selenium.WebDriverException: unknown error: Element is not clickable at point</span></span><br><span class="line"><span class="comment">//        driver.findElement(By.xpath("//*[@id=\"J-trend-consume\"]/div/div[1]/div/a[1]")).click();</span></span><br><span class="line"><span class="comment">//        driver.findElement(By.className("fn-ml10")).click();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        无反应，看样子一直不会让你点的了</span></span><br><span class="line"><span class="comment">//        WebDriverWait webDriverWait = new WebDriverWait(driver, 3);</span></span><br><span class="line"><span class="comment">//        webDriverWait.until(ExpectedConditions.elementToBeClickable(By.xpath("//*[@id=\"J-trend-consume\"]/div/div[1]/div/a[1]")));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        跳转到收支明细界面</span></span><br><span class="line"><span class="comment">//        driver.get("https://xlab.alipay.com/consume/record/items.htm");</span></span><br><span class="line">        <span class="comment">//跳转到交易记录界面</span></span><br><span class="line">        driver.get(<span class="string">"https://consumeprod.alipay.com/record/index.htm"</span>);</span><br><span class="line">        String currentUrl = driver.getCurrentUrl();</span><br><span class="line"><span class="comment">//        当前URL 3 ：https://consumeprod.alipay.com/record/advanced.htm</span></span><br><span class="line">        System.out.println(<span class="string">"当前URL 3 ："</span> + currentUrl);</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        login();</span><br><span class="line">        String oppositeUser = getOppositeUser(<span class="string">"20150826110500100010740029003925"</span>);</span><br><span class="line">        System.out.println(<span class="string">"交易方对方信息："</span> + oppositeUser);</span><br><span class="line">        oppositeUser = getOppositeUser(<span class="string">"20150720110500100010740025980311"</span>);</span><br><span class="line">        System.out.println(<span class="string">"交易方对方信息："</span> + oppositeUser);</span><br><span class="line">        oppositeUser = getOppositeUser(<span class="string">"2015081521001004740064396260"</span>);</span><br><span class="line">        System.out.println(<span class="string">"交易方对方信息："</span> + oppositeUser);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    获取交易对方信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getOppositeUser</span><span class="params">(String transactionNo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取关键字对应的下拉框</span></span><br><span class="line">        WebElement keywordInput = driver.findElement(By.id(<span class="string">"J-keyword"</span>));</span><br><span class="line">        keywordInput.clear();</span><br><span class="line">        keywordInput.sendKeys(transactionNo);</span><br><span class="line"></span><br><span class="line">        WebElement keywordSelect = driver.findElement(By.id(<span class="string">"keyword"</span>));</span><br><span class="line">        List&lt;WebElement&gt; options = keywordSelect.findElements(By.tagName(<span class="string">"option"</span>));</span><br><span class="line">        <span class="comment">//until方法表示直到可点再点</span></span><br><span class="line"><span class="comment">//        WebElement selectElement = wait.until(ExpectedConditions</span></span><br><span class="line"><span class="comment">//                .visibilityOfElementLocated(By.id("keyword")));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        需要执行JavaScript语句，所以强转driver</span></span><br><span class="line">        JavascriptExecutor js = (JavascriptExecutor) driver;</span><br><span class="line"><span class="comment">//        也可以这么用setAttribute("style","");</span></span><br><span class="line">        js.executeScript(<span class="string">"document.getElementById('keyword').style.display='list-item';"</span>);</span><br><span class="line">        js.executeScript(<span class="string">"document.getElementById('keyword').removeAttribute('smartracker');"</span>);</span><br><span class="line">        js.executeScript(<span class="string">"document.getElementById('keyword').options[1].selected = true;"</span>);</span><br><span class="line">        js.executeScript(<span class="string">"document.getElementById('J-select-range').style.display='list-item';"</span>);</span><br><span class="line"><span class="comment">//        设置交易时间选项</span></span><br><span class="line">        Select selectTime = <span class="keyword">new</span> Select(driver.findElement(By.id(<span class="string">"J-select-range"</span>)));</span><br><span class="line">        selectTime.selectByIndex(<span class="number">3</span>);<span class="comment">//选中的是最近三个月</span></span><br><span class="line">        System.out.println(<span class="string">"selectTime.isMultiple() : "</span> + selectTime.isMultiple());</span><br><span class="line"><span class="comment">//        设置关键字选项</span></span><br><span class="line">        Select selectKeyword = <span class="keyword">new</span> Select(driver.findElement(By.id(<span class="string">"keyword"</span>)));</span><br><span class="line">        <span class="comment">//        selectKeyword.selectByValue("bizInNo");//此处的value填写&lt;option&gt;标签中的value值</span></span><br><span class="line">        selectKeyword.selectByIndex(<span class="number">1</span>);<span class="comment">//选中的是交易号</span></span><br><span class="line">        System.out.println(<span class="string">"selectKeyword.isMultiple() : "</span> + selectKeyword.isMultiple());</span><br><span class="line"></span><br><span class="line">        WebElement queryButton = driver.findElement(By.id(<span class="string">"J-set-query-form"</span>));<span class="comment">//拿到搜索按钮</span></span><br><span class="line"><span class="comment">//        点击搜索按钮</span></span><br><span class="line">        queryButton.submit();</span><br><span class="line"></span><br><span class="line">        WebElement tr = driver.findElement(By.id(<span class="string">"J-item-1"</span>));<span class="comment">//先获取tr</span></span><br><span class="line">        WebElement td = tr.findElement(By.xpath(<span class="string">"//*[@id=\"J-item-1\"]/td[5]/p[1]"</span>));</span><br><span class="line">        <span class="keyword">return</span> td.getText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="效果图">效果图</h3><p><img src="http://7xig3q.com1.z0.glb.clouddn.com/automatic-query-alipay-treasure-transaction-information.gif" alt=""></p>
<p>参考资料<br>【1】<a href="http://baike.baidu.com/subview/478050/6464537.htm" target="_blank" rel="external">http://baike.baidu.com/subview/478050/6464537.htm</a><br>【2】<a href="http://blog.csdn.net/wanglha/article/details/39755613" target="_blank" rel="external">http://blog.csdn.net/wanglha/article/details/39755613</a><br>【3】<a href="http://webdriver.blog.51cto.com/10517592/1673920" target="_blank" rel="external">http://webdriver.blog.51cto.com/10517592/1673920</a><br>【4】<a href="http://blog.csdn.net/pf20050904/article/details/20052485" target="_blank" rel="external">http://blog.csdn.net/pf20050904/article/details/20052485</a><br>【5】<a href="http://www.open-open.com/doc/view/9f52277e5d9c4dd3b851ae54011e733a" target="_blank" rel="external">http://www.open-open.com/doc/view/9f52277e5d9c4dd3b851ae54011e733a</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/08/04/Based-on-the-extended-version-of-synonyms-Cilin-word-similarity-computing/" itemprop="url">
                  基于同义词词林扩展版的词语相似度计算
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-08-04T22:06:36+08:00" content="2015-08-04">
              2015-08-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithms</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/08/04/Based-on-the-extended-version-of-synonyms-Cilin-word-similarity-computing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/08/04/Based-on-the-extended-version-of-synonyms-Cilin-word-similarity-computing/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="词语相似度计算">词语相似度计算</h4><p>词义相似度计算在很多领域中都有广泛的应用，例如信息检索、信息抽取、文本分类、词义排歧、基于实例的机器翻译等等。国内目前主要是使用知网和同义词词林来进行词语的相似度计算。</p>
<p>本文主要是根据《基于同义词词林的词语相似度计算方法—田久乐》论文中所提出的分层算法实现相似度计算，程序采用Java语言编写。</p>
<h4 id="同义词词林扩展版">同义词词林扩展版</h4><p>《同义词词林》是梅家驹等人于1983年编纂而成，这本词典中不仅包括了一个词语的同义词，也包含了一定数量的同类词，即广义的相关词。《同义词词林扩展版》是由哈尔滨工业大学信息检索实验室所重新修订所得。该版收录词语近7万条，全部按意义进行编排，是一部同义类词典。</p>
<p>同义词词林按照树状的层次结构把所有收录的词条组织到一起，把词汇分成大、中、小三类，大类有12个，中类有97个，小类有1400个。每个小类里都有很多的词，这些词又根据词义的远近和相关性分成了若干个词群（段落）。每个段落中的词语又进一步分成了若干个行，同一行的词语要么词义相同，要么词义有很强的相关性。</p>
<p>《同义词词林》提供了5层编码，第1级用大写英文字母表示；第2级用小写英文字母表示；第3级用二位十进制整数表示；第4级用大写英文字母表示；第5级用二位十进制整数表示。例如：<br>Cb30A01= 这里 这边 此地 此间 此处 此<br>Cb30A02# 该地 该镇 该乡 该站 该区 该市 该村<br>Cb30A03@ 这方</p>
<p>分层及编码表如下所示<br><img src="http://7xig3q.com1.z0.glb.clouddn.com/tongyici-cilin-structure.jpg" alt=""><br><img src="http://7xig3q.com1.z0.glb.clouddn.com/tongyici-cilin-encode.jpg" alt=""></p>
<p>由于第5级有的行是同义词，有的行是相关词，有的行只有一个词，分类结果需要特别说明，可以分出具体的3种情况。使用特殊符号对这3种情况进行区别对待，所以第8位的标记有3种，分别是“=”代表“相等”、“同义”；“#”代表“不等”、“同类”，属于相关词语；“@”代表“自我封闭”、“独立”，它在词典中既没有同义词，也没有相关词。</p>
<p>在对文本内容进行相似度计算中，采用该论文中给出的计算公式，两个义项的相似度用<code>Sim</code>表示<br>若两个义项不在同一棵树上，<code>Sim(A,B)=f</code><br>若两个义项在同一棵树上：<br>若在第2层分支，系数为a <code>Sim(A,B)=1*a*cos*(n*π/180)((n-k+1)/n)</code><br>若在第3层分支，系数为b <code>Sim(A,B)=1*1*b*cos*(n*π/180)((n-k+1)/n)</code><br>若在第4层分支，系数为c <code>Sim(A,B)=1*1*1*c×cos*(n*π/180)((n-k+1)/n)</code><br>若在第5层分支，系数为d <code>Sim(A,B)=1*1*1*1*d*cos*(n*π/180)((n-k+1)/n)</code></p>
<p>当编码相同，而只有末尾是“#”时，那么认为其相似度为e。<br>例如<code>Ad02B04# 非洲人 亚洲人</code>  则其相似度为e。</p>
<p>其中n是分支层的节点分支总数，k是两个分支间的距离。<br>如：人 <code>Aa01A01=</code> 和 少儿 <code>Ab04B01=</code><br>以A开头的子分支只有14个，分别是<code>Aa...，Ab...，Ac... ——— An...</code>，而不是以A开头的所有结点的个数，所以<code>n=14</code>；在第2层分支上，人的编码是<code>a</code>，少儿的编码是<code>b</code>，a和b之间差1，所以<code>k=1</code>。</p>
<p>该文献中给出的参数值为<code>a=0.65</code>，<code>b=0.8</code>，<code>c=0.9</code>，<code>d=0.96</code>，<code>e=0.5</code>，<code>f=0.1</code>。</p>
<h4 id="Java代码实现">Java代码实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.codepub.algorithms.similarity.cilin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.base.Preconditions;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Math.PI;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Math.cos;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Created with IntelliJ IDEA. 2015/8/2 21:54</span><br><span class="line"> * &lt;/p&gt;</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * ClassName:WordSimilarity 同义词词林扩展版计算词语相似度</span><br><span class="line"> * &lt;/p&gt;</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Description:&lt;br/&gt;</span><br><span class="line"> * "=" 代表 相等 同义 &lt;br/&gt;</span><br><span class="line"> * "#" 代表 不等 同类 属于相关词语 &lt;br/&gt;</span><br><span class="line"> * "@" 代表 自我封闭 独立 它在词典中既没有同义词, 也没有相关词 &lt;br/&gt;</span><br><span class="line"> * &lt;/P&gt;</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@author</span> Wang Xu</span><br><span class="line"> * <span class="doctag">@version</span> V1.0.0</span><br><span class="line"> * <span class="doctag">@since</span> V1.0.0</span><br><span class="line"> */</span></span><br><span class="line"><span class="annotation">@Log</span>4j2</span><br><span class="line"><span class="comment">//注意使用Log4j2的注解，那么在pom中必须引入2.x版本的log4j，如果使用Log4j注解，pom中引入1.x版本的log4j</span></span><br><span class="line"><span class="comment">//相应的配置文件也要一致，2.x版本配置文件为log4j2.xml，1.x版本配置文件为log4j.xml</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordSimilarity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * when we use Lombok's Annotation, such as <span class="doctag">@Log</span>4j</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@Log</span>4j &lt;br/&gt;</span><br><span class="line">     * public class LogExample &#123;</span><br><span class="line">     * &#125;</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * will generate:</span><br><span class="line">     * public class LogExample &#123;</span><br><span class="line">     * private static final org.apache.logging.log4j.Logger log = org.apache.logging.log4j.Logger.getLogger(LogExample.class);</span><br><span class="line">     * &#125;</span><br><span class="line">     * &lt;/p&gt;</span><br><span class="line">     */</span></span><br><span class="line">    <span class="comment">//定义一些常数先</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> a = <span class="number">0.65</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> b = <span class="number">0.8</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> c = <span class="number">0.9</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> d = <span class="number">0.96</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> e = <span class="number">0.5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> f = <span class="number">0.1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">double</span> degrees = <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放的是以词为key，以该词的编码为values的List集合，其中一个词可能会有多个编码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, ArrayList&lt;String&gt;&gt; wordsEncode = <span class="keyword">new</span> HashMap&lt;String, ArrayList&lt;String&gt;&gt;();</span><br><span class="line">    <span class="comment">//存放的是以编码为key，以该编码多对应的词为values的List集合，其中一个编码可能会有多个词</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, ArrayList&lt;String&gt;&gt; encodeWords = <span class="keyword">new</span> HashMap&lt;String, ArrayList&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 读取同义词词林并将其注入wordsEncode和encodeWords</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readCiLin</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        InputStream input = WordSimilarity.class.getClass().getResourceAsStream(<span class="string">"/cilin.txt"</span>);</span><br><span class="line">        List&lt;String&gt; contents = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            contents = IOUtils.readLines(input);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String content : contents) &#123;</span><br><span class="line">                content = Preconditions.checkNotNull(content);</span><br><span class="line">                String[] strsArr = content.split(<span class="string">" "</span>);</span><br><span class="line">                String[] strs = Preconditions.checkNotNull(strsArr);</span><br><span class="line">                String encode = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">int</span> length = strs.length;</span><br><span class="line">                <span class="keyword">if</span> (length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    encode = strs[<span class="number">0</span>];<span class="comment">//获取编码</span></span><br><span class="line">                &#125;</span><br><span class="line">                ArrayList&lt;String&gt; encodeWords_values = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; length; i++) &#123;</span><br><span class="line">                    encodeWords_values.add(strs[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                encodeWords.put(encode, encodeWords_values);<span class="comment">//以编码为key，其后所有值为value</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; length; i++) &#123;</span><br><span class="line">                    String key = strs[i];</span><br><span class="line">                    <span class="keyword">if</span> (wordsEncode.containsKey(strs[i])) &#123;</span><br><span class="line">                        ArrayList&lt;String&gt; values = wordsEncode.get(key);</span><br><span class="line">                        values.add(encode);</span><br><span class="line">                        <span class="comment">//重新放置回去</span></span><br><span class="line">                        wordsEncode.put(key, values);<span class="comment">//以某个value为key，其可能的所有编码为value</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        ArrayList&lt;String&gt; temp = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                        temp.add(encode);</span><br><span class="line">                        wordsEncode.put(key, temp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.err.println(<span class="string">"load dictionary failed！"</span>);</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 对外暴露的接口，返回两个词的相似度的计算结果</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> word1</span><br><span class="line">     * <span class="doctag">@param</span> word2</span><br><span class="line">     * <span class="doctag">@return</span> 相似度值</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">getSimilarity</span><span class="params">(String word1, String word2)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//在计算时候再加载，实现懒加载</span></span><br><span class="line">        readCiLin();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果比较词没有出现在同义词词林中，则相似度为0</span></span><br><span class="line">        <span class="keyword">if</span> (!wordsEncode.containsKey(word1) || !wordsEncode.containsKey(word2)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取第一个词的编码</span></span><br><span class="line">        ArrayList&lt;String&gt; encode1 = getEncode(word1);</span><br><span class="line">        <span class="comment">//获取第二个词的编码</span></span><br><span class="line">        ArrayList&lt;String&gt; encode2 = getEncode(word2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> maxValue = <span class="number">0</span>;<span class="comment">//最终的计算结果值，取所有相似度里面结果最大的那个</span></span><br><span class="line">        <span class="keyword">for</span> (String e1 : encode1) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String e2 : encode2) &#123;</span><br><span class="line">                log.info(e1);</span><br><span class="line">                log.info(e2);</span><br><span class="line">                String commonStr = getCommonStr(e1, e2);</span><br><span class="line">                <span class="keyword">int</span> length = StringUtils.length(commonStr);</span><br><span class="line">                <span class="keyword">double</span> k = getK(e1, e2);</span><br><span class="line">                <span class="keyword">double</span> n = getN(commonStr);</span><br><span class="line">                log.info(<span class="string">"k--&gt;"</span> + k);</span><br><span class="line">                log.info(<span class="string">"n--&gt;"</span> + n);</span><br><span class="line">                log.info(<span class="string">"encode length--&gt;"</span> + length);</span><br><span class="line">                <span class="keyword">double</span> res = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">//如果有一个以“@”那么表示自我封闭，肯定不在一棵树上，直接返回f</span></span><br><span class="line">                <span class="keyword">if</span> (e1.endsWith(<span class="string">"@"</span>) || e2.endsWith(<span class="string">"@"</span>) || <span class="number">0</span> == length) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (f &gt; maxValue) &#123;</span><br><span class="line">                        maxValue = f;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">1</span> == length) &#123;</span><br><span class="line">                    <span class="comment">//说明在第二层上计算</span></span><br><span class="line">                    res = a * cos(n * PI / degrees) * ((n - k + <span class="number">1</span>) / n);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">2</span> == length) &#123;</span><br><span class="line">                    <span class="comment">//说明在第三层上计算</span></span><br><span class="line">                    res = b * cos(n * PI / degrees) * ((n - k + <span class="number">1</span>) / n);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">4</span> == length) &#123;</span><br><span class="line">                    <span class="comment">//说明在第四层上计算</span></span><br><span class="line">                    res = c * cos(n * PI / degrees) * ((n - k + <span class="number">1</span>) / n);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">5</span> == length) &#123;</span><br><span class="line">                    <span class="comment">//说明在第五层上计算</span></span><br><span class="line">                    res = d * cos(n * PI / degrees) * ((n - k + <span class="number">1</span>) / n);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//注意不存在前面七个字符相同，而结尾不同的情况，所以这个分支一定是8个字符都相同，那么只需比较结尾即可</span></span><br><span class="line">                    <span class="keyword">if</span> (e1.endsWith(<span class="string">"="</span>) &amp;&amp; e2.endsWith(<span class="string">"="</span>)) &#123;</span><br><span class="line">                        <span class="comment">//说明两个完全相同</span></span><br><span class="line">                        res = <span class="number">1</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e1.endsWith(<span class="string">"#"</span>) &amp;&amp; e2.endsWith(<span class="string">"#"</span>)) &#123;</span><br><span class="line">                        <span class="comment">//只有结尾不同，说明结尾是“#”</span></span><br><span class="line">                        res = e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"res: "</span> + res);</span><br><span class="line">                <span class="keyword">if</span> (res &gt; maxValue) &#123;</span><br><span class="line">                    maxValue = res;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 判断一个词在同义词词林中是否是自我封闭的，是否是独立的</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> source</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIndependent</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;String&gt; iter = wordsEncode.keySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            String key = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(key, source)) &#123;</span><br><span class="line">                ArrayList&lt;String&gt; values = wordsEncode.get(key);</span><br><span class="line">                <span class="keyword">for</span> (String value : values) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (value.endsWith(<span class="string">"@"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 根据word的内容，返回其对应的编码</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> word</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title">getEncode</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wordsEncode.get(word);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 计算N的值，N表示所在分支层分支数，如：人 Aa01A01= 和 少儿 Ab04B01=，以A开头的子分支只有14个</span><br><span class="line">     * 这一点在论文中说的非常不清晰，所以以国人的文章进行编码真是痛苦</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> encodeHead 输入两个字符串的公共开头</span><br><span class="line">     * <span class="doctag">@return</span> 经过计算之后得到N的值</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getN</span><span class="params">(String encodeHead)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = StringUtils.length(encodeHead);</span><br><span class="line">        <span class="keyword">switch</span> (length) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> getCount(encodeHead, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> getCount(encodeHead, <span class="number">4</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">return</span> getCount(encodeHead, <span class="number">5</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="keyword">return</span> getCount(encodeHead, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">(String encodeHead, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; res = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">        Iterator&lt;String&gt; iter = encodeWords.keySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            String curr = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (curr.startsWith(encodeHead)) &#123;</span><br><span class="line">                String temp = curr.substring(<span class="number">0</span>, end);</span><br><span class="line">                <span class="keyword">if</span> (res.contains(temp)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    res.add(temp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * <span class="doctag">@param</span> encode1 第一个编码</span><br><span class="line">     * <span class="doctag">@param</span> encode2 第二个编码</span><br><span class="line">     * <span class="doctag">@return</span> 这两个编码对应的分支间的距离，用k表示</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getK</span><span class="params">(String encode1, String encode2)</span> </span>&#123;</span><br><span class="line">        String temp1 = encode1.substring(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        String temp2 = encode2.substring(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(temp1, temp2)) &#123;</span><br><span class="line">            temp1 = encode1.substring(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">            temp2 = encode2.substring(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Math.abs(temp1.charAt(<span class="number">0</span>) - temp2.charAt(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(temp1, temp2)) &#123;</span><br><span class="line">            temp1 = encode1.substring(<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">            temp2 = encode2.substring(<span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Math.abs(temp1.charAt(<span class="number">0</span>) - temp2.charAt(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(temp1, temp2)) &#123;</span><br><span class="line">            temp1 = encode1.substring(<span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">            temp2 = encode2.substring(<span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Math.abs(Integer.valueOf(temp1) - Integer.valueOf(temp2));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(temp1, temp2)) &#123;</span><br><span class="line">            temp1 = encode1.substring(<span class="number">5</span>, <span class="number">7</span>);</span><br><span class="line">            temp2 = encode2.substring(<span class="number">5</span>, <span class="number">7</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Math.abs(temp1.charAt(<span class="number">0</span>) - temp2.charAt(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(Integer.valueOf(temp1) - Integer.valueOf(temp2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 获取编码的公共部分字符串</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> encode1</span><br><span class="line">     * <span class="doctag">@param</span> encode2</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> String <span class="title">getCommonStr</span><span class="params">(String encode1, String encode2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = StringUtils.length(encode1);</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (encode1.charAt(i) == encode2.charAt(i)) &#123;</span><br><span class="line">                sb.append(encode1.charAt(i));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> sbLen = StringUtils.length(sb);</span><br><span class="line">        <span class="comment">//注意第三层和第五层均有两个字符，所以长度不可能出现3和6的情况</span></span><br><span class="line">        <span class="keyword">if</span> (sbLen == <span class="number">3</span> || sbLen == <span class="number">6</span>) &#123;</span><br><span class="line">            sb.deleteCharAt(sbLen - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> String.valueOf(sb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetN</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readCiLin();</span><br><span class="line">        <span class="keyword">int</span> a = getN(<span class="string">"A"</span>);</span><br><span class="line">        System.out.println(a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> k = getK(<span class="string">"Aa01A01="</span>, <span class="string">"Aa01A01="</span>);</span><br><span class="line">        System.out.println(k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetCommonStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String commonStr = getCommonStr(<span class="string">"Aa01A01="</span>, <span class="string">"Aa01A03="</span>);</span><br><span class="line">        System.out.println(commonStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetSimilarity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readCiLin();</span><br><span class="line">        <span class="keyword">double</span> similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"国民"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"国民:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"群众"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"群众:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"党群"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"党群:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"良民"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"良民:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"同志"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"同志:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"成年人"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"成年人:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"市民"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"市民:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"亲属"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"亲属:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"志愿者"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"志愿者:"</span> + similarity);</span><br><span class="line">        similarity = getSimilarity(<span class="string">"人民"</span>, <span class="string">"先锋"</span>);</span><br><span class="line">        System.out.println(<span class="string">"人民--"</span> + <span class="string">"先锋:"</span> + similarity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetSimilarity2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readCiLin();</span><br><span class="line">        <span class="keyword">double</span> similarity = getSimilarity(<span class="string">"非洲人"</span>, <span class="string">"亚洲人"</span>);</span><br><span class="line">        System.out.println(similarity);</span><br><span class="line">        <span class="keyword">double</span> similarity1 = getSimilarity(<span class="string">"骄傲"</span>, <span class="string">"仔细"</span>);</span><br><span class="line">        System.out.println(similarity1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明，词语相似度是个数值，一般取值范围在[0，1]之间，在原论文中，使用cos函数计算主要是将值归一化到[0，1]之间，可以将cos函数看作是一个调节因子。</p>
<p>testGetSimilarity的测试结果如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">人民--国民:<span class="number">1.0</span></span><br><span class="line">人民--群众:<span class="number">0.9576614882494312</span></span><br><span class="line">人民--党群:<span class="number">0.8978076452338418</span></span><br><span class="line">人民--良民:<span class="number">0.7182461161870735</span></span><br><span class="line">人民--同志:<span class="number">0.6630145969121822</span></span><br><span class="line">人民--成年人:<span class="number">0.6306922220793977</span></span><br><span class="line">人民--市民:<span class="number">0.5405933332109123</span></span><br><span class="line">人民--亲属:<span class="number">0.36039555547394153</span></span><br><span class="line">人民--志愿者:<span class="number">0.22524722217121346</span></span><br><span class="line">人民--先锋:<span class="number">0.18019777773697077</span></span><br></pre></td></tr></table></figure>
<p>本文使用的是同义词词林的扩展版，而原论文使用的是同义词词林，由于两者存在微小差距，所以本文计算结果与论文中的计算结果存在稍许误差，如果算法没错，这是可以理解的！</p>
<p>以上仅为个人理解，如若发现错误，欢迎大家积极留言指正！</p>
<p>代码已经推送到GitHub上了，地址<a href="https://github.com/shijiebei2009/Algorithms/blob/master/src%2Fmain%2Fjava%2Fcn%2Fcodepub%2Falgorithms%2Fsimilarity%2Fcilin%2FWordSimilarity.java" target="_blank" rel="external">点我</a>。注意在文章末尾所注的参考资料中的链接里面的计算方法在求n的时候存在错误，希望莫要受其误导！</p>
<p>参考资料：<br>【1】<a href="http://www.cnblogs.com/einyboy/archive/2012/09/09/2677265.html" target="_blank" rel="external">http://www.cnblogs.com/einyboy/archive/2012/09/09/2677265.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/30/Lombok-development-guidelines/" itemprop="url">
                  Lombok开发指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-30T21:33:11+08:00" content="2015-07-30">
              2015-07-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/30/Lombok-development-guidelines/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/30/Lombok-development-guidelines/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Lombok简介">Lombok简介</h3><p><code>Lombok</code>是一款好用顺手的工具，就像Google Guava一样，在此予以强烈推荐，从此Java开发就离不开它了。Lombok是一种Java™实用工具，可用来帮助开发人员消除Java的冗长，尤其是对于简单的Java对象（POJO）。它通过注释实现这一目的。通过在开发环境中实现Lombok，开发人员可以节省构建诸如<code>hashCode()</code>和<code>equals()</code>这样的方法以及以往用来分类各种<code>accessor</code>和<code>mutator</code>的大量时间。</p>
<p>Lombok官网地址：<a href="https://projectlombok.org/" target="_blank" rel="external">https://projectlombok.org/</a> 里面还提供了一个简短的学习视频。</p>
<h3 id="eclipse中安装Lombok">eclipse中安装Lombok</h3><h4 id="下载lombok">下载lombok</h4><p>下载地址：<a href="http://projectlombok.org/download.html" target="_blank" rel="external">http://projectlombok.org/download.html</a></p>
<h4 id="安装">安装</h4><p><img src="http://7xig3q.com1.z0.glb.clouddn.com/eclipse-lombok.png" alt=""><br>注意如果eclipse没有安装到默认目录，那么需要点击Specify选择eclipse的安装文件，然后Install即可完成安装。</p>
<p>在新建项目之后，使用Lombok如果程序还报错，那么点击eclipse菜单的Project选项的clean，清理一下。</p>
<h3 id="IntelliJ安装Lombok">IntelliJ安装Lombok</h3><h4 id="通过IntelliJ的插件中心安装">通过IntelliJ的插件中心安装</h4><p><img src="http://7xig3q.com1.z0.glb.clouddn.com/IntelliJ-plugin-lombok.png" alt=""><br><img src="http://7xig3q.com1.z0.glb.clouddn.com/IntelliJ-lombok.png" alt=""><br>注意一点，在IntelliJ中如果创建的是Maven项目，那么在pom.xml文件中添加依赖后，需要设置Maven为自动导入。<br><img src="http://7xig3q.com1.z0.glb.clouddn.com/IntelliJ-maven-auto-import.png" alt=""></p>
<h4 id="通过Jar包安装">通过Jar包安装</h4><p>该地址提供了最新的<a href="https://github.com/mplushnikov/lombok-intellij-plugin/releases/tag/releasebuild_0.9.6" target="_blank" rel="external">Jar包下载</a></p>
<p>安装方法参见Github上的说明：<a href="https://github.com/mplushnikov/lombok-intellij-plugin" target="_blank" rel="external">https://github.com/mplushnikov/lombok-intellij-plugin</a></p>
<h3 id="使用Lombok">使用Lombok</h3><h4 id="Lombok注解说明">Lombok注解说明</h4><ul>
<li><code>@Data</code>：注解在类上，相当于同时使用了<code>@ToString</code>、<code>@EqualsAndHashCode</code>、<code>@Getter</code>、<code>@Setter</code>和<code>@RequiredArgsConstrutor</code>这些注解，对于<code>Pojo类</code>十分有用</li>
<li><code>@NonNull</code>：给方法参数增加这个注解会自动在方法内对该参数进行是否为空的校验，如果为空，则抛出NPE</li>
<li><code>@CleanUp</code>：自动生成try-finally这样的代码来关闭流</li>
<li><code>@Getter(lazy=true)</code>：可以替代经典的Double Check Lock样板代码</li>
<li><code>@Setter</code>：注解在属性上；为属性提供 setting 方法</li>
<li><code>@Getter</code>：注解在属性上；为属性提供 getting 方法</li>
<li><code>@Log4j</code>：注解在类上；为类提供一个 属性名为log 的 log4j 日志对象</li>
<li><code>@NoArgsConstructor</code>：注解在类上；为类提供一个无参的构造方法</li>
<li><code>@AllArgsConstructor</code>：注解在类上；为类提供一个全参的构造方法</li>
</ul>
<h4 id="示例">示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="annotation">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Menu</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String shopId;</span><br><span class="line">    <span class="keyword">private</span> String skuMenuId;</span><br><span class="line">    <span class="keyword">private</span> String skuName;</span><br><span class="line">    <span class="keyword">private</span> String normalizeSkuName;</span><br><span class="line">    <span class="keyword">private</span> String dishMenuId;</span><br><span class="line">    <span class="keyword">private</span> String dishName;</span><br><span class="line">    <span class="keyword">private</span> String dishNum;</span><br><span class="line">    <span class="comment">//默认阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> thresHold = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//新阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> newThresHold = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//总得分</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> totalScore = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在IntelliJ中按下Ctrl+F12就可以看到Lombok已经为我们自动生成了一系列的方法。<br><img src="http://7xig3q.com1.z0.glb.clouddn.com/IntelliJ-lombok-java-demo.jpg" alt=""></p>
<p>当然了，还可以分别使用@Getter和@Setter注解，例如<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"><span class="annotation">@ToString</span></span><br><span class="line"><span class="annotation">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Menu</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Setter</span></span><br><span class="line">    <span class="annotation">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String shopId;</span><br><span class="line">    <span class="keyword">private</span> String skuMenuId;</span><br><span class="line">    <span class="keyword">private</span> String skuName;</span><br><span class="line">    <span class="keyword">private</span> String normalizeSkuName;</span><br><span class="line">    <span class="keyword">private</span> String dishMenuId;</span><br><span class="line">    <span class="keyword">private</span> String dishName;</span><br><span class="line">    <span class="keyword">private</span> String dishNum;</span><br><span class="line">    <span class="comment">//默认阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> thresHold = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//新阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> newThresHold = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//总得分</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> totalScore = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(@NonNull String test)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="eclipse手动安装Lombok">eclipse手动安装Lombok</h3><ul>
<li>将<code>lombok.jar</code>复制到<code>myeclipse.ini/eclipse.ini</code>所在的文件夹目录下</li>
<li>打开<code>eclipse.ini/myeclipse.ini</code>，在最后面插入以下两行并保存：<br><code>-Xbootclasspath/a:lombok.jar</code><br><code>-javaagent:lombok.jar</code></li>
<li>重启<code>eclipse/myeclipse</code></li>
</ul>
<p>最后需要注意的是，在使用<code>lombok</code>注解的时候记得要导入<code>lombok.jar</code> 包到工程，如果使用的是<code>Maven Project</code>，要在<code>pom.xml</code>中添加依赖，并设置<code>Maven</code>为自动导入，参见上图。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/13/Python3-beginner-s-handbook-four/" itemprop="url">
                  Python3入门手册之四
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-13T23:03:44+08:00" content="2015-07-13">
              2015-07-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/13/Python3-beginner-s-handbook-four/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/13/Python3-beginner-s-handbook-four/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>Version：Python 3.4.3 (v3.4.3:9b73f1c3e601, Feb 24 2015, 22:44:40) [MSC v.1600 64 bit (AMD64)] on win32</em></p>
<h3 id="函数">函数</h3><h4 id="可接受任意数量参数的函数">可接受任意数量参数的函数</h4><p>为了能让一个函数接受任意数量的位置参数，可以使用一个<code>*参数</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">avg</span><span class="params">(first, *rest)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (first + sum(rest)) / (<span class="number">1</span> + len(rest))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sample use</span></span><br><span class="line">avg(<span class="number">1</span>, <span class="number">2</span>) <span class="comment"># 1.5</span></span><br><span class="line">avg(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>) <span class="comment"># 2.5</span></span><br></pre></td></tr></table></figure></p>
<p>在这个例子中，<code>rest</code>是由所有其他位置参数组成的元组。然后我们在代码中把它当成了一个序列来进行后续的计算。</p>
<p>使用一个以<code>**开头的参数</code>来表示接受任意数量的关键字参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> html</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_element</span><span class="params">(name, value, **attrs)</span>:</span></span><br><span class="line">    keyvals = [<span class="string">' %s="%s"'</span> % item <span class="keyword">for</span> item <span class="keyword">in</span> attrs.items()]</span><br><span class="line">    attr_str = <span class="string">''</span>.join(keyvals)</span><br><span class="line">    element = <span class="string">'&lt;&#123;name&#125;&#123;attrs&#125;&gt;&#123;value&#125;&lt;/&#123;name&#125;&gt;'</span>.format(</span><br><span class="line">        name=name,</span><br><span class="line">        attrs=attr_str,</span><br><span class="line">        value=html.escape(value))</span><br><span class="line">    <span class="keyword">return</span> element</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="comment"># Creates '&lt;item size="large" quantity="6"&gt;Albatross&lt;/item&gt;'</span></span><br><span class="line">res = make_element(<span class="string">'item'</span>, <span class="string">'Albatross'</span>, size=<span class="string">'large'</span>, quantity=<span class="number">6</span>)</span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Creates '&lt;p&gt;&lt;spam&gt;&lt;/p&gt;'</span></span><br><span class="line">res = make_element(<span class="string">'p'</span>, <span class="string">'&lt;spam&gt;'</span>)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure></p>
<p>在这里，<code>attrs</code>是一个包含所有被传入进来的关键字参数的字典。</p>
<p>如果你还希望某个函数能同时接受任意数量的位置参数和关键字参数，可以同时使用<code>*和**</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">anyargs</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    print(args)  <span class="comment"># A tuple  Prints ('a', 'b', 'c', 'd', 'e')</span></span><br><span class="line">    print(kwargs)  <span class="comment"># A dict  Prints&#123;'key1': '1', 'key2': '2'&#125;</span></span><br><span class="line">anyargs(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, key1=<span class="string">'1'</span>, key2=<span class="string">'2'</span>)</span><br></pre></td></tr></table></figure></p>
<p>使用这个函数时，所有位置参数会被放到<code>args元组</code>中，所有关键字参数会被放到<code>字典kwargs</code>中。<br>一个<code>*参数</code>只能出现在函数定义中最后一个位置参数后面，而 <code>**参数</code>只能出现在最后一个参数。 有一点要注意的是，在<code>*参数</code>后面仍然可以定义其他参数。</p>
<h4 id="只接受关键字参数的函数">只接受关键字参数的函数</h4><p>利用这种技术，我们还能在接受任意多个位置参数的函数中指定关键字参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mininum</span><span class="params">(*values, clip=None)</span>:</span></span><br><span class="line">    m = min(values)</span><br><span class="line">    <span class="keyword">if</span> clip <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        m = clip <span class="keyword">if</span> clip &gt; m <span class="keyword">else</span> m</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line">minimum(<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, -<span class="number">5</span>, <span class="number">10</span>) <span class="comment"># Returns -5</span></span><br><span class="line">minimum(<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, -<span class="number">5</span>, <span class="number">10</span>, clip=<span class="number">0</span>) <span class="comment"># Returns 0&lt;/pre&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="返回多个值的函数">返回多个值的函数</h4><p>为了能返回多个值，函数直接return一个元组就行了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">myfun</span><span class="params">()</span>:</span></span><br><span class="line"><span class="prompt">... </span><span class="keyword">return</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a, b, c = myfun()</span><br><span class="line">`</span><br></pre></td></tr></table></figure></p>
<p>尽管<code>myfun()</code>看上去返回了多个值，实际上是先创建了一个元组然后返回的。这个语法看上去比较奇怪，实际上我们使用的是逗号来生成一个元组，而不是用括号。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = (<span class="number">1</span>, <span class="number">2</span>) <span class="comment"># With parentheses</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = <span class="number">1</span>, <span class="number">2</span> <span class="comment"># Without parentheses</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b</span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="定义有默认参数的函数">定义有默认参数的函数</h4><p>定义一个有可选参数的函数是非常简单的，直接在函数定义中给参数指定一个默认值，并放到参数列表最后就行了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b=<span class="number">42</span>)</span>:</span></span><br><span class="line">    print(a, b)</span><br><span class="line"></span><br><span class="line">spam(<span class="number">1</span>) <span class="comment"># Ok. a=1, b=42</span></span><br><span class="line">spam(<span class="number">1</span>, <span class="number">2</span>) <span class="comment"># Ok. a=1, b=2</span></span><br></pre></td></tr></table></figure></p>
<p>如果默认参数是一个可修改的容器比如一个列表、集合或者字典，可以使用None作为默认值<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Using a list as a default value</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> b <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        b = []</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>有一点是值得注意的，默认参数的值仅仅在函数定义的时候赋值一次<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = <span class="number">42</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b=x)</span>:</span></span><br><span class="line"><span class="prompt">... </span>    print(a, b)</span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>spam(<span class="number">1</span>)</span><br><span class="line"><span class="number">1</span> <span class="number">42</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = <span class="number">23</span> <span class="comment"># Has no effect</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>spam(<span class="number">1</span>)</span><br><span class="line"><span class="number">1</span> <span class="number">42</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>注意到当我们改变<code>x</code>的值的时候对默认参数值并没有影响，这是因为在函数定义的时候就已经确定了它的默认值了。</p>
<p>其次，默认参数的值应该是不可变的对象，比如<code>None、True、False、</code>数字或字符串。 特别的，千万不要像下面这样写代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b=[])</span>:</span> <span class="comment"># NO!</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>如果你这么做了，当默认值在其他地方被修改后你将会遇到各种麻烦。这些修改会影响到下次调用这个函数时的默认值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b=[])</span>:</span></span><br><span class="line"><span class="prompt">... </span>    print(b)</span><br><span class="line"><span class="prompt">... </span>    <span class="keyword">return</span> b</span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = spam(<span class="number">1</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x</span><br><span class="line">[]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.append(<span class="number">99</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x.append(<span class="string">'Yow!'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x</span><br><span class="line">[<span class="number">99</span>, <span class="string">'Yow!'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>spam(<span class="number">1</span>) <span class="comment"># Modified list gets returned!</span></span><br><span class="line">[<span class="number">99</span>, <span class="string">'Yow!'</span>]</span><br></pre></td></tr></table></figure></p>
<p>这种结果应该不是你想要的。为了避免这种情况的发生，最好是将默认值设为<code>None</code>， 然后在函数里面检查它，前面的例子就是这样做的。</p>
<p>在测试<code>None</code>值时使用<code>is</code>操作符是很重要的，也是这种方案的关键点。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> b: <span class="comment"># NO! Use 'b is None' instead</span></span><br><span class="line">        b = []</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<h4 id="定义匿名或内联函数">定义匿名或内联函数</h4><p>当一些函数很简单，仅仅只是计算一个表达式的值的时候，就可以使用<code>lambda</code>表达式来代替了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>add = <span class="keyword">lambda</span> x, y: x + y</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>add(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>add(<span class="string">'hello'</span>, <span class="string">'world'</span>)</span><br><span class="line"><span class="string">'helloworld'</span></span><br></pre></td></tr></table></figure></p>
<p><code>lambda</code>表达式典型的使用场景是排序或数据<code>reduce</code>等：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>names = [<span class="string">'David Beazley'</span>, <span class="string">'Brian Jones'</span>,</span><br><span class="line"><span class="prompt">... </span>        <span class="string">'Raymond Hettinger'</span>, <span class="string">'Ned Batchelder'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>sorted(names, key=<span class="keyword">lambda</span> name: name.split()[-<span class="number">1</span>].lower())</span><br><span class="line">[<span class="string">'Ned Batchelder'</span>, <span class="string">'David Beazley'</span>, <span class="string">'Raymond Hettinger'</span>, <span class="string">'Brian Jones'</span>]</span><br></pre></td></tr></table></figure></p>
<p>有一点要注意的是，<code>lambda</code>表达式中的变量x是自由变量，在运行时绑定值，而不是定义时就绑定，这跟函数的默认值参数定义是不同的。而如果你想让某个匿名函数在定义时就捕获到值，可以将那个参数值定义成默认参数即可，类似如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = <span class="number">10</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = <span class="keyword">lambda</span> y, x=x: x + y</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = <span class="number">20</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = <span class="keyword">lambda</span> y, x=x: x + y</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a(<span class="number">10</span>)</span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b(<span class="number">10</span>)</span><br><span class="line"><span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>如果你不设定为默认参数的话，运行如下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = <span class="number">10</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = <span class="keyword">lambda</span> y: x + y</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = <span class="number">20</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = <span class="keyword">lambda</span> y: x + y</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a(<span class="number">10</span>)</span><br><span class="line"><span class="number">30</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b(<span class="number">10</span>)</span><br><span class="line"><span class="number">30</span></span><br></pre></td></tr></table></figure></p>
<p><strong>Notes</strong><br>在这里列出来的问题是新手很容易犯的错误，有些新手可能会不恰当的<code>lambda</code>表达式。 比如，通过在一个循环或列表推导中创建一个<code>lambda</code>表达式列表，并期望函数能在定义时就记住每次的迭代值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>funcs = [<span class="keyword">lambda</span> x: x+n <span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">5</span>)]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> f <span class="keyword">in</span> funcs:</span><br><span class="line"><span class="prompt">... </span>print(f(<span class="number">0</span>))</span><br><span class="line">...</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>但是实际效果是运行是n的值为迭代的最后一个值。现在我们用另一种方式修改一下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>funcs = [<span class="keyword">lambda</span> x, n=n: x+n <span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">5</span>)]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> f <span class="keyword">in</span> funcs:</span><br><span class="line"><span class="prompt">... </span>print(f(<span class="number">0</span>))</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>通过使用函数默认值参数形式，<code>lambda</code>函数在定义时就能绑定到值。</p>
<h4 id="减少可调用对象的参数个数">减少可调用对象的参数个数</h4><p>如果需要减少某个函数的参数个数，你可以使用<code>functools.partial()</code>。<code>partial()</code>允许你给一个或多个参数设置固定的值，减少接下来被调用时的参数个数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a, b, c, d)</span>:</span></span><br><span class="line">    print(a, b, c, d)</span><br><span class="line">spam(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)  <span class="comment"># Prints 1 2 3 4</span></span><br><span class="line">s1 = partial(spam, <span class="number">1</span>)  <span class="comment"># a = 1</span></span><br><span class="line">s1(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>)</span><br><span class="line">s2 = partial(spam, <span class="number">3</span>, <span class="number">4</span>, d=<span class="number">12</span>)  <span class="comment"># a=3,b=4,d=12</span></span><br><span class="line">s2(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>可以看出<code>partial()</code>固定某些参数并返回一个新的<code>callable</code>对象。这个新的<code>callable</code>接受未赋值的参数，然后跟之前已经赋值过的参数合并起来，最后将所有参数传递给原始函数。</p>
<p>假设你有一个点的列表来表示<code>(x,y)</code>坐标元组。你可以使用下面的函数来计算两点之间的距离：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">points = [ (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">3</span>, <span class="number">4</span>), (<span class="number">5</span>, <span class="number">6</span>), (<span class="number">7</span>, <span class="number">8</span>) ]</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distance</span><span class="params">(p1, p2)</span>:</span></span><br><span class="line">    x1, y1 = p1</span><br><span class="line">    x2, y2 = p2</span><br><span class="line">    <span class="keyword">return</span> math.hypot(x2 - x1, y2 - y1)</span><br></pre></td></tr></table></figure></p>
<p>现在假设你想以某个点为基点，根据点和基点之间的距离来排序所有的这些点。列表的<code>sort()</code>方法接受一个关键字参数来自定义排序逻辑，但是它只能接受一个单个参数的函数(<code>distance()</code>很明显是不符合条件的)。现在我们可以通过使用<code>partial()</code>来解决这个问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>pt = (<span class="number">4</span>, <span class="number">3</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>points.sort(key=partial(distance,pt))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>points</span><br><span class="line">[(<span class="number">3</span>, <span class="number">4</span>), (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">5</span>, <span class="number">6</span>), (<span class="number">7</span>, <span class="number">8</span>)]</span><br></pre></td></tr></table></figure>
<p>更进一步，<code>partial()</code> 通常被用来微调其他库函数所使用的回调函数的参数。 例如，下面是一段代码，使用 <code>multiprocessing</code> 来异步计算一个结果值， 然后这个值被传递给一个接受一个<code>result</code>值和一个可选<code>logging</code>参数的回调函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output_result</span><span class="params">(result, log=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> log <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        log.debug(<span class="string">'Got: %r'</span>, result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># A sample function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">import</span> logging</span><br><span class="line">    <span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line">    <span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line">    logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">    log = logging.getLogger(<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">    p = Pool()</span><br><span class="line">    p.apply_async(add, (<span class="number">3</span>, <span class="number">4</span>), callback=partial(output_result, log=log))</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br></pre></td></tr></table></figure>
<h3 id="类与对象">类与对象</h3><h4 id="改变对象的字符串显示">改变对象的字符串显示</h4><p>要改变一个实例的字符串表示，可重新定义它的<code>__str__()</code>和<code>__repr__()</code>方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Pair(&#123;0.x!r&#125;, &#123;0.y!r&#125;)'</span>.format(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'(&#123;0.x!s&#125;, &#123;0.y!s&#125;)'</span>.format(self)</span><br></pre></td></tr></table></figure></p>
<p><code>__repr__()</code>方法返回一个实例的代码表示形式，通常用来重新构造这个实例。内置的<code>repr()</code>函数返回这个字符串，跟我们使用交互式解释器显示的值是一样的。<code>__str__()</code>方法将实例转换为一个字符串，使用<code>str()</code>或<code>print()</code>函数会输出这个字符串。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>p = Pair(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>p</span><br><span class="line">Pair(<span class="number">3</span>, <span class="number">4</span>) <span class="comment"># __repr__() output</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(p)</span><br><span class="line">(<span class="number">3</span>, <span class="number">4</span>) <span class="comment"># __str__() output</span></span><br></pre></td></tr></table></figure></p>
<p><code>!r</code>格式化代码指明输出使用<code>__repr__()</code>来代替默认的<code>__str__()</code>。你还可以做如下的测试：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>p = Pair(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(<span class="string">'p is &#123;0!r&#125;'</span>.format(p))</span><br><span class="line">p <span class="keyword">is</span> Pair(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(<span class="string">'p is &#123;0&#125;'</span>.format(p))</span><br><span class="line">p <span class="keyword">is</span> (<span class="number">3</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure></p>
<p>定义<code>__repr__()</code>和<code>__str__()</code>通常是很好的习惯，因为它能简化调试和实例输出。例如，如果仅仅只是打印输出或日志输出某个实例，那么程序员会看到实例更加详细与有用的信息。<br><code>__repr__()</code>生成的文本字符串标准做法是需要让<code>eval(repr(x)) == x</code>为真。如果实在不能这样子做，应该创建一个有用的文本表示，并使用&lt;和&gt;括起来。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>f = open(<span class="string">'file.dat'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>f</span><br><span class="line">&lt;_io.TextIOWrapper name=<span class="string">'file.dat'</span> mode=<span class="string">'r'</span> encoding=<span class="string">'UTF-8'</span>&gt;</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果<code>__str__()</code>没有被定义，那么就会使用<code>__repr__()</code>来代替输出。上面的<code>format()</code>方法的使用看上去很有趣，格式化代码<code>{0.x}</code>对应的是第1个参数的x属性。因此，在下面的函数中，0实际上指的就是<code>self</code>本身：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Pair(&#123;0.x!r&#125;, &#123;0.y!r&#125;)'</span>.format(self)</span><br></pre></td></tr></table></figure></p>
<p>作为这种实现的一个替代，你也可以使用<code>%</code>操作符，就像下面这样<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Pair(%r, %r)'</span> % (self.x, self.y)</span><br></pre></td></tr></table></figure></p>
<h4 id="让对象支持上下文管理协议">让对象支持上下文管理协议</h4><p>为了让一个对象兼容<code>with</code>语句，你需要实现<code>__enter()__</code>和<code>__exit__()</code>方法。例如，考虑如下的一个类，它能为我们创建一个网络连接：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socket, AF_INET, SOCK_STREAM</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyConnection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address, family=AF_INET, type=SOCK_STREAM)</span>:</span></span><br><span class="line">        self.address = address</span><br><span class="line">        self.family = family</span><br><span class="line">        self.type = type</span><br><span class="line">        self.sock = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.sock <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Already connected'</span>)</span><br><span class="line">        self.sock = socket(self.family, self.type)</span><br><span class="line">        self.sock.connect(self.address)</span><br><span class="line">        <span class="keyword">return</span> self.sock</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_ty, exc_val, tb)</span>:</span></span><br><span class="line">        self.sock.close()</span><br><span class="line">        self.sock = <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>这个类的关键特点在于它表示了一个网络连接，但是初始化的时候并不会做任何事情(比如它并没有建立一个连接)。连接的建立和关闭是使用<code>with</code>语句自动完成的<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line">conn = LazyConnection((<span class="string">'www.python.org'</span>, <span class="number">80</span>))</span><br><span class="line"><span class="comment"># Connection closed</span></span><br><span class="line"><span class="keyword">with</span> conn <span class="keyword">as</span> s:</span><br><span class="line">    <span class="comment"># conn.__enter__() executes: connection open</span></span><br><span class="line">    s.send(<span class="string">b'GET /index.html HTTP/1.0\r\n'</span>)</span><br><span class="line">    s.send(<span class="string">b'Host: www.python.org\r\n'</span>)</span><br><span class="line">    s.send(<span class="string">b'\r\n'</span>)</span><br><span class="line">    resp = <span class="string">b''</span>.join(iter(partial(s.recv, <span class="number">8192</span>), <span class="string">b''</span>))</span><br><span class="line">    <span class="comment"># conn.__exit__() executes: connection closed</span></span><br></pre></td></tr></table></figure></p>
<p>编写上下文管理器的主要原理是你的代码会放到<code>with</code>语句块中执行。当出现<code>with</code>语句的时候，对象的<code>__enter__()</code>方法被触发，它返回的值(如果有的话)会被赋值给<code>as</code>声明的变量。然后，<code>with</code>语句块里面的代码开始执行。最后，<code>__exit__()</code>方法被触发进行清理工作。</p>
<p>不管<code>with</code>代码块中发生什么，上面的控制流都会执行完，就算代码块中发生了异常也是一样的。事实上，<code>__exit__()</code>方法的第三个参数包含了异常类型、异常值和追溯信息(如果有的话)。<code>__exit__()</code>方法能自己决定怎样利用这个异常信息，或者忽略它并返回一个None值。如果<code>__exit__()</code>返回<code>True</code>，那么异常会被清空，就好像什么都没发生一样，<code>with</code>语句后面的程序继续在正常执行。</p>
<p>如果你想要获得嵌套<code>with</code>语句的效果，代码需要如下修改<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socket, AF_INET, SOCK_STREAM</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyConnection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address, family=AF_INET, type=SOCK_STREAM)</span>:</span></span><br><span class="line">        self.address = address</span><br><span class="line">        self.family = family</span><br><span class="line">        self.type = type</span><br><span class="line">        self.connections = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        sock = socket(self.family, self.type)</span><br><span class="line">        sock.connect(self.address)</span><br><span class="line">        self.connections.append(sock)</span><br><span class="line">        <span class="keyword">return</span> sock</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_ty, exc_val, tb)</span>:</span></span><br><span class="line">        self.connections.pop().close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example use</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line">conn = LazyConnection((<span class="string">'www.python.org'</span>, <span class="number">80</span>))</span><br><span class="line"><span class="keyword">with</span> conn <span class="keyword">as</span> s1:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">with</span> conn <span class="keyword">as</span> s2:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        <span class="comment"># s1 and s2 are independent sockets</span></span><br></pre></td></tr></table></figure></p>
<p>在第二个版本中，<code>LazyConnection</code>类可以被看做是某个连接工厂。在内部，一个列表被用来构造一个栈。每次<code>__enter__()</code>方法执行的时候，它复制创建一个新的连接并将其加入到栈里面。<code>__exit__()</code>方法简单的从栈中弹出最后一个连接并关闭它。这里稍微有点难理解，不过它能允许嵌套使用<code>with</code>语句创建多个连接。</p>
<p>在需要管理一些资源比如文件、网络连接和锁的编程环境中，使用上下文管理器是很普遍的。这些资源的一个主要特征是它们必须被手动的关闭或释放来确保程序的正确运行。例如，如果你请求了一个锁，那么你必须确保之后释放了它，否则就可能产生死锁。通过实现<code>__enter__()</code>和<code>__exit__()</code>方法并使用<code>with</code>语句可以很容易的避免这些问题，因为<code>__exit__()</code>方法可以让你无需担心这些了。</p>
<h4 id="创建大量对象时节省内存方法">创建大量对象时节省内存方法</h4><p>对于主要是用来当成简单的数据结构的类而言，你可以通过给类添加<code>__slots__</code>属性来极大的减少实例所占的内存。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line">    __slots__ = [<span class="string">'year'</span>, <span class="string">'month'</span>, <span class="string">'day'</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line">        self.year = year</span><br><span class="line">        self.month = month</span><br><span class="line">        self.day = day</span><br></pre></td></tr></table></figure></p>
<p>当你定义<code>__slots__</code>后，Python就会为实例使用一种更加紧凑的内部表示。实例通过一个很小的固定大小的数组来构建，而不是为每个实例定义一个字典，这跟元组或列表很类似。在<code>__slots__</code>中列出的属性名在内部被映射到这个数组的指定小标上。使用<code>slots</code>一个不好的地方就是我们不能再给实例添加新的属性了，只能使用在<code>__slots__</code>中定义的那些属性名。</p>
<h4 id="在类中封装属性名">在类中封装属性名</h4><p><code>Python</code>程序员不去依赖语言特性去封装数据，而是通过遵循一定的属性和方法命名规约来达到这个效果。第一个约定是任何以单下划线<code>_</code>开头的名字都应该是内部实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._internal = <span class="number">0</span> <span class="comment"># An internal attribute</span></span><br><span class="line">        self.public = <span class="number">1</span> <span class="comment"># A public attribute</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''</span><br><span class="line">        A public method</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_internal_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p><code>Python</code>并不会真的阻止别人访问内部名称。但是如果你这么做肯定是不好的，可能会导致脆弱的代码。同时还要注意到，使用下划线开头的约定同样适用于模块名和模块级别函数。例如，如果你看到某个模块名以单下划线开头(比如<code>_socket</code>)，那它就是内部实现。类似的，模块级别函数比如<code>sys._getframe()</code>在使用的时候就得加倍小心了。</p>
<p>使用双下划线开始会导致访问名称变成其他形式。比如，在前面的类B中，私有属性会被分别重命名为<code>_B__private</code>和<code>_B__private_method</code>。这时候你可能会问这样重命名的目的是什么，答案就是继承——这种属性通过继承是无法被覆盖的。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.__private = <span class="number">1</span> <span class="comment"># Does not override B.__private</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Does not override B.__private_method()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__private_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>这里，私有名称<code>__private</code>和<code>__private_method</code>被重命名为<code>_C__private</code>和<code>_C__private_method</code>，这个跟父类B中的名称是完全不同的。</p>
<p>通常的，如果定义的变量与保留关键字冲突，那么可以单划线作为后缀。一般的以单划线开头定义变量即可，如果你清楚你的代码会涉及到子类，那么推荐是用双下划线方案。</p>
<h4 id="创建可管理的属性">创建可管理的属性</h4><p>自定义某个属性的一种简单方法是将它定义为一个<code>property</code>。例如，下面的代码定义了一个<code>property</code>，增加对一个属性简单的类型检查：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, first_name)</span>:</span></span><br><span class="line">        self.first_name = first_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Getter function</span></span><br><span class="line">    <span class="decorator">@property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._first_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setter function</span></span><br><span class="line">    <span class="decorator">@first_name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._first_name = value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deleter function (optional)</span></span><br><span class="line">    <span class="decorator">@first_name.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">"Can't delete attribute"</span>)</span><br></pre></td></tr></table></figure></p>
<p>上述代码中有三个相关联的方法，这三个方法的名字都必须一样。第一个方法是一个<code>getter</code>函数，它使得<code>first_name</code>成为一个属性。其他两个方法给<code>first_name</code>属性添加了<code>setter</code>和<code>deleter</code>函数。需要强调的是只有在<code>first_name</code>属性被创建后，后面的两个装饰器<code>@first_name.setter</code>和<code>@first_name.deleter</code>才能被定义。</p>
<p><code>property</code>的一个关键特征是它看上去跟普通的<code>attribute</code>没什么两样，但是访问它的时候会自动触发<code>getter</code>、<code>setter</code>和<code>deleter</code>方法。例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = Person(<span class="string">'Guido'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a.first_name <span class="comment"># Calls the getter</span></span><br><span class="line"><span class="string">'Guido'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a.first_name = <span class="number">42</span> <span class="comment"># Calls the setter</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"prop.py"</span>, line <span class="number">14</span>, <span class="keyword">in</span> first_name</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">TypeError: Expected a string</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">del</span> a.first_name</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: can<span class="string">'t delete attribute</span></span><br></pre></td></tr></table></figure>
<p>在实现一个<code>property</code>时候，底层数据(如果有的话)仍然需要存储在某个地方。因此，在get和set方法中，你会看到对<code>_first_name</code>属性的操作，这也是实际数据保存的地方。另外，你可能还会问为什么<code>__init__()</code>方法中设置了<code>self.first_name</code>而不是<code>self._first_name</code>。在这个例子中，我们创建一个<code>property</code>的目的就是在设置<code>attribute</code>的时候进行检查。因此，你可能想在初始化的时候也进行这种类型检查。通过设置<code>self.first_name</code>，自动调用<code>setter</code>方法，这个方法里面会进行参数的检查，否则就是直接访问<code>self._first_name</code>了。</p>
<p>还能在已存在的<code>get</code>和<code>set</code>方法基础上定义<code>property</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, first_name)</span>:</span></span><br><span class="line">        self.set_first_name(first_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Getter function</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._first_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setter function</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._first_name = value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deleter function (optional)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">del_first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">"Can't delete attribute"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Make a property from existing get/set methods</span></span><br><span class="line">    name = property(get_first_name, set_first_name, del_first_name)</span><br></pre></td></tr></table></figure></p>
<h4 id="调用父类方法">调用父类方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.spam'</span>)</span><br><span class="line">        super().spam()  <span class="comment"># Call parent spam()</span></span><br></pre></td></tr></table></figure>
<p><code>super()</code>函数的一个常见用法是在<code>__init__()</code>方法中确保父类被正确的初始化了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.x = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.y = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="定义接口或者抽象基类">定义接口或者抽象基类</h4><p>使用<code>abs</code>模块可以很轻松的定义抽象基类:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IStream</span><span class="params">(metaclass=ABCMeta)</span>:</span></span><br><span class="line">    <span class="decorator">@abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, maxbytes=-<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="decorator">@abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>抽象类的一个特点是它不能直接被实例化，比如你想像下面这样做是不行的:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = IStream() <span class="comment"># TypeError: Can't instantiate abstract class</span></span><br><span class="line">                <span class="comment"># IStream with abstract methods read, write</span></span><br></pre></td></tr></table></figure></p>
<p>抽象类的目的就是让别的类继承它并实现特定的抽象方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketStream</span><span class="params">(IStream)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, maxbytes=-<span class="number">1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>抽象基类的一个主要用途是在代码中检查某些类是否为特定类型，实现了特定接口：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(obj, stream)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(stream, IStream):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Expected an IStream'</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>除了继承这种方式外，还可以通过注册方式来让某个类实现抽象基类：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register the built-in I/O classes as supporting our interface</span></span><br><span class="line">IStream.register(io.IOBase)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Open a normal file and type check</span></span><br><span class="line">f = open(<span class="string">'foo.txt'</span>)</span><br><span class="line">isinstance(f, IStream) <span class="comment"># Returns True</span></span><br></pre></td></tr></table></figure></p>
<p><code>@abstractmethod</code>还能注解静态方法、类方法和<code>properties</code>。你只需保证这个注解紧靠在函数定义前即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(metaclass=ABCMeta)</span>:</span></span><br><span class="line">    <span class="decorator">@property</span></span><br><span class="line">    <span class="decorator">@abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="decorator">@name.setter</span></span><br><span class="line">    <span class="decorator">@abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="decorator">@classmethod</span></span><br><span class="line">    <span class="decorator">@abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method1</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="decorator">@abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method2</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>标准库中有很多用到抽象基类的地方。<code>collections</code>模块定义了很多跟容器和迭代器(序列、映射、集合等)有关的抽象基类。<code>numbers</code>库定义了跟数字对象(整数、浮点数、有理数等)有关的基类。<code>io</code>库定义了很多跟<code>I/O</code>操作相关的基类。</p>
<p>你可以使用预定义的抽象类来执行更通用的类型检查，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if x is a sequence</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Sequence):</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if x is iterable</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Iterable):</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if x has a size</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Sized):</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if x is a mapping</span></span><br><span class="line"><span class="keyword">if</span> isinstance(x, collections.Mapping):</span><br></pre></td></tr></table></figure></p>
<p>尽管<code>ABCs</code>可以让我们很方便的做类型检查，但是我们在代码中最好不要过多的使用它。因为<code>Python</code>的本质是一门动态编程语言，其目的就是给你更多灵活性，强制类型检查或让你代码变得更复杂，这样做无异于舍本求末。</p>
<h4 id="实现自定义容器">实现自定义容器</h4><p><code>collections</code>定义了很多抽象基类，当你想自定义容器类的时候它们会非常有用。比如你想让你的类支持迭代，那就让你的类继承<code>collections.Iterable</code>即可：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(collections.Iterable)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>不过你需要实现<code>collections.Iterable</code>所有的抽象方法，否则会报错:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = A()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: Can<span class="string">'t instantiate abstract class A with abstract methods __iter__</span></span><br></pre></td></tr></table></figure></p>
<p><code>collections</code>中很多抽象类会为一些常见容器操作提供默认的实现，这样一来你只需要实现那些你最感兴趣的方法即可。假设你的类继承自<code>collections.MutableSequence</code>，如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Items</span><span class="params">(collections.MutableSequence)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initial=None)</span>:</span></span><br><span class="line">        self._items = list(initial) <span class="keyword">if</span> initial <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">else</span> []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Required sequence methods</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        print(<span class="string">'Getting:'</span>, index)</span><br><span class="line">        <span class="keyword">return</span> self._items[index]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        print(<span class="string">'Setting:'</span>, index, value)</span><br><span class="line">        self._items[index] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        print(<span class="string">'Deleting:'</span>, index)</span><br><span class="line">        <span class="keyword">del</span> self._items[index]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        print(<span class="string">'Inserting:'</span>, index, value)</span><br><span class="line">        self._items.insert(index, value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Len'</span>)</span><br><span class="line">        <span class="keyword">return</span> len(self._items)</span><br></pre></td></tr></table></figure></p>
<h4 id="在类中定义多个构造器">在类中定义多个构造器</h4><p>为了实现多个构造器，你需要使用到类方法。例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line">    <span class="string">"""方法一：使用类方法"""</span></span><br><span class="line">    <span class="comment"># Primary constructor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line">        self.year = year</span><br><span class="line">        self.month = month</span><br><span class="line">        self.day = day</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Alternate constructor</span></span><br><span class="line">    <span class="decorator">@classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">today</span><span class="params">(cls)</span>:</span></span><br><span class="line">        t = time.localtime()</span><br><span class="line">        <span class="keyword">return</span> cls(t.tm_year, t.tm_mon, t.tm_mday)</span><br></pre></td></tr></table></figure></p>
<p>直接调用类方法即可，下面是使用示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = Date(<span class="number">2012</span>, <span class="number">12</span>, <span class="number">21</span>) <span class="comment"># Primary</span></span><br><span class="line">b = Date.today() <span class="comment"># Alternate</span></span><br></pre></td></tr></table></figure></p>
<p>类方法的一个主要用途就是定义多个构造器。它接受一个<code>class</code>作为第一个参数<code>(cls)</code>。你应该注意到了这个类被用来创建并返回最终的实例。在继承时也能工作的很好：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewDate</span><span class="params">(Date)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">c = Date.today() <span class="comment"># Creates an instance of Date (cls=Date)</span></span><br><span class="line">d = NewDate.today() <span class="comment"># Creates an instance of NewDate (cls=NewDate)</span></span><br></pre></td></tr></table></figure></p>
<h4 id="创建不调用init方法的实例">创建不调用init方法的实例</h4><p>可以通过<code>__new__()</code>方法创建一个未初始化的实例。例如考虑如下这个类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line">        self.year = year</span><br><span class="line">        self.month = month</span><br><span class="line">        self.day = day</span><br></pre></td></tr></table></figure>
<p>下面演示如何不调用<code>__init__()</code>方法来创建这个Date实例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d = Date.__new__(Date)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d</span><br><span class="line">&lt;__main__.Date object at <span class="number">0x1006716d0</span>&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d.year</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'Date'</span> object has no attribute <span class="string">'year'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>结果可以看到，这个<code>Date</code>实例的属性<code>year</code>还不存在，所以你需要手动初始化：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data = &#123;<span class="string">'year'</span>:<span class="number">2012</span>, <span class="string">'month'</span>:<span class="number">8</span>, <span class="string">'day'</span>:<span class="number">29</span>&#125;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line"><span class="prompt">... </span>    setattr(d, key, value)</span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d.year</span><br><span class="line"><span class="number">2012</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d.month</span><br><span class="line"><span class="number">8</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="实现状态对象或者状态机">实现状态对象或者状态机</h4><p>你想实现一个状态机或者是在不同状态下执行操作的对象，但是又不想在代码中出现太多的条件判断语句。那么如下是最好的实现方式<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection1</span>:</span></span><br><span class="line">    <span class="string">"""新方案——对每个状态定义一个类"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.new_state(ClosedConnectionState)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_state</span><span class="params">(self, newstate)</span>:</span></span><br><span class="line">        self._state = newstate</span><br><span class="line">        <span class="comment"># Delegate to the state class</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.read(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.write(self, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.open(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.close(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Connection state base class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectionState</span>:</span></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Implementation of different states</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosedConnectionState</span><span class="params">(ConnectionState)</span>:</span></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line">        conn.new_state(OpenConnectionState)</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already closed'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenConnectionState</span><span class="params">(ConnectionState)</span>:</span></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line">        print(<span class="string">'reading'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">        print(<span class="string">'writing'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already open'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line">        conn.new_state(ClosedConnectionState)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c = Connection1()</span><br><span class="line">print(c._state)</span><br><span class="line">c.open()</span><br><span class="line">print(c._state)</span><br><span class="line">c.read()</span><br><span class="line">print(c._state)</span><br><span class="line">c.write(<span class="string">'Hello'</span>)</span><br><span class="line">print(c._state)</span><br><span class="line">c.close()</span><br><span class="line">print(c._state)<span class="comment">#### 通过字符串调用对象方法</span></span><br></pre></td></tr></table></figure></p>
<h4 id="让类支持比较操作">让类支持比较操作</h4><p>Python类对每个比较操作都需要实现一个特殊方法来支持。例如为了支持&gt;=操作符，你需要定义一个<code>__ge__()</code>方法。尽管定义一个方法没什么问题，但如果要你实现所有可能的比较方法那就有点烦人了。</p>
<p>装饰器<code>functools.total_ordering</code>就是用来简化这个处理的。使用它来装饰一个来，你只需定义一个<code>__eq__()</code>方法，外加其他方法<code>(__lt__, __le__, __gt__, or __ge__)</code>中的一个即可。然后装饰器会自动为你填充其它比较方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, length, width)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.length = length</span><br><span class="line">        self.width = width</span><br><span class="line">        self.square_feet = self.length * self.width</span><br><span class="line"></span><br><span class="line"><span class="decorator">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, style)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.style = style</span><br><span class="line">        self.rooms = list()</span><br><span class="line"></span><br><span class="line">    <span class="decorator">@property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">living_space_footage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> sum(r.square_feet <span class="keyword">for</span> r <span class="keyword">in</span> self.rooms)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_room</span><span class="params">(self, room)</span>:</span></span><br><span class="line">        self.rooms.append(room)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;: &#123;&#125; square foot &#123;&#125;'</span>.format(self.name,</span><br><span class="line">                self.living_space_footage,</span><br><span class="line">                self.style)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.living_space_footage == other.living_space_footage</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.living_space_footage &lt; other.living_space_footage</span><br></pre></td></tr></table></figure></p>
<p>这里我们只是给<code>House</code>类定义了两个方法：<code>__eq__()</code>和<code>__lt__()</code>，它就能支持所有的比较操作。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Build a few houses, and add rooms to them</span></span><br><span class="line">h1 = House(<span class="string">'h1'</span>, <span class="string">'Cape'</span>)</span><br><span class="line">h1.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line">h1.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line">h1.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line">h1.add_room(Room(<span class="string">'Office'</span>, <span class="number">12</span>, <span class="number">12</span>))</span><br><span class="line">h2 = House(<span class="string">'h2'</span>, <span class="string">'Ranch'</span>)</span><br><span class="line">h2.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line">h2.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line">h2.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line">h3 = House(<span class="string">'h3'</span>, <span class="string">'Split'</span>)</span><br><span class="line">h3.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line">h3.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line">h3.add_room(Room(<span class="string">'Office'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line">h3.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">15</span>, <span class="number">17</span>))</span><br><span class="line">houses = [h1, h2, h3]</span><br><span class="line">print(<span class="string">'Is h1 bigger than h2?'</span>, h1 &gt; h2) <span class="comment"># prints True</span></span><br><span class="line">print(<span class="string">'Is h2 smaller than h3?'</span>, h2 &lt; h3) <span class="comment"># prints True</span></span><br><span class="line">print(<span class="string">'Is h2 greater than or equal to h1?'</span>, h2 &gt;= h1) <span class="comment"># Prints False</span></span><br><span class="line">print(<span class="string">'Which one is biggest?'</span>, max(houses)) <span class="comment"># Prints 'h3: 1101-square-foot Split'</span></span><br><span class="line">print(<span class="string">'Which is smallest?'</span>, min(houses)) <span class="comment"># Prints 'h2: 846-square-foot Ranch'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="创建缓存实例">创建缓存实例</h4><p>在创建一个类的对象时，如果之前使用同样参数创建过这个对象，你想返回它的缓存引用。为了达到这样的效果，你需要使用一个和类本身分开的工厂函数，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The class in question</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"><span class="comment"># Caching support</span></span><br><span class="line"><span class="keyword">import</span> weakref</span><br><span class="line">_spam_cache = weakref.WeakValueDictionary()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> _spam_cache:</span><br><span class="line">        s = Spam(name)</span><br><span class="line">        _spam_cache[name] = s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = _spam_cache[name]</span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure></p>
<p>对于大部分程序而已，这里代码已经够用了。不过还是有一些更高级的实现值得了解下。首先是这里使用到了一个全局变量，并且工厂函数跟类放在一块。我们可以通过将缓存代码放到一个单独的缓存管理器中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weakref</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedSpamManager</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._cache = weakref.WeakValueDictionary()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self._cache:</span><br><span class="line">            s = Spam(name)</span><br><span class="line">            self._cache[name] = s</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            s = self._cache[name]</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">            self._cache.clear()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line">    manager = CachedSpamManager()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Spam.manager.get_spam(name)</span><br></pre></td></tr></table></figure></p>
<p>但是这样暴露了类的实例化给用户，如果想阻止用户实例化该类的话，可以通过如下方法解决<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------------------------最后的修正方案------------------------</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedSpamManager2</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._cache = weakref.WeakValueDictionary()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_spam</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> self._cache:</span><br><span class="line">            temp = Spam3._new(name)  <span class="comment"># Modified creation</span></span><br><span class="line">            self._cache[name] = temp</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            temp = self._cache[name]</span><br><span class="line">        <span class="keyword">return</span> temp</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">            self._cache.clear()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam3</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">"Can't instantiate directly"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Alternate constructor</span></span><br><span class="line">    <span class="decorator">@classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_new</span><span class="params">(cls, name)</span>:</span></span><br><span class="line">        self = cls.__new__(cls)</span><br><span class="line">        self.name = name</span><br><span class="line">        <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure></p>
<p>参考资料<br>【1】<a href="http://code.google.com/p/proden/downloads/detail?name=A%20Byte%20of%20Python3(%E4%B8%AD%E6%96%87%E7%89%88).pdf" target="_blank" rel="external">A Byte of Python3</a><br>【2】<a href="http://python3-cookbook.readthedocs.org/zh_CN/latest/c01/p08_calculating_with_dict.html" target="_blank" rel="external">python3-cookbook</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/07/Python-implementation-string-similarity-edit-distance/" itemprop="url">
                  Python实现字符串相似度-编辑距离
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-07T21:14:59+08:00" content="2015-07-07">
              2015-07-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithms</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/07/Python-implementation-string-similarity-edit-distance/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/07/Python-implementation-string-similarity-edit-distance/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="编辑距离">编辑距离</h3><p>关于维基上的定义参见<a href="https://zh.wikipedia.org/zh-cn/%E7%B7%A8%E8%BC%AF%E8%B7%9D%E9%9B%A2" target="_blank" rel="external">这里</a>。编辑距离，又称<code>Levenshtein</code>距离，是指两个字串之间，由一个转成另一个所需的最少编辑操作次数。通常许可的编辑操作包括:</p>
<ul>
<li>将一个字符替换成另一个字符</li>
<li>插入一个字符</li>
<li>删除一个字符</li>
</ul>
<p>例如将kitten一字转成sitting：</p>
<ul>
<li>sitten （k→s）</li>
<li>sittin （e→i）</li>
<li>sitting （→g）</li>
</ul>
<p>俄罗斯科学家<a href="https://zh.wikipedia.org/wiki/Vladimir_Levenshtein" target="_blank" rel="external"><code>Vladimir Levenshtein</code></a>在1965年提出了这个概念。</p>
<h3 id="算法">算法</h3><p>动态规划经常被用来作为这个问题的解决手段之一。伪代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#25972;&#25968; Levenshtein&#36317;&#31163;(&#23383;&#31526; str1[1..lenStr1], &#23383;&#31526; str2[1..lenStr2])&#10;   &#22768;&#26126; int d[0..lenStr1, 0..lenStr2]&#10;   &#22768;&#26126; int i, j, cost&#10;&#10;   for i = &#30001; 0 &#33267; lenStr1&#10;       d[i, 0] := i&#10;   for j = &#30001; 0 &#33267; lenStr2&#10;       d[0, j] := j&#10;&#10;   for i = &#30001; 1 &#33267; lenStr1&#10;       for j = &#30001; 1 &#33267; lenStr2&#10;           &#33509; str1[i] = str2[j] &#21017; cost := 0&#10;                                &#21542;&#21017; cost := 1&#10;           d[i, j] := &#26368;&#23567;&#20540;(&#10;                                d[i-1, j  ] + 1,     // &#21034;&#38500;&#10;                                d[i  , j-1] + 1,     // &#25554;&#20837;&#10;                                d[i-1, j-1] + cost   // &#26367;&#25442;&#10;                            )&#10;&#10;   &#36820;&#22238; d[lenStr1, lenStr2]</span><br></pre></td></tr></table></figure></p>
<h3 id="Python实现">Python实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">Created on 2015/7/7  10:08</span><br><span class="line">使用动态规划算法实现编辑距离的计算</span><br><span class="line">@author: Wang Xu</span><br><span class="line">"""</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LevenshteinDistance</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leDistance</span><span class="params">(self, input_x, input_y)</span>:</span></span><br><span class="line">        xlen = len(input_x) + <span class="number">1</span>  <span class="comment"># 此处需要多开辟一个元素存储最后一轮的计算结果</span></span><br><span class="line">        ylen = len(input_y) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        dp = np.zeros(shape=(xlen, ylen), dtype=int)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, xlen):</span><br><span class="line">            dp[i][<span class="number">0</span>] = i</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, ylen):</span><br><span class="line">            dp[<span class="number">0</span>][j] = j</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, xlen):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>, ylen):</span><br><span class="line">                <span class="keyword">if</span> input_x[i - <span class="number">1</span>] == input_y[j - <span class="number">1</span>]:</span><br><span class="line">                    dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    dp[i][j] = <span class="number">1</span> + min(dp[i - <span class="number">1</span>][j], dp[i][j - <span class="number">1</span>], dp[i - <span class="number">1</span>][j - <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> dp[xlen - <span class="number">1</span>][ylen - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ld = LevenshteinDistance()</span><br><span class="line">    print(ld.leDistance(<span class="string">'瓦罐蹄膀饭'</span>, <span class="string">'瓦罐焖蹄饭'</span>))  <span class="comment"># Prints 2</span></span><br><span class="line">    print(ld.leDistance(<span class="string">''</span>, <span class="string">'a'</span>))   <span class="comment"># Prints 1</span></span><br><span class="line">    print(ld.leDistance(<span class="string">'b'</span>, <span class="string">''</span>))   <span class="comment"># Prints 1</span></span><br><span class="line">    print(ld.leDistance(<span class="string">''</span>, <span class="string">''</span>))    <span class="comment"># Prints 0</span></span><br><span class="line">    print(ld.leDistance(<span class="string">'杭椒小炒肉面'</span>, <span class="string">'外婆小肉面'</span>))  <span class="comment"># Prints 3</span></span><br><span class="line">    print(ld.leDistance(<span class="string">'外婆小肉面'</span>, <span class="string">'杭椒小炒肉面'</span>))  <span class="comment"># Prints 3</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/06/Python3-beginner-s-handbook-three/" itemprop="url">
                  Python3入门手册之三
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-06T20:50:25+08:00" content="2015-07-06">
              2015-07-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/06/Python3-beginner-s-handbook-three/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/06/Python3-beginner-s-handbook-three/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>Version：Python 3.4.3 (v3.4.3:9b73f1c3e601, Feb 24 2015, 22:44:40) [MSC v.1600 64 bit (AMD64)] on win32</em></p>
<h3 id="文件与I/O">文件与I/O</h3><h4 id="读写文本数据">读写文本数据</h4><p>使用带有<code>rt</code>模式的<code>open()</code>函数读取文本文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'test.csv'</span>, mode=<span class="string">'rt'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read()</span><br><span class="line">    print(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'test.csv'</span>, mode=<span class="string">'rt'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        print(line, end=<span class="string">''</span>)</span><br></pre></td></tr></table></figure></p>
<p>类似的，为了写入一个文本文件，使用带有<code>wt</code>模式的<code>open()</code>函数，如果之前文件内容存在则清除并覆盖掉<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'dest.csv'</span>, mode=<span class="string">'wt'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'text1'</span>)  <span class="comment"># 注意该方式写入文件默认没有换行符，需手动添加</span></span><br><span class="line">    f.write(<span class="string">'text2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'dest.csv'</span>, mode=<span class="string">'wt'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">'text1'</span>, file=f)  <span class="comment"># 该方式写入文件默认换行，无需手动添加</span></span><br><span class="line">    print(<span class="string">'text2'</span>, file=f)</span><br></pre></td></tr></table></figure></p>
<p>如果是在已存在文件中添加内容，使用模式为<code>at</code>的<code>open()</code>函数。<code>with</code>控制块结束时，文件会自动关闭。你也可以不使用<code>with</code>语句，但是这时候你就必须记得手动关闭文件。</p>
<p><strong>使用print输出元组</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">row = (<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">print(*row, sep=<span class="string">','</span>, end=<span class="string">'。'</span>) <span class="comment"># Prints a,b,c。</span></span><br></pre></td></tr></table></figure></p>
<h4 id="读写字节数据">读写字节数据</h4><p>使用模式为<code>rb</code>或<code>wb</code>的<code>open()</code>函数来读取或写入二进制数据<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'dest2.csv'</span>, mode=<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'HelloWorld!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'dest2.csv'</span>, mode=<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read())</span><br></pre></td></tr></table></figure></p>
<p>在读取二进制数据的时候，字节字符串和文本字符串的语义差异可能会导致一个潜在的陷阱。特别需要注意的是，索引和迭代动作返回的是字节的值而不是字节字符串。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Text string</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>t = <span class="string">'Hello World'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>t[<span class="number">0</span>]</span><br><span class="line"><span class="string">'H'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> t:</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">H</span><br><span class="line">e</span><br><span class="line">l</span><br><span class="line">l</span><br><span class="line">o</span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Byte string</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = <span class="string">b'Hello World'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b[<span class="number">0</span>]</span><br><span class="line"><span class="number">72</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> b:</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line"><span class="number">72</span></span><br><span class="line"><span class="number">101</span></span><br><span class="line"><span class="number">108</span></span><br><span class="line"><span class="number">108</span></span><br><span class="line"><span class="number">111</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h4 id="向不存在的文件中写入数据">向不存在的文件中写入数据</h4><p>如果只允许向不存在的文件写入数据，可以在<code>open()</code>函数中使用<code>x</code>模式来代替<code>w</code>模式来解决这个问题。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'dest2.csv'</span>, mode=<span class="string">'xt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'test'</span>)</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"E:/workspaces/Python3/edu/shu/python/study/FileAndIO.py"</span>, line <span class="number">33</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'dest2.csv'</span>, mode=<span class="string">'xt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">FileExistsError: [Errno <span class="number">17</span>] File exists: <span class="string">'dest2.csv'</span></span><br></pre></td></tr></table></figure></p>
<p>由提示信息可知，当该文件在系统中已经存在的时候，是不允许继续向其中写入内容的。如果文件是二进制的，使用<code>xb</code>来代替<code>xt</code>。</p>
<h4 id="字符串的I/O操作">字符串的I/O操作</h4><p>使用<code>io.StringIO()</code>和<code>io.BytesIO()</code>类来创建类文件对象操作字符串数据<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">s = io.StringIO()</span><br><span class="line">s.write(<span class="string">'Hello World!'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'\nthis is a test'</span>, file=s)</span><br><span class="line"><span class="comment"># 向控制台输出内容</span></span><br><span class="line">print(s.getvalue())</span><br><span class="line"></span><br><span class="line">s = io.StringIO(<span class="string">'Hello World!\n'</span>)</span><br><span class="line"><span class="comment"># 先读取4个字符</span></span><br><span class="line">print(s.read(<span class="number">4</span>))</span><br><span class="line"><span class="comment"># 读取剩下的字符</span></span><br><span class="line">print(s.read())</span><br></pre></td></tr></table></figure></p>
<p><code>io.StringIO</code>只能用于文本。如果你要操作二进制数据，要使用<code>io.BytesIO</code>类来代替<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = io.BytesIO()</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s.write(<span class="string">b'binary data'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s.getvalue()</span><br><span class="line"><span class="string">b'binary data'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="读写压缩文件">读写压缩文件</h4><p><code>gzip</code>和<code>bz2</code>模块可以很容易的处理这些文件。两个模块都为<code>open()</code>函数提供了另外的实现来解决这个问题<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gzip compression</span></span><br><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"><span class="keyword">with</span> gzip.open(<span class="string">'somefile.gz'</span>, <span class="string">'rt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># bz2 compression</span></span><br><span class="line"><span class="keyword">import</span> bz2</span><br><span class="line"><span class="keyword">with</span> bz2.open(<span class="string">'somefile.bz2'</span>, <span class="string">'rt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read()</span><br></pre></td></tr></table></figure></p>
<p>类似的，为了写入压缩数据，可以这样做<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gzip compression</span></span><br><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"><span class="keyword">with</span> gzip.open(<span class="string">'somefile.gz'</span>, <span class="string">'wt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># bz2 compression</span></span><br><span class="line"><span class="keyword">import</span> bz2</span><br><span class="line"><span class="keyword">with</span> bz2.open(<span class="string">'somefile.bz2'</span>, <span class="string">'wt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(text)</span><br></pre></td></tr></table></figure></p>
<p>大部分情况下读写压缩数据都是很简单的。但是要注意的是选择一个正确的文件模式是非常重要的。如果你不指定模式，那么默认的就是二进制模式，如果这时候程序想要接受的是文本数据，那么就会出错。<br>当写入压缩数据时，可以使用<code>compresslevel</code>这个可选的关键字参数来指定一个压缩级别。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> gzip.open(<span class="string">'somefile.gz'</span>, <span class="string">'wt'</span>, compresslevel=<span class="number">5</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(text)</span><br></pre></td></tr></table></figure></p>
<p>默认的等级是<code>9</code>，也是最高的压缩等级。等级越低性能越好，但是数据压缩程度也越低。</p>
<p>最后一点，<code>gzip.open()</code>和<code>bz2.open()</code>还有一个很少被知道的特性，它们可以作用在一个已存在并以二进制模式打开的文件上。比如，下面代码是可行的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line">f = open(<span class="string">'somefile.gz'</span>, <span class="string">'rb'</span>)</span><br><span class="line"><span class="keyword">with</span> gzip.open(f, <span class="string">'rt'</span>) <span class="keyword">as</span> g:</span><br><span class="line">    text = g.read()</span><br></pre></td></tr></table></figure></p>
<p>这样就允许<code>gzip</code>和<code>bz2</code>模块可以工作在许多类文件对象上，比如套接字，管道和内存中文件等。</p>
<h4 id="读取二进制数据到可变缓冲区中">读取二进制数据到可变缓冲区中</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_into_buffer</span><span class="params">(filename)</span>:</span></span><br><span class="line">    buf = bytearray(os.path.getsize(filename))</span><br><span class="line">    <span class="keyword">with</span> open(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.readinto(buf)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Write a sample file</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">with</span> open(<span class="string">'sample.bin'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line"><span class="prompt">... </span>    f.write(<span class="string">b'Hello World'</span>)</span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>buf = read_into_buffer(<span class="string">'sample.bin'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>buf</span><br><span class="line">bytearray(<span class="string">b'Hello World'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>buf[<span class="number">0</span>:<span class="number">5</span>] = <span class="string">b'Hallo'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>buf</span><br><span class="line">bytearray(<span class="string">b'Hallo World'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">with</span> open(<span class="string">'newsample.bin'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line"><span class="prompt">... </span>    f.write(buf)</span><br><span class="line">...</span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<p>文件对象的<code>readinto()</code>方法能被用来为预先分配内存的数组填充数据，甚至包括由<code>array</code>模块或<code>numpy</code>库创建的数组。和普通<code>read()</code>方法不同的是，<code>readinto()</code>填充已存在的缓冲区而不是为新对象重新分配内存再返回它们。因此，你可以使用它来避免大量的内存分配操作。比如，如果你读取一个由相同大小的记录组成的二进制文件时，你可以像下面这样写：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">record_size = <span class="number">32</span> <span class="comment"># Size of each record (adjust value)</span></span><br><span class="line"></span><br><span class="line">buf = bytearray(record_size)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'somefile'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        n = f.readinto(buf)</span><br><span class="line">        <span class="keyword">if</span> n &lt; record_size:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># Use the contents of buf</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<h4 id="文件路径名的操作">文件路径名的操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>path = <span class="string">'/Users/beazley/Data/data.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Get the last component of the path</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.basename(path)</span><br><span class="line"><span class="string">'data.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Get the directory name</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.dirname(path)</span><br><span class="line"><span class="string">'/Users/beazley/Data'</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Join path components together</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.join(<span class="string">'tmp'</span>, <span class="string">'data'</span>, os.path.basename(path))</span><br><span class="line"><span class="string">'tmp/data/data.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Expand the user's home directory</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>path = <span class="string">'~/Data/data.csv'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.expanduser(path)</span><br><span class="line"><span class="string">'/Users/beazley/Data/data.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Split the file extension</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.splitext(path)</span><br><span class="line">(<span class="string">'~/Data/data'</span>, <span class="string">'.csv'</span>)</span><br></pre></td></tr></table></figure>
<p>对于任何的文件名的操作，你都应该使用<code>os.path</code>模块，而不是使用标准字符串操作来构造自己的代码。特别是为了可移植性考虑的时候更应如此，因为<code>os.path</code>模块知道<code>Unix</code>和<code>Windows</code>系统之间的差异并且能够可靠地处理类似<code>Data/data.csv</code>和<code>Data\data.csv</code>这样的文件名。其次，你真的不应该浪费时间去重复造轮子。通常最好是直接使用已经为你准备好的功能。</p>
<p>使用如下方式测试文件的类型，如果测试的文件不存在的时候，结果都会返回<strong>False</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Is a regular file</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.isfile(<span class="string">'/etc/passwd'</span>)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Is a directory</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.isdir(<span class="string">'/etc/passwd'</span>)</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Is a symbolic link</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.islink(<span class="string">'/usr/local/bin/python3'</span>)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Get the file linked to</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.realpath(<span class="string">'/usr/local/bin/python3'</span>)</span><br><span class="line"><span class="string">'/usr/local/bin/python3.3'</span></span><br></pre></td></tr></table></figure></p>
<p>如果你还想获取元数据(比如文件大小或者是修改日期)，也可以使用<code>os.path</code>模块来解决<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.getsize(<span class="string">'/etc/passwd'</span>)</span><br><span class="line"><span class="number">3669</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>os.path.getmtime(<span class="string">'/etc/passwd'</span>)</span><br><span class="line"><span class="number">1272478234.0</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> time</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>time.ctime(os.path.getmtime(<span class="string">'/etc/passwd'</span>))</span><br><span class="line"><span class="string">'Wed Apr 28 13:10:34 2010'</span></span><br></pre></td></tr></table></figure></p>
<p>使用<code>os.listdir()</code>函数来获取某个目录中的文件列表<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">names = os.listdir(<span class="string">'somedir'</span>)</span><br></pre></td></tr></table></figure></p>
<p>获取目录中的列表是很容易的，但是其返回结果只是目录中实体名列表而已。如果你还想获取其他的元信息，比如文件大小，修改时间等等，你或许还需要使用到<code>os.path</code>模块中的函数或者<code>os.stat()</code>函数来收集数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example of getting a directory listing</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line">pyfiles = glob.glob(<span class="string">'*.py'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get file sizes and modification dates</span></span><br><span class="line">name_sz_date = [(name, os.path.getsize(name), os.path.getmtime(name))</span><br><span class="line">                <span class="keyword">for</span> name <span class="keyword">in</span> pyfiles]</span><br><span class="line"><span class="keyword">for</span> name, size, mtime <span class="keyword">in</span> name_sz_date:</span><br><span class="line">    print(name, size, mtime)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternative: Get file metadata</span></span><br><span class="line">file_metadata = [(name, os.stat(name)) <span class="keyword">for</span> name <span class="keyword">in</span> pyfiles]</span><br><span class="line"><span class="keyword">for</span> name, meta <span class="keyword">in</span> file_metadata:</span><br><span class="line">    print(name, meta.st_size, meta.st_mtime)</span><br></pre></td></tr></table></figure></p>
<h4 id="增加或改变已打开文件的编码">增加或改变已打开文件的编码</h4><p>如果你想给一个以二进制模式打开的文件添加<code>Unicode</code>编码/解码方式，可以使用<code>io.TextIOWrapper()</code>对象包装它。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">u = urllib.request.urlopen(<span class="string">'http://www.python.org'</span>)</span><br><span class="line">f = io.TextIOWrapper(u, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">text = f.read()</span><br></pre></td></tr></table></figure></p>
<p>如果你想修改一个已经打开的文本模式的文件的编码方式，可以先使用<code>detach()</code>方法移除掉已存在的文本编码层，并使用新的编码方式代替。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>sys.stdout.encoding</span><br><span class="line"><span class="string">'UTF-8'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>sys.stdout = io.TextIOWrapper(sys.stdout.detach(), encoding=<span class="string">'latin-1'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>sys.stdout.encoding</span><br><span class="line"><span class="string">'latin-1</span></span><br></pre></td></tr></table></figure></p>
<p>在文本模式打开的文件中写入原始的字节数据，将字节数据直接写入文件的缓冲区即可。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>sys.stdout.write(<span class="string">b'Hello\n'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: must be str, <span class="keyword">not</span> bytes</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>sys.stdout.buffer.write(<span class="string">b'Hello\n'</span>)</span><br><span class="line">Hello</span><br><span class="line"><span class="number">5</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>类似的，能够通过读取文本文件的<code>buffer</code>属性来读取二进制数据。</p>
<h4 id="创建临时文件和文件夹">创建临时文件和文件夹</h4><p><code>tempfile</code>模块中有很多的函数可以完成这任务。为了创建一个匿名的临时文件，可以使用<code>tempfile.TemporaryFile</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> TemporaryFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> TemporaryFile(<span class="string">'w+t'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="comment"># Read/write to the file</span></span><br><span class="line">    f.write(<span class="string">'Hello World\n'</span>)</span><br><span class="line">    f.write(<span class="string">'Testing\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Seek back to beginning and read the data</span></span><br><span class="line">    f.seek(<span class="number">0</span>)</span><br><span class="line">    data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Temporary file is destroyed</span></span><br></pre></td></tr></table></figure></p>
<p><code>TemporaryFile()</code>的第一个参数是文件模式，通常来讲文本模式使用<code>w+t</code>，二进制模式使用<code>w+b</code>。这个模式同时支持读和写操作，在这里是很有用的，因为当你关闭文件去改变模式的时候，文件实际上已经不存在了。<code>TemporaryFile()</code>另外还支持跟内置的<code>open()</code>函数一样的参数。</p>
<p>在大多数<code>Unix</code>系统上，通过<code>TemporaryFile()</code>创建的文件都是匿名的，甚至连目录都没有。如果你想打破这个限制，可以使用<code>NamedTemporaryFile()</code>来代替。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> NamedTemporaryFile</span><br><span class="line"><span class="keyword">with</span> NamedTemporaryFile(<span class="string">'w+t'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">'filename is:'</span>, f.name)</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># File automatically destroyed</span></span><br></pre></td></tr></table></figure></p>
<p>这里，被打开文件的<code>f.name</code>属性包含了该临时文件的文件名。当你需要将文件名传递给其他代码来打开这个文件的时候，这个就很有用了。和<code>TemporaryFile()</code>一样，结果文件关闭时会被自动删除掉。如果你不想这么做，可以传递一个关键字参数<code>delte=False</code>即可。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> NamedTemporaryFile(<span class="string">'w+t'</span>, delete=<span class="keyword">False</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(<span class="string">'filename is:'</span>, f.name)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>为了创建一个临时目录，可以使用<code>tempfile.TemporaryDirectory()</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> TemporaryDirectory</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> TemporaryDirectory() <span class="keyword">as</span> dirname:</span><br><span class="line">    print(<span class="string">'dirname is:'</span>, dirname)</span><br><span class="line">    <span class="comment"># Use the directory</span></span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># Directory and all contents destroyed</span></span><br></pre></td></tr></table></figure></p>
<p><code>TemporaryFile()</code>、<code>NamedTemporaryFile()</code>和<code>TemporaryDirectory()</code>函数应该是处理临时文件目录的最简单的方式了，因为它们会自动处理所有的创建和清理步骤。在一个更低的级别，你可以使用<code>mkstemp()</code>和<code>mkdtemp()</code>来创建临时文件和目录。</p>
<h4 id="与串行端口的数据通信">与串行端口的数据通信</h4><p>尽管你可以通过使用Python内置的I/O模块来完成这个任务，但对于串行通信最好的选择是使用<a href="http://pyserial.sourceforge.net/" target="_blank" rel="external">pySerial</a>包。这个包的使用非常简单，先安装<code>pySerial</code>，使用类似下面这样的代码就能很容易的打开一个串行端口：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> serial</span><br><span class="line">ser = serial.Serial(<span class="string">'/dev/tty.usbmodem641'</span>, <span class="comment"># Device name varies</span></span><br><span class="line">                    baudrate=<span class="number">9600</span>,</span><br><span class="line">                    bytesize=<span class="number">8</span>,</span><br><span class="line">                    parity=<span class="string">'N'</span>,</span><br><span class="line">                    stopbits=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>设备名对于不同的设备和操作系统是不一样的。比如，在<code>Windows</code>系统上，你可以使用0，1等表示的一个设备来打开通信端口<code>COM0</code>和<code>COM1</code>。一旦端口打开，那就可以使用<code>read()</code>，<code>readline()</code>和<code>write()</code>函数读写数据了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ser.write(<span class="string">b'G1 X50 Y50\r\n'</span>)</span><br><span class="line">resp = ser.readline()</span><br></pre></td></tr></table></figure></p>
<h4 id="序列化Python对象">序列化Python对象</h4><p>对于序列化最普遍的做法就是使用<code>pickle</code>模块。为了将一个对象保存到一个文件中，可以这样做：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">data = ... <span class="comment"># Some Python object</span></span><br><span class="line">f = open(<span class="string">'somefile'</span>, <span class="string">'wb'</span>)</span><br><span class="line">pickle.dump(data, f)</span><br></pre></td></tr></table></figure></p>
<p>为了将一个对象转储为一个字符串，可以使用<code>pickle.dumps()</code>：<br><code>s = pickle.dumps(data)</code><br>为了从字节流中恢复一个对象，使用<code>picle.load()</code>或<code>pickle.loads()</code>函数。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Restore from a file</span></span><br><span class="line">f = open(<span class="string">'somefile'</span>, <span class="string">'rb'</span>)</span><br><span class="line">data = pickle.load(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Restore from a string</span></span><br><span class="line">data = pickle.loads(s)</span><br></pre></td></tr></table></figure></p>
<h3 id="数据编码和处理">数据编码和处理</h3><h4 id="读写CSV数据">读写CSV数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="comment"># 将CSV中的数据读入元组中，并允许使用列名如row.Symbol和row.Change（Symbol和Change是CSV文件中的列名）</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'stock.csv'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f_csv = csv.reader(f)</span><br><span class="line">    headings = next(f_csv)</span><br><span class="line">    Row = namedtuple(<span class="string">'Row'</span>, headings)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> f_csv:</span><br><span class="line">        row = Row(*r)</span><br><span class="line">        <span class="comment"># Process row</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>另外一个选择就是将数据读取到一个字典序列中去。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'stocks.csv'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f_csv = csv.DictReader(f)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> f_csv:</span><br><span class="line">        <span class="comment"># process row</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<p>在这个版本中，你可以使用列名去访问每一行的数据了。比如，<code>row[&#39;Symbol&#39;]</code>或者<code>row[&#39;Change&#39;]</code>。</p>
<p>为了写入<code>CSV</code>数据，你仍然可以使用<code>CSV</code>模块，不过这时候先创建一个<code>writer</code>对象。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">headers = [<span class="string">'Symbol'</span>,<span class="string">'Price'</span>,<span class="string">'Date'</span>,<span class="string">'Time'</span>,<span class="string">'Change'</span>,<span class="string">'Volume'</span>]</span><br><span class="line">rows = [(<span class="string">'AA'</span>, <span class="number">39.48</span>, <span class="string">'6/11/2007'</span>, <span class="string">'9:36am'</span>, -<span class="number">0.18</span>, <span class="number">181800</span>),</span><br><span class="line">         (<span class="string">'AIG'</span>, <span class="number">71.38</span>, <span class="string">'6/11/2007'</span>, <span class="string">'9:36am'</span>, -<span class="number">0.15</span>, <span class="number">195500</span>),</span><br><span class="line">         (<span class="string">'AXP'</span>, <span class="number">62.58</span>, <span class="string">'6/11/2007'</span>, <span class="string">'9:36am'</span>, -<span class="number">0.46</span>, <span class="number">935000</span>),</span><br><span class="line">       ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'stocks.csv'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f_csv = csv.writer(f)</span><br><span class="line">    f_csv.writerow(headers)</span><br><span class="line">    f_csv.writerows(rows)</span><br></pre></td></tr></table></figure></p>
<p>如果你有一个字典序列的数据，可以像这样做<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">headers = [<span class="string">'Symbol'</span>, <span class="string">'Price'</span>, <span class="string">'Date'</span>, <span class="string">'Time'</span>, <span class="string">'Change'</span>, <span class="string">'Volume'</span>]</span><br><span class="line">rows = [&#123;<span class="string">'Symbol'</span>:<span class="string">'AA'</span>, <span class="string">'Price'</span>:<span class="number">39.48</span>, <span class="string">'Date'</span>:<span class="string">'6/11/2007'</span>,</span><br><span class="line">        <span class="string">'Time'</span>:<span class="string">'9:36am'</span>, <span class="string">'Change'</span>:-<span class="number">0.18</span>, <span class="string">'Volume'</span>:<span class="number">181800</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'Symbol'</span>:<span class="string">'AIG'</span>, <span class="string">'Price'</span>: <span class="number">71.38</span>, <span class="string">'Date'</span>:<span class="string">'6/11/2007'</span>,</span><br><span class="line">        <span class="string">'Time'</span>:<span class="string">'9:36am'</span>, <span class="string">'Change'</span>:-<span class="number">0.15</span>, <span class="string">'Volume'</span>: <span class="number">195500</span>&#125;,</span><br><span class="line">        &#123;<span class="string">'Symbol'</span>:<span class="string">'AXP'</span>, <span class="string">'Price'</span>: <span class="number">62.58</span>, <span class="string">'Date'</span>:<span class="string">'6/11/2007'</span>,</span><br><span class="line">        <span class="string">'Time'</span>:<span class="string">'9:36am'</span>, <span class="string">'Change'</span>:-<span class="number">0.46</span>, <span class="string">'Volume'</span>: <span class="number">935000</span>&#125;,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'stocks.csv'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f_csv = csv.DictWriter(f, headers)</span><br><span class="line">    f_csv.writeheader()</span><br><span class="line">    f_csv.writerows(rows)</span><br></pre></td></tr></table></figure></p>
<h4 id="读写JSON数据">读写JSON数据</h4><p><code>json</code>模块提供了一种很简单的方式来编码和解码JSON数据。其中两个主要的函数是<code>json.dumps()</code>和<code>json.loads()</code>，要比其他序列化函数库如<code>pickle</code>的接口少得多。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'name'</span> : <span class="string">'ACME'</span>,</span><br><span class="line">    <span class="string">'shares'</span> : <span class="number">100</span>,</span><br><span class="line">    <span class="string">'price'</span> : <span class="number">542.23</span></span><br><span class="line">&#125;</span><br><span class="line">json_str = json.dumps(data)</span><br></pre></td></tr></table></figure></p>
<p>将JSON编码的字符串转回一个Python数据结构<br><code>data = json.loads(json_str)</code><br>如果你要处理的是文件而不是字符串，你可以使用<code>json.dump()</code>和<code>json.load()</code>来编码和解码JSON数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Writing JSON data</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'data.json'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(data, f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Reading data back</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'data.json'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = json.load(f)</span><br></pre></td></tr></table></figure></p>
<h4 id="解析简单的XML数据">解析简单的XML数据</h4><p>可以使用<code>xml.etree.ElementTree</code>模块从简单的XML文档中提取数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download the RSS feed and parse it</span></span><br><span class="line">u = urlopen(<span class="string">'http://planet.python.org/rss20.xml'</span>)</span><br><span class="line">doc = parse(u)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Extract and output tags of interest</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> doc.iterfind(<span class="string">'channel/item'</span>):</span><br><span class="line">    title = item.findtext(<span class="string">'title'</span>)</span><br><span class="line">    date = item.findtext(<span class="string">'pubDate'</span>)</span><br><span class="line">    link = item.findtext(<span class="string">'link'</span>)</span><br><span class="line"></span><br><span class="line">    print(title)</span><br><span class="line">    print(date)</span><br><span class="line">    print(link)</span><br><span class="line">    print()</span><br></pre></td></tr></table></figure></p>
<p><code>xml.etree.ElementTree.parse()</code>函数解析整个XML文档并将其转换成一个文档对象。然后，你就能使用<code>find()</code>、<code>iterfind()</code>和<code>findtext()</code>等方法来搜索特定的XML元素了。这些函数的参数就是某个指定的标签名，例如<code>channel/item</code>或<code>title</code>。</p>
<p><code>ElementTree</code>模块中的每个元素有一些重要的属性和方法，在解析的时候非常有用。<code>tag</code>属性包含了标签的名字，<code>text</code>属性包含了内部的文本，而<code>get()</code>方法能获取属性值。</p>
<p>有一点要强调的是<code>xml.etree.ElementTree</code>并不是<code>XML</code>解析的唯一方法。对于更高级的应用程序，你需要考虑使用<code>lxml</code>。它使用了和<code>ElementTree</code>同样的编程接口，因此上面的例子同样也适用于<code>lxml</code>。你只需要将刚开始的<code>import</code>语句换成<code>from lxml.etree import parse</code>就行了。<code>lxml</code>完全遵循<code>XML</code>标准，并且速度也非常快，同时还支持验证，<code>XSLT</code>和<code>XPath</code>等特性。</p>
<h4 id="增量式解析大型XML文件">增量式解析大型XML文件</h4><p>任何时候只要你遇到增量式的数据处理时，第一时间就应该想到迭代器和生成器。 下面是一个很简单的函数，只使用很少的内存就能增量式的处理一个大型XML文件。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> iterparse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_and_remove</span><span class="params">(filename, path)</span>:</span></span><br><span class="line">    path_parts = path.split(<span class="string">'/'</span>)</span><br><span class="line">    doc = iterparse(filename, (<span class="string">'start'</span>, <span class="string">'end'</span>))</span><br><span class="line">    <span class="comment"># Skip the root element</span></span><br><span class="line">    next(doc)</span><br><span class="line"></span><br><span class="line">    tag_stack = []</span><br><span class="line">    elem_stack = []</span><br><span class="line">    <span class="keyword">for</span> event, elem <span class="keyword">in</span> doc:</span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">'start'</span>:</span><br><span class="line">            tag_stack.append(elem.tag)</span><br><span class="line">            elem_stack.append(/)</span><br><span class="line">        <span class="keyword">elif</span> event == <span class="string">'end'</span>:</span><br><span class="line">            <span class="keyword">if</span> tag_stack == path_parts:</span><br><span class="line">                <span class="keyword">yield</span> elem</span><br><span class="line">                elem_stack[-<span class="number">2</span>].remove(elem)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                tag_stack.pop()</span><br><span class="line">                elem_stack.pop()</span><br><span class="line">            <span class="keyword">except</span> IndexError:</span><br><span class="line">                <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p><code>iterparse()</code>方法允许对<code>XML</code>文档进行增量操作。使用时，你需要提供文件名和一个包含下面一种或多种类型的事件列表：<code>start</code>,<code>end</code>,<code>start-ns</code>和<code>end-ns</code>。由<code>iterparse()</code>创建的迭代器会产生形如(event, elem)的元组，其中<code>event</code>是上述事件列表中的某一个，而<code>elem</code>是相应的XML元素。</p>
<p><code>start</code>事件在某个元素第一次被创建并且还没有被插入其他数据(如子元素)时被创建。而<code>end</code>事件在某个元素已经完成时被创建。尽管没有在例子中演示，<code>start-ns</code>和<code>end-ns</code>事件被用来处理<code>XML</code>文档命名空间的声明。</p>
<h4 id="将字典转换为XML">将字典转换为XML</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> Element</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dict_to_xml</span><span class="params">(tag, d)</span>:</span></span><br><span class="line"><span class="string">'''</span><br><span class="line">Turn a simple dict of key/value pairs into XML</span><br><span class="line">'''</span></span><br><span class="line">elem = Element(tag)</span><br><span class="line"><span class="keyword">for</span> key, val <span class="keyword">in</span> d.items():</span><br><span class="line">    child = Element(key)</span><br><span class="line">    child.text = str(val)</span><br><span class="line">    elem.append(child)</span><br><span class="line"><span class="keyword">return</span> elem</span><br></pre></td></tr></table></figure>
<p>对于<code>I/O</code>操作，使用<code>xml.etree.ElementTree</code>中的<code>tostring()</code>函数很容易就能将它转换成一个字节字符串。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> tostring</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>tostring(e)</span><br><span class="line"><span class="string">b'&lt;stock&gt;&lt;price&gt;490.1&lt;/price&gt;&lt;shares&gt;100&lt;/shares&gt;&lt;name&gt;GOOG&lt;/name&gt;&lt;/stock&gt;'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p><code>xml.sax.saxutils</code>中的<code>escape()</code>和<code>unescape()</code>函数提供对HTML实体的转换方法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.sax.saxutils <span class="keyword">import</span> escape, unescape</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>escape(<span class="string">'&lt;spam&gt;'</span>)</span><br><span class="line"><span class="string">'&amp;lt;spam&amp;gt;'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>unescape(_)</span><br><span class="line"><span class="string">'&lt;spam&gt;'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="解析和修改XML">解析和修改XML</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> parse, Element</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>doc = parse(<span class="string">'pred.xml'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>root = doc.getroot()</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>root</span><br><span class="line">&lt;Element <span class="string">'stop'</span> at <span class="number">0x100770cb0</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Remove a few elements</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>root.remove(root.find(<span class="string">'sri'</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>root.remove(root.find(<span class="string">'cr'</span>))</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Insert a new element after &lt;nm&gt;...&lt;/nm&gt;</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>root.getchildren().index(root.find(<span class="string">'nm'</span>))</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>e = Element(<span class="string">'spam'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>e.text = <span class="string">'This is a test'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>root.insert(<span class="number">2</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Write back to a file</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>doc.write(<span class="string">'newpred.xml'</span>, xml_declaration=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<h4 id="编码和解码十六进制数">编码和解码十六进制数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Initial byte string</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = <span class="string">b'hello'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Encode as hex</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> binascii</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>h = binascii.b2a_hex(s)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>h</span><br><span class="line"><span class="string">b'68656c6c6f'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Decode back to bytes</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>binascii.a2b_hex(h)</span><br><span class="line"><span class="string">b'hello'</span></span><br></pre></td></tr></table></figure>
<p>类似的功能同样可以在<code>base64</code>模块中找到<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>h = base64.b16encode(s)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>h</span><br><span class="line"><span class="string">b'68656C6C6F'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>base64.b16decode(h)</span><br><span class="line"><span class="string">b'hello'</span></span><br></pre></td></tr></table></figure></p>
<p>大部分情况下，通过使用上述的函数来转换十六进制是很简单的。上面两种技术的主要不同在于大小写的处理。函数<code>base64.b16decode()</code>和<code>base64.b16encode()</code>只能操作大写形式的十六进制字母，而<code>binascii</code>模块中的函数大小写都能处理。<br>还有一点需要注意的是编码函数所产生的输出总是一个字节字符串。如果想强制以<code>Unicode</code>形式输出，你需要增加一个额外的界面步骤。例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>h = base64.b16encode(s)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(h)</span><br><span class="line"><span class="string">b'68656C6C6F'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(h.decode(<span class="string">'ascii'</span>))</span><br><span class="line"><span class="number">68656</span>C6C6F</span><br></pre></td></tr></table></figure></p>
<p>在解码十六进制数时，函数<code>b16decode()</code>和<code>a2b_hex()</code>可以接受字节或<code>unicode</code>字符串。但是，<code>unicode</code>字符串必须仅仅只包含<code>ASCII</code>编码的十六进制数。</p>
<h4 id="编码解码Base64数据">编码解码Base64数据</h4><p><code>base64</code>模块中有两个函数<code>b64encode()</code>and<code>b64decode()</code>可以帮你解决这个问题。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Some byte data</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = <span class="string">b'hello'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Encode as Base64</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = base64.b64encode(s)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a</span><br><span class="line"><span class="string">b'aGVsbG8='</span></span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Decode from Base64</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>base64.b64decode(a)</span><br><span class="line"><span class="string">b'hello'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="读写二进制数组数据">读写二进制数组数据</h4><p>可以使用<code>struct</code>模块处理二进制数据。下面是一段示例代码将一个Python元组列表写入一个二进制文件，并使用<code>struct</code>将每个元组编码为一个结构体。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> Struct</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_records</span><span class="params">(records, format, f)</span>:</span></span><br><span class="line">    <span class="string">'''</span><br><span class="line">    Write a sequence of tuples to a binary file of structures.</span><br><span class="line">    '''</span></span><br><span class="line">    record_struct = Struct(format)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> records:</span><br><span class="line">        f.write(record_struct.pack(*r))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    records = [ (<span class="number">1</span>, <span class="number">2.3</span>, <span class="number">4.5</span>),</span><br><span class="line">                (<span class="number">6</span>, <span class="number">7.8</span>, <span class="number">9.0</span>),</span><br><span class="line">                (<span class="number">12</span>, <span class="number">13.4</span>, <span class="number">56.7</span>) ]</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data.b'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        write_records(records, <span class="string">'&lt;idd'</span>, f)</span><br></pre></td></tr></table></figure></p>
<p>如果你打算以块的形式增量读取文件，你可以这样做：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> Struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_records</span><span class="params">(format, f)</span>:</span></span><br><span class="line">    record_struct = Struct(format)</span><br><span class="line">    chunks = iter(<span class="keyword">lambda</span>: f.read(record_struct.size), <span class="string">b''</span>)</span><br><span class="line">    <span class="keyword">return</span> (record_struct.unpack(chunk) <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data.b'</span>,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> rec <span class="keyword">in</span> read_records(<span class="string">'&lt;idd'</span>, f):</span><br><span class="line">            <span class="comment"># Process rec</span></span><br><span class="line">            ...</span><br></pre></td></tr></table></figure></p>
<p>如果你想将整个文件一次性读取到一个字节字符串中，然后在分片解析。那么你可以这样做：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> Struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpack_records</span><span class="params">(format, data)</span>:</span></span><br><span class="line">    record_struct = Struct(format)</span><br><span class="line">    <span class="keyword">return</span> (record_struct.unpack_from(data, offset)</span><br><span class="line">            <span class="keyword">for</span> offset <span class="keyword">in</span> range(<span class="number">0</span>, len(data), record_struct.size))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data.b'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="keyword">for</span> rec <span class="keyword">in</span> unpack_records(<span class="string">'&lt;idd'</span>, data):</span><br><span class="line">        <span class="comment"># Process rec</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></p>
<p>参考资料<br>【1】<a href="http://code.google.com/p/proden/downloads/detail?name=A%20Byte%20of%20Python3(%E4%B8%AD%E6%96%87%E7%89%88).pdf" target="_blank" rel="external">A Byte of Python3</a><br>【2】<a href="http://python3-cookbook.readthedocs.org/zh_CN/latest/c01/p08_calculating_with_dict.html" target="_blank" rel="external">python3-cookbook</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/04/Python3-beginner-s-handbook-two/" itemprop="url">
                  Python3入门手册之二
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-04T21:16:41+08:00" content="2015-07-04">
              2015-07-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/04/Python3-beginner-s-handbook-two/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/04/Python3-beginner-s-handbook-two/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>Version：Python 3.4.3 (v3.4.3:9b73f1c3e601, Feb 24 2015, 22:44:40) [MSC v.1600 64 bit (AMD64)] on win32</em></p>
<h3 id="数字日期和时间">数字日期和时间</h3><h4 id="数字的四舍五入">数字的四舍五入</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">Created on 2015/7/3  23:01</span><br><span class="line">@author: 'WX'</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line">print(round(<span class="number">1.23</span>, <span class="number">1</span>))  <span class="comment"># Prints 1.2</span></span><br><span class="line">print(round(<span class="number">1.27</span>, <span class="number">1</span>))  <span class="comment"># Prints 1.3</span></span><br><span class="line">print(round(-<span class="number">1.27</span>, <span class="number">1</span>))  <span class="comment"># Prints -1.3</span></span><br><span class="line">print(round(<span class="number">1.25361</span>, <span class="number">3</span>))  <span class="comment"># Prints 1.254</span></span><br><span class="line"><span class="comment"># 当一个值刚好在两个边界的中间的时候，round 函数返回离它最近的偶数</span></span><br><span class="line">print(round(<span class="number">1.25</span>, <span class="number">1</span>))  <span class="comment"># Prints 1.2</span></span><br><span class="line">print(round(<span class="number">1.35</span>, <span class="number">1</span>))  <span class="comment"># Prints 1.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传给 round() 函数的 ndigits 参数可以是负数，这种情况下， 舍入运算会作用在十位、百位、千位等上面</span></span><br><span class="line">a = <span class="number">1627731</span></span><br><span class="line">print(round(a, -<span class="number">1</span>))</span><br><span class="line">print(round(a, -<span class="number">2</span>))</span><br><span class="line">print(round(a, -<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化浮点数，保留指定的小数点后保留位数</span></span><br><span class="line">print(format(<span class="number">1.23456</span>, <span class="string">'0.2f'</span>))</span><br></pre></td></tr></table></figure>
<h4 id="执行精确的浮点数运算">执行精确的浮点数运算</h4><p>如果需要精确的浮点数计算，那么推荐使用<code>decimal</code>模块的<code>Decimal</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"></span><br><span class="line">a = Decimal(<span class="string">'1.3'</span>)</span><br><span class="line">b = Decimal(<span class="string">'1.7'</span>)</span><br><span class="line">print(a / b)</span><br><span class="line"></span><br><span class="line">a = Decimal(<span class="string">'4.2'</span>)</span><br><span class="line">b = Decimal(<span class="string">'2.1'</span>)</span><br><span class="line">c = a.__add__(b)</span><br><span class="line">d = a + b</span><br><span class="line">print(c)  <span class="comment"># Prints 6.3</span></span><br><span class="line">print(d)  <span class="comment"># Prints 6.3</span></span><br></pre></td></tr></table></figure></p>
<h4 id="无穷大与NaN">无穷大与NaN</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = float(<span class="string">'inf'</span>)</span><br><span class="line">b = float(<span class="string">'-inf'</span>)</span><br><span class="line">c = float(<span class="string">'nan'</span>)</span><br><span class="line">print(a)  <span class="comment"># Prints inf</span></span><br><span class="line">print(b)  <span class="comment"># Prints -inf</span></span><br><span class="line">print(c)  <span class="comment"># Prints nan</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="comment"># 可以使用如下方式测试这些值的存在，测试一个NaN值的唯一安全的方法就是使用math.isnan()</span></span><br><span class="line">print(math.isinf(a))  <span class="comment"># Prints True</span></span><br><span class="line">print(math.isnan(c))  <span class="comment"># Prints True</span></span><br></pre></td></tr></table></figure>
<h4 id="分数运算">分数运算</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fractions模块可以被用来执行包含分数的数学运算</span></span><br><span class="line"><span class="keyword">from</span> fractions <span class="keyword">import</span> Fraction</span><br><span class="line"></span><br><span class="line">a = Fraction(<span class="number">5</span>, <span class="number">4</span>)</span><br><span class="line">b = Fraction(<span class="number">7</span>, <span class="number">16</span>)</span><br><span class="line">print(a + b)  <span class="comment"># Prints 27/16</span></span><br><span class="line">c = a * b</span><br><span class="line">print(c)  <span class="comment"># Prints 35/64</span></span><br><span class="line">print(c.numerator)  <span class="comment"># 获取分子</span></span><br><span class="line">print(c.denominator)  <span class="comment"># 获取分母</span></span><br><span class="line">print(float(c))  <span class="comment"># 强转成float类型</span></span><br><span class="line">d = <span class="number">3.75</span></span><br><span class="line">e = Fraction(*d.as_integer_ratio())  <span class="comment"># 强转float类型到分数类型</span></span><br><span class="line">print(e)</span><br></pre></td></tr></table></figure>
<h4 id="大型数组运算">大型数组运算</h4><p>涉及到数组的重量级运算操作，可以使用<code>NumPy</code>库。<code>NumPy</code>的一个主要特征是它会给Python提供一个数组对象，相比标准的Python列表而言更适合用来做数学运算<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Python lists</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>y = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x * <span class="number">2</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x + <span class="number">10</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate list (<span class="keyword">not</span> <span class="string">"int"</span>) to list</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>x + y</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Numpy arrays</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ax = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ay = np.array([<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ax * <span class="number">2</span></span><br><span class="line">array([<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ax + <span class="number">10</span></span><br><span class="line">array([<span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ax + ay</span><br><span class="line">array([ <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">12</span>])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ax * ay</span><br><span class="line">array([ <span class="number">5</span>, <span class="number">12</span>, <span class="number">21</span>, <span class="number">32</span>])</span><br></pre></td></tr></table></figure>
<p><code>NumPy</code>还为数组操作提供了大量的通用函数，这些函数可以作为<code>math</code>模块中类似函数的替代<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>np.sqrt(ax)</span><br><span class="line">array([ <span class="number">1.</span> , <span class="number">1.41421356</span>, <span class="number">1.73205081</span>, <span class="number">2.</span> ])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>np.cos(ax)</span><br><span class="line">array([ <span class="number">0.54030231</span>, -<span class="number">0.41614684</span>, -<span class="number">0.9899925</span> , -<span class="number">0.65364362</span>])</span><br></pre></td></tr></table></figure></p>
<p>使用<code>NumPy</code>构造一个二维数组的例子<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>grid = np.zeros(shape=(<span class="number">10000</span>,<span class="number">10000</span>), dtype=float)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>grid</span><br><span class="line">    array([[ <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, ..., <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">    [ <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, ..., <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">    [ <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, ..., <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">    ...,</span><br><span class="line">    [ <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, ..., <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">    [ <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, ..., <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">    [ <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, ..., <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>]])</span><br></pre></td></tr></table></figure></p>
<p>对于<code>NumPy</code>构造的数组，如何选择行和列呢？<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>]])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a</span><br><span class="line">array([[ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">[ <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">[ <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>]])</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Select row 1</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a[<span class="number">1</span>]</span><br><span class="line">array([<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>])</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Select column 1</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a[:,<span class="number">1</span>]</span><br><span class="line">array([ <span class="number">2</span>, <span class="number">6</span>, <span class="number">10</span>])</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Select a subregion and change it</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a[<span class="number">1</span>:<span class="number">3</span>, <span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line">array([[ <span class="number">6</span>, <span class="number">7</span>],</span><br><span class="line">        [<span class="number">10</span>, <span class="number">11</span>]])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a[<span class="number">1</span>:<span class="number">3</span>, <span class="number">1</span>:<span class="number">3</span>] += <span class="number">10</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a</span><br><span class="line">array([[ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [ <span class="number">5</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">8</span>],</span><br><span class="line">        [ <span class="number">9</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">12</span>]])</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Broadcast a row vector across an operation on all rows</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a + [<span class="number">100</span>, <span class="number">101</span>, <span class="number">102</span>, <span class="number">103</span>]</span><br><span class="line">array([[<span class="number">101</span>, <span class="number">103</span>, <span class="number">105</span>, <span class="number">107</span>],</span><br><span class="line">        [<span class="number">105</span>, <span class="number">117</span>, <span class="number">119</span>, <span class="number">111</span>],</span><br><span class="line">        [<span class="number">109</span>, <span class="number">121</span>, <span class="number">123</span>, <span class="number">115</span>]])</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a</span><br><span class="line">array([[ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [ <span class="number">5</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">8</span>],</span><br><span class="line">        [ <span class="number">9</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">12</span>]])</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Conditional assignment on an array</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>np.where(a &lt; <span class="number">10</span>, a, <span class="number">10</span>)</span><br><span class="line">array([[ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [ <span class="number">5</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">8</span>],</span><br><span class="line">        [ <span class="number">9</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>]])</span><br></pre></td></tr></table></figure></p>
<p>通常我们导入<code>NumPy</code>模块的时候会使用语句<code>import numpy as np</code>。这样的话你就不用再你的程序里面一遍遍的敲入<code>numpy</code>，只需要输入<code>np</code>就行了，节省了不少时间。</p>
<h4 id="基本的日期与时间转换">基本的日期与时间转换</h4><p>为了执行不同时间单位的转换和计算，请使用<code>datetime</code>模块<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = timedelta(days=<span class="number">2</span>, hours=<span class="number">6</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = timedelta(hours=<span class="number">4.5</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = a + b</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.days</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.seconds</span><br><span class="line"><span class="number">37800</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.seconds / <span class="number">3600</span></span><br><span class="line"><span class="number">10.5</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c.total_seconds() / <span class="number">3600</span></span><br><span class="line"><span class="number">58.5</span></span><br></pre></td></tr></table></figure></p>
<p>如果你想表示指定的日期和时间，先创建一个<code>datetime</code>实例然后使用标准的数学运算来操作它们<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = datetime(<span class="number">2012</span>, <span class="number">9</span>, <span class="number">23</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(a + timedelta(days=<span class="number">10</span>))</span><br><span class="line"><span class="number">2012</span>-<span class="number">10</span>-<span class="number">03</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = datetime(<span class="number">2012</span>, <span class="number">12</span>, <span class="number">21</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d = b - a</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d.days</span><br><span class="line"><span class="number">89</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>now = datetime.today()</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(now)</span><br><span class="line"><span class="number">2012</span>-<span class="number">12</span>-<span class="number">21</span> <span class="number">14</span>:<span class="number">54</span>:<span class="number">43.094063</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(now + timedelta(minutes=<span class="number">10</span>))</span><br><span class="line"><span class="number">2012</span>-<span class="number">12</span>-<span class="number">21</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">43.094063</span></span><br></pre></td></tr></table></figure></p>
<p>对大多数基本的日期和时间处理问题，<code>datetime</code>模块以及足够了。 如果你需要执行更加复杂的日期操作，比如处理时区，模糊时间范围，节假日计算等等， 可以考虑使用<code>dateutil</code>模块<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = datetime(<span class="number">2012</span>, <span class="number">9</span>, <span class="number">23</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a + timedelta(months=<span class="number">1</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">'months'</span> <span class="keyword">is</span> an invalid keyword argument <span class="keyword">for</span> this function</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> dateutil.relativedelta <span class="keyword">import</span> relativedelta</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a + relativedelta(months=+<span class="number">1</span>)</span><br><span class="line">datetime.datetime(<span class="number">2012</span>, <span class="number">10</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a + relativedelta(months=+<span class="number">4</span>)</span><br><span class="line">datetime.datetime(<span class="number">2013</span>, <span class="number">1</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Time between two dates</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = datetime(<span class="number">2012</span>, <span class="number">12</span>, <span class="number">21</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d = b - a</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d</span><br><span class="line">datetime.timedelta(<span class="number">89</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d = relativedelta(b, a)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d</span><br><span class="line">relativedelta(months=+<span class="number">2</span>, days=+<span class="number">28</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d.months</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>d.days</span><br><span class="line"><span class="number">28</span></span><br></pre></td></tr></table></figure></p>
<h4 id="字符串转换为日期">字符串转换为日期</h4><p>使用Python的标准模块<code>datetime</code>可以很容易的解决这个问题<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">text = <span class="string">'2012-09-20'</span></span><br><span class="line">y = datetime.strptime(text, <span class="string">'%Y-%m-%d'</span>)</span><br><span class="line">print(y)  <span class="comment"># Prints 2012-09-20 00:00:00</span></span><br><span class="line">z = datetime.now()</span><br><span class="line">print(z)  <span class="comment"># Prints 2015-07-04 15:49:17.419612</span></span><br><span class="line">diff = z - y</span><br><span class="line">print(diff)  <span class="comment"># Prints 1017 days, 15:49:17.419612</span></span><br></pre></td></tr></table></figure></p>
<p><code>datetime.strptime()</code>方法支持很多的格式化代码，比如<code>%Y</code>代表4位数年份，<code>%m</code>代表两位数月份。还有一点值得注意的是这些格式化占位符也可以反过来使用，将日期输出为指定的格式字符串形式<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>z</span><br><span class="line">datetime.datetime(<span class="number">2012</span>, <span class="number">9</span>, <span class="number">23</span>, <span class="number">21</span>, <span class="number">37</span>, <span class="number">4</span>, <span class="number">177393</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>nice_z = datetime.strftime(z, <span class="string">'%A %B %d, %Y'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>nice_z</span><br><span class="line"><span class="string">'Sunday September 23, 2012'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="结合时区的日期操作">结合时区的日期操作</h4><p>对几乎所有涉及到时区的问题，你都应该使用<code>pytz</code>模块。这个包提供了<code>Olson</code>时区数据库，它是时区信息的事实上的标准，在很多语言和操作系统里面都可以找到。<code>pytz</code>模块一个主要用途是将<code>datetime</code>库创建的简单日期对象本地化。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> pytz <span class="keyword">import</span> timezone</span><br><span class="line"></span><br><span class="line">d = datetime(<span class="number">2015</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">30</span>, <span class="number">0</span>)</span><br><span class="line">print(d)  <span class="comment"># Prints 2015-01-01 09:30:00</span></span><br><span class="line"><span class="comment"># central = timezone('Asia/Shanghai')</span></span><br><span class="line"><span class="comment"># Localize the date for Chicago</span></span><br><span class="line">central = timezone(<span class="string">'US/Central'</span>)</span><br><span class="line">loc_d = central.localize(d)</span><br><span class="line">print(loc_d)  <span class="comment"># Prints 2015-01-01 09:30:00-06:00</span></span><br></pre></td></tr></table></figure></p>
<p>一旦日期被本地化了， 它就可以转换为其他时区的时间了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bang_d = loc_d.astimezone(timezone(<span class="string">'Asia/Shanghai'</span>))</span><br><span class="line">print(bang_d)  <span class="comment"># Prints 2015-01-01 23:30:00+08:00</span></span><br></pre></td></tr></table></figure></p>
<p>当涉及到时区操作的时候，有个问题就是我们如何得到时区的名称。比如，在这个例子中，我们如何知道<code>“Asia/Shanghai”</code>就是中国对应的时区名呢？为了查找，可以使用<code>ISO3166</code>国家代码作为关键字去查阅字典<code>pytz.country_timezones</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Urumqi  乌鲁木齐（新疆首府）</span></span><br><span class="line">print(pytz.country_timezones[<span class="string">'CN'</span>])  <span class="comment"># Prints ['Asia/Shanghai', 'Asia/Urumqi']</span></span><br></pre></td></tr></table></figure></p>
<h3 id="迭代器与生成器">迭代器与生成器</h3><h4 id="代理迭代">代理迭代</h4><p>Python的迭代器协议需要<code>__iter__()</code>方法返回一个实现了<code>__next__()</code>方法的迭代器对象。如果你只是迭代遍历其他容器的内容，你无须担心底层是怎样实现的。你所要做的只是传递迭代请求既可。这里的<code>iter()</code>函数的使用简化了代码，<code>iter(s)</code>只是简单的通过调用<code>s.__iter__()</code>方法来返回对应的迭代器对象，就跟<code>len(s)</code>会调用<code>s.__len__()</code>原理是一样的。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">Created on 2015/7/4  18:33</span><br><span class="line">@author: 'WX'</span><br><span class="line">"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self._value = value</span><br><span class="line">        self._children = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Node(&#123;!r&#125;)'</span>.format(self._value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_child</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        self._children.append(node)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> iter(self._children)</span><br><span class="line"><span class="comment">#Example</span></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    root = Node(<span class="number">0</span>)</span><br><span class="line">    child1 = Node(<span class="number">1</span>)</span><br><span class="line">    child2 = Node(<span class="number">2</span>)</span><br><span class="line">    root.add_child(child1)</span><br><span class="line">    root.add_child(child2)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> root:</span><br><span class="line">        print(ch)</span><br></pre></td></tr></table></figure></p>
<h4 id="反向迭代">反向迭代</h4><p>反向迭代仅仅当对象的大小可预先确定或者对象实现了<code>__reversed__()</code>的特殊方法时才能生效。如果两者都不符合，那你必须先将对象转换为一个列表才行<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> reversed(a):</span><br><span class="line">    print(x, end=<span class="string">' '</span>)</span><br><span class="line">print()</span><br><span class="line"><span class="comment"># Print a file backwards</span></span><br><span class="line">f = open(<span class="string">'test.csv'</span>, mode=<span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> reversed(list(f)):</span><br><span class="line">    print(line, end=<span class="string">''</span>)</span><br></pre></td></tr></table></figure></p>
<p>要注意的是如果可迭代对象元素很多的话，将其预先转换为一个列表要消耗大量的内存。这时候需要在定义的类上实现<code>__reversed__()</code>方法来实现反向迭代<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Countdown</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start)</span>:</span></span><br><span class="line">        self.start = start</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Forward iterator</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        n = self.start</span><br><span class="line">        <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">yield</span> n</span><br><span class="line">            n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reverse iterator</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reversed__</span><span class="params">(self)</span>:</span></span><br><span class="line">        n = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> n &lt;= self.start:</span><br><span class="line">            <span class="keyword">yield</span> n</span><br><span class="line">            n += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rr <span class="keyword">in</span> reversed(Countdown(<span class="number">30</span>)):</span><br><span class="line">    print(rr)</span><br><span class="line"><span class="keyword">for</span> rr <span class="keyword">in</span> Countdown(<span class="number">30</span>):</span><br><span class="line">    print(rr)</span><br></pre></td></tr></table></figure></p>
<p>定义一个反向迭代器可以使得代码非常的高效，因为它不再需要将数据填充到一个列表中然后再去反向迭代这个列表。</p>
<h4 id="迭代器切片">迭代器切片</h4><p>函数<code>itertools.islice()</code>正好适用于在迭代器和生成器上做切片操作<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">(n)</span>:</span></span><br><span class="line"><span class="prompt">... </span>    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line"><span class="prompt">... </span>        <span class="keyword">yield</span> n</span><br><span class="line"><span class="prompt">... </span>        n += <span class="number">1</span></span><br><span class="line">...</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c = count(<span class="number">0</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>c[<span class="number">10</span>:<span class="number">20</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">'generator'</span> object <span class="keyword">is</span> <span class="keyword">not</span> subscriptable</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Now using islice()</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> itertools</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> itertools.islice(c, <span class="number">10</span>, <span class="number">20</span>):</span><br><span class="line"><span class="prompt">... </span>    print(x)</span><br><span class="line">...</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">18</span></span><br><span class="line"><span class="number">19</span></span><br></pre></td></tr></table></figure></p>
<p>函数<code>islice()</code>返回一个可以生成指定元素的迭代器，它通过遍历并丢弃直到切片开始索引位置的所有元素。然后才开始一个个的返回元素，并直到切片结束索引位置。这里要着重强调的一点是<code>islice()</code>会消耗掉传入的迭代器中的数据。必须考虑到迭代器是不可逆的这个事实。所以如果你需要之后再次访问这个迭代器的话，那你就得先将它里面的数据放入一个列表中。</p>
<h4 id="跳过可迭代对象的开始部分">跳过可迭代对象的开始部分</h4><p>为了演示，假定你在读取一个开始部分是几行注释的源文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">with</span> open(<span class="string">'/etc/passwd'</span>) <span class="keyword">as</span> f:</span><br><span class="line"><span class="prompt">... </span><span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line"><span class="prompt">... </span>    print(line, end=<span class="string">''</span>)</span><br><span class="line">...</span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># User Database</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that this file is consulted directly only when the system is running</span></span><br><span class="line"><span class="comment"># in single-user mode. At other times, this information is provided by</span></span><br><span class="line"><span class="comment"># Open Directory.</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">##</span></span><br><span class="line">nobody:*:-<span class="number">2</span>:-<span class="number">2</span>:Unprivileged User:/var/empty:/usr/bin/false</span><br><span class="line">root:*:<span class="number">0</span>:<span class="number">0</span>:System Administrator:/var/root:/bin/sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>如果你想跳过开始部分的注释行的话，可以这样做<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> dropwhile</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">with</span> open(<span class="string">'/etc/passwd'</span>) <span class="keyword">as</span> f:</span><br><span class="line"><span class="prompt">... </span>    <span class="keyword">for</span> line <span class="keyword">in</span> dropwhile(<span class="keyword">lambda</span> line: line.startswith(<span class="string">'#'</span>), f):</span><br><span class="line"><span class="prompt">... </span>        print(line, end=<span class="string">''</span>)</span><br><span class="line">...</span><br><span class="line">nobody:*:-<span class="number">2</span>:-<span class="number">2</span>:Unprivileged User:/var/empty:/usr/bin/false</span><br><span class="line">root:*:<span class="number">0</span>:<span class="number">0</span>:System Administrator:/var/root:/bin/sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<h4 id="排列组合的迭代">排列组合的迭代</h4><p><code>itertools</code>模块提供了三个函数来解决这类问题。其中一个是<code>itertools.permutations()</code>，它接受一个集合并产生一个元组序列，每个元组由集合中所有元素的一个可能排列组成。也就是说通过打乱集合中元素排列顺序生成一个元组<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>items = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> p <span class="keyword">in</span> permutations(items):</span><br><span class="line"><span class="prompt">... </span>    print(p)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>)</span><br></pre></td></tr></table></figure></p>
<p>如果你想得到指定长度的所有排列，你可以传递一个可选的长度参数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> p <span class="keyword">in</span> permutations(items, <span class="number">2</span>):</span><br><span class="line"><span class="prompt">... </span>    print(p)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'b'</span>)</span><br></pre></td></tr></table></figure></p>
<p>使用<code>itertools.combinations()</code>可得到输入集合中元素的所有的组合<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations(items, <span class="number">3</span>):</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations(items, <span class="number">2</span>):</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations(items, <span class="number">1</span>):</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>,)</span><br><span class="line">(<span class="string">'b'</span>,)</span><br><span class="line">(<span class="string">'c'</span>,)</span><br></pre></td></tr></table></figure></p>
<p>对于<code>combinations()</code>来讲，元素的顺序已经不重要了。也就是说，组合<code>(&#39;a&#39;, &#39;b&#39;)</code>跟<code>(&#39;b&#39;, &#39;a&#39;)</code>其实是一样的(最终只会输出其中一个)。</p>
<p>在计算组合的时候，一旦元素被选取就会从候选中剔除掉(比如如果元素’a’已经被选取了，那么接下来就不会再考虑它了)。而函数<code>itertools.combinations_with_replacement()</code>允许同一个元素被选择多次<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations_with_replacement(items, <span class="number">3</span>):</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="序列上索引值迭代">序列上索引值迭代</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>my_list = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> idx, val <span class="keyword">in</span> enumerate(my_list):</span><br><span class="line"><span class="prompt">... </span>    print(idx, val)</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span> a</span><br><span class="line"><span class="number">1</span> b</span><br><span class="line"><span class="number">2</span> c</span><br></pre></td></tr></table></figure>
<p>为了按传统行号输出(行号从1开始)，你可以传递一个开始参数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>my_list = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> idx, val <span class="keyword">in</span> enumerate(my_list, <span class="number">1</span>):</span><br><span class="line"><span class="prompt">... </span>    print(idx, val)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> a</span><br><span class="line"><span class="number">2</span> b</span><br><span class="line"><span class="number">3</span> c</span><br></pre></td></tr></table></figure></p>
<p><code>enumerate()</code>对于跟踪某些值在列表中出现的位置是很有用的。 所以，如果你想将一个文件中出现的单词映射到它出现的行号上去，可以很容易的利用<code>enumerate()</code>来完成<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">word_summary = defaultdict(list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'myfile.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx, line <span class="keyword">in</span> enumerate(lines):</span><br><span class="line">    <span class="comment"># Create a list of words in current line</span></span><br><span class="line">    words = [w.strip().lower() <span class="keyword">for</span> w <span class="keyword">in</span> line.split()]</span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">        word_summary[word].append(idx)</span><br></pre></td></tr></table></figure></p>
<p>如果你处理完文件后打印 <code>word_summary</code>，会发现它是一个字典(准确来讲是一个<code>defaultdict</code>)，对于每个单词有一个<code>key</code>，每个<code>key</code>对应的值是一个由这个单词出现的行号组成的列表。如果某个单词在一行中出现过两次，那么这个行号也会出现两次，同时也可以作为文本的一个简单统计。</p>
<p><code>enumerate()</code>函数返回的是一个<code>enumerate</code>对象实例，它是一个迭代器，返回连续的包含一个计数和一个值的元组，元组中的值通过在传入序列上调用<code>next()</code>返回。</p>
<p>还有一点可能并不很重要，但是也值得注意，有时候当你在一个已经解压后的元组序列上使用<code>enumerate()</code>函数时很容易调入陷阱。你得像下面正确的方式这样写：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data = [ (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">3</span>, <span class="number">4</span>), (<span class="number">5</span>, <span class="number">6</span>), (<span class="number">7</span>, <span class="number">8</span>) ]</span><br><span class="line"><span class="comment"># Correct!</span></span><br><span class="line"><span class="keyword">for</span> n, (x, y) <span class="keyword">in</span> enumerate(data):</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># Error!</span></span><br><span class="line"><span class="keyword">for</span> n, x, y <span class="keyword">in</span> enumerate(data):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<h4 id="同时迭代多个序列">同时迭代多个序列</h4><p>为了同时迭代多个序列，使用<code>zip()</code>函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>xpts = [<span class="number">1</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">7</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>ypts = [<span class="number">101</span>, <span class="number">78</span>, <span class="number">37</span>, <span class="number">15</span>, <span class="number">62</span>, <span class="number">99</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> x, y <span class="keyword">in</span> zip(xpts, ypts):</span><br><span class="line"><span class="prompt">... </span>    print(x,y)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> <span class="number">101</span></span><br><span class="line"><span class="number">5</span> <span class="number">78</span></span><br><span class="line"><span class="number">4</span> <span class="number">37</span></span><br><span class="line"><span class="number">2</span> <span class="number">15</span></span><br><span class="line"><span class="number">10</span> <span class="number">62</span></span><br><span class="line"><span class="number">7</span> <span class="number">99</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p><code>zip(a, b)</code>会生成一个可返回元组<code>(x, y)</code>的迭代器，其中<code>x</code>来自<code>a</code>，<code>y</code>来自<code>b</code>。一旦其中某个序列到底结尾，迭代宣告结束。因此迭代长度跟参数中最短序列长度一致。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = [<span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> zip(a,b):</span><br><span class="line"><span class="prompt">... </span>    print(i)</span><br><span class="line">...</span><br><span class="line">(<span class="number">1</span>, <span class="string">'w'</span>)</span><br><span class="line">(<span class="number">2</span>, <span class="string">'x'</span>)</span><br><span class="line">(<span class="number">3</span>, <span class="string">'y'</span>)</span><br></pre></td></tr></table></figure></p>
<p>如果这个不是你想要的效果，那么还可以使用<code>itertools.zip_longest()</code>函数来代替。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> zip_longest</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> zip_longest(a,b):</span><br><span class="line"><span class="prompt">... </span>    print(i)</span><br><span class="line">...</span><br><span class="line">(<span class="number">1</span>, <span class="string">'w'</span>)</span><br><span class="line">(<span class="number">2</span>, <span class="string">'x'</span>)</span><br><span class="line">(<span class="number">3</span>, <span class="string">'y'</span>)</span><br><span class="line">(<span class="keyword">None</span>, <span class="string">'z'</span>)</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> zip_longest(a, b, fillvalue=<span class="number">0</span>):</span><br><span class="line"><span class="prompt">... </span>    print(i)</span><br><span class="line">...</span><br><span class="line">(<span class="number">1</span>, <span class="string">'w'</span>)</span><br><span class="line">(<span class="number">2</span>, <span class="string">'x'</span>)</span><br><span class="line">(<span class="number">3</span>, <span class="string">'y'</span>)</span><br><span class="line">(<span class="number">0</span>, <span class="string">'z'</span>)</span><br></pre></td></tr></table></figure></p>
<p>最后强调一点就是，<code>zip()</code>会创建一个迭代器来作为结果返回。如果你需要将结对的值存储在列表中，要使用<code>list()</code>函数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>zip(a, b)</span><br><span class="line">&lt;zip object at <span class="number">0x1007001b8</span>&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>list(zip(a, b))</span><br><span class="line">[(<span class="number">1</span>, <span class="number">10</span>), (<span class="number">2</span>, <span class="number">11</span>), (<span class="number">3</span>, <span class="number">12</span>)]</span><br></pre></td></tr></table></figure></p>
<h4 id="不同集合上元素的迭代">不同集合上元素的迭代</h4><p>当可迭代对象类型不一样的时候<code>chain()</code>同样可以很好的工作，它接受一个可迭代对象列表作为输入，并返回一个迭代器，有效的屏蔽掉在多个容器中迭代细节。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> chain(a, b):</span><br><span class="line"><span class="prompt">... </span>print(x)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">x</span><br><span class="line">y</span><br><span class="line">z</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="展开嵌套的序列">展开嵌套的序列</h4><p>可以写一个包含<code>yield from</code>语句的递归生成器来轻松解决这个问题<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Iterable</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(items, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> isinstance(x, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(x, ignore_types):</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> flatten(x)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line">items = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>]</span><br><span class="line"><span class="comment"># Produces 1 2 3 4 5 6 7 8</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</span><br><span class="line">    print(x)</span><br></pre></td></tr></table></figure></p>
<p>额外的参数<code>ignore_types</code>和检测语句<code>isinstance(x,ignore_types)</code>用来将字符串和字节排除在可迭代对象外，防止将它们再展开成单个的字符。这样的话字符串数组就能最终返回我们所期望的结果了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>items = [<span class="string">'Dave'</span>, <span class="string">'Paula'</span>, [<span class="string">'Thomas'</span>, <span class="string">'Lewis'</span>]]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> flatten(items):</span><br><span class="line"><span class="prompt">... </span>    print(x)</span><br><span class="line">...</span><br><span class="line">Dave</span><br><span class="line">Paula</span><br><span class="line">Thomas</span><br><span class="line">Lewis</span><br></pre></td></tr></table></figure></p>
<h4 id="顺序迭代合并后的排序迭代对象">顺序迭代合并后的排序迭代对象</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> heapq</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = [<span class="number">1</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">10</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = [<span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">11</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> heapq.merge(a, b):</span><br><span class="line"><span class="prompt">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span></span><br></pre></td></tr></table></figure>
<p><code>heapq.merge</code>可迭代特性意味着它不会立马读取所有序列。这就意味着你可以在非常长的序列中使用它，而不会有太大的开销。比如，下面是一个例子来演示如何合并两个排序文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'sorted_file_1'</span>, <span class="string">'rt'</span>) <span class="keyword">as</span> file1, \</span><br><span class="line">    open(<span class="string">'sorted_file_2'</span>, <span class="string">'rt'</span>) <span class="keyword">as</span> file2, \</span><br><span class="line">    open(<span class="string">'merged_file'</span>, <span class="string">'wt'</span>) <span class="keyword">as</span> outf:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> heapq.merge(file1, file2):</span><br><span class="line">        outf.write(line)</span><br></pre></td></tr></table></figure></p>
<p>有一点要强调的是<code>heapq.merge()</code>需要所有输入序列必须是排过序的。特别的，它并不会预先读取所有数据到堆栈中或者预先排序，也不会对输入做任何的排序检测。它仅仅是检查所有序列的开始部分并返回最小的那个，这个过程一直会持续直到所有输入序列中的元素都被遍历完。</p>
<p>参考资料<br>【1】<a href="http://code.google.com/p/proden/downloads/detail?name=A%20Byte%20of%20Python3(%E4%B8%AD%E6%96%87%E7%89%88).pdf" target="_blank" rel="external">A Byte of Python3</a><br>【2】<a href="http://python3-cookbook.readthedocs.org/zh_CN/latest/c01/p08_calculating_with_dict.html" target="_blank" rel="external">python3-cookbook</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/03/Python-implementation-of-the-longest-common-subsequences/" itemprop="url">
                  Python实现最长公共子序列-Longest Common Subsequences
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-03T22:34:40+08:00" content="2015-07-03">
              2015-07-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">Algorithms</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/03/Python-implementation-of-the-longest-common-subsequences/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/03/Python-implementation-of-the-longest-common-subsequences/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="定义">定义</h3><p>一个数列<strong>S</strong>，如果分别是两个或多个已知数列的子序列，且是所有符合此条件序列中最长的，则<strong>S</strong>称为已知序列的最长公共子序列。例如序列<code>X=ABCBDAB</code>，<code>Y=BDCABA</code>。序列<code>BCA</code>是X和Y的一个公共子序列，但是不是X和Y的最长公共子序列，子序列<code>BCBA</code>是X和Y的一个LCS。</p>
<h3 id="复杂度">复杂度</h3><p>对于一般性的LCS问题（即任意数量的序列）是属于<code>NP-hard</code>。但当序列的数量确定时，问题可以使用动态规划（Dynamic Programming）在多项式时间解决。</p>
<h3 id="解法">解法</h3><p>动态规划的一个计算最长公共子序列的方法如下，以两个序列$X=\langle x_1,x_2,…,x_m \rangle$、$Y=\langle y_1,y_2,…,y_n \rangle$为例子，LCS(X,Y)表示X和Y的一个最长公共子序列：<br>如果$ x_m = y_n $，则$ LCS(X,Y) = x_m + LCS(x_{m-1},y_{n-1}) $<br>如果$ x_m != y_n $，则$ LCS(X,Y) = max \lbrace LCS(x_{m-1},Y)，LCS(X,y_{n-1}) \rbrace $</p>
<p>为了找到最长的LCS，我们定义<code>dp[i][j]</code>记录LCS的长度，如果X的长度为0或者Y的长度为0，那么LCS=0，即<code>dp[i][j]=0</code>，用i和j分别表示到序列X和序列Y的长度，状态转移方程如下:</p>
<p>$$i=0||j=0，dp[i][j] = 0$$</p>
<p>$$X[i] = Y[j]，dp[i][j] = dp[i-1][j-1] + 1$$</p>
<p>$$X[i] != Y[j]，dp[i][j] = max \lbrace dp[i-1][j]，dp[i][j-1] \rbrace$$</p>
<h3 id="Python实现LCS">Python实现LCS</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">Longest Common Subsequences</span><br><span class="line">Created on 2015/7/2  15:11</span><br><span class="line">@author: Wang Xu</span><br><span class="line"></span><br><span class="line">"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCS</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lcs_base</span><span class="params">(self, input_x, input_y)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(input_x) == <span class="number">0</span> <span class="keyword">or</span> len(input_y) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            a = input_x[<span class="number">0</span>]</span><br><span class="line">            b = input_y[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> a == b:</span><br><span class="line">                <span class="keyword">return</span> self.lcs_base(input_x[<span class="number">1</span>:], input_y[<span class="number">1</span>:]) + a</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># get the max one</span></span><br><span class="line">                <span class="keyword">return</span> self.getMax(self.lcs_base(input_x[<span class="number">1</span>:], input_y), self.lcs_base(input_x, input_y[<span class="number">1</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># construct a list by the input string</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getList</span><span class="params">(self, inputStr)</span>:</span></span><br><span class="line">        listRes = list()</span><br><span class="line">        <span class="keyword">if</span> len(inputStr) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(inputStr)):</span><br><span class="line">                listRes.append(inputStr[i])</span><br><span class="line">        <span class="keyword">return</span> listRes</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return the max one between a and b, equivalently return the longest one</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMax</span><span class="params">(self, a, b)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(a) &gt;= len(b):</span><br><span class="line">            <span class="keyword">return</span> a</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    lcs = LCS()</span><br><span class="line">    l1 = lcs.getList(<span class="string">'我的大中国'</span>)</span><br><span class="line">    l2 = lcs.getList(<span class="string">'大中国我的'</span>)</span><br><span class="line"></span><br><span class="line">    l3 = lcs.lcs_base(l1, l2)</span><br><span class="line">    print(l3[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    l3 = lcs.lcs_base(l2, l1)</span><br><span class="line">    print(l3[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    l1 = <span class="string">'1233433236676'</span></span><br><span class="line">    l2 = <span class="string">'98723765655423'</span></span><br><span class="line">    l3 = lcs.lcs_base(l1, l2)</span><br><span class="line">    print(l3[::-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    l1 = <span class="string">'123s212346我的大中国啊33z'</span></span><br><span class="line">    l2 = <span class="string">'33z的大中国'</span></span><br><span class="line">    l3 = lcs.lcs_base(l1, l2)</span><br><span class="line">    print(l3[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>该算法的空间、时间复杂度均为$O(n^{2})$，经过优化后，空间复杂度可为$O(n)$。</p>
<h3 id="LCS变体-最长公共子串">LCS变体-最长公共子串</h3><p>最长公共子串与最长公共子序列稍有区别，不过也算是<code>LCS</code>的一个变体，在<code>LCS</code>中，子序列是不必要求连续的，而子串则是“连续”的。<br>题：给定两个字符串<code>X</code>，<code>Y</code>，求二者最长的公共子串，例如<code>X=[aaaba]</code>，<code>Y=[ababaa]</code>。二者的最长公共子串为<code>[aba]</code>，长度为3。</p>
<h4 id="基本算法">基本算法</h4><p>将X的每个子串与Y的每个子串做对比，求出最长公共子串<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span><br><span class="line">Created on 2015/7/2  16:13</span><br><span class="line">@author: Wang Xu</span><br><span class="line">"""</span></span><br><span class="line"><span class="comment"># 使用基本算法获取最长公共子串（连续），最长公共子序列可以是非连续的</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getcomlen</span><span class="params">(firststr, secondstr)</span>:</span></span><br><span class="line">    comlen = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> firststr <span class="keyword">and</span> secondstr:</span><br><span class="line">        <span class="keyword">if</span> firststr[<span class="number">0</span>] == secondstr[<span class="number">0</span>]:</span><br><span class="line">            comlen += <span class="number">1</span></span><br><span class="line">            firststr = firststr[<span class="number">1</span>:]</span><br><span class="line">            secondstr = secondstr[<span class="number">1</span>:]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> comlen</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lcs_base</span><span class="params">(input_x, input_y)</span>:</span></span><br><span class="line">    max_common_len = <span class="number">0</span></span><br><span class="line">    common_index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> xtemp <span class="keyword">in</span> range(<span class="number">0</span>, len(input_x)):</span><br><span class="line">        <span class="keyword">for</span> ytemp <span class="keyword">in</span> range(<span class="number">0</span>, len(input_y)):</span><br><span class="line">            com_temp = getcomlen(input_x[xtemp: len(input_x)], input_y[ytemp: len(input_y)])</span><br><span class="line">            <span class="keyword">if</span> com_temp &gt; max_common_len:</span><br><span class="line">                max_common_len = com_temp</span><br><span class="line">                common_index = xtemp</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'公共子串的长度是：%s'</span> % max_common_len)</span><br><span class="line">    print(<span class="string">'最长公共子串是：%s'</span> % input_x[common_index:common_index + max_common_len])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    lcs_base(<span class="string">'d11zabcdeabdcdbbcd'</span>, <span class="string">'bbcd11yabcdefaaa'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span><br><span class="line">OutPut:</span><br><span class="line">公共子串的长度是：5</span><br><span class="line">最长公共子串是：abcde</span><br><span class="line">'''</span></span><br></pre></td></tr></table></figure></p>
<h4 id="DP算法">DP算法</h4><p>使用动态规划来解最长公共子串问题，可以考虑如何将<code>arr[0,...,i]</code>的问题转化为求解<code>arr[0,...,i-1]</code>的问题，此处考虑使用<code>dp[i][j]</code>表示以<code>X[i]</code>和<code>Y[j]</code>结尾的最长公共子串的长度，因为要求子串连续，所以对于<code>X[i]</code>和<code>Y[j]</code>来讲，它们要么与之前的公共子串构成新的公共子串；要么就是不构成公共子串；状态转移方程为</p>
<p>$$X[i] = Y[j]，dp[i][j] = dp[i-1][j-1] + 1$$</p>
<p>$$X[i] != Y[j]，dp[i][j] = 0$$</p>
<p>对于初始化，<code>i=0</code>或者<code>j=0</code>，如果<code>X[i] == Y[j]</code>，<code>dp[i][j] = 1</code>；否则<code>dp[i][j] = 0</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LCS3</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lcs_dp</span><span class="params">(self, input_x, input_y)</span>:</span></span><br><span class="line">        <span class="comment"># input_y as column, input_x as row</span></span><br><span class="line">        dp = [([<span class="number">0</span>] * len(input_y)) <span class="keyword">for</span> i <span class="keyword">in</span> range(len(input_x))]</span><br><span class="line">        maxlen = maxindex = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(input_x)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, len(input_y)):</span><br><span class="line">                <span class="keyword">if</span> input_x[i] == input_y[j]:</span><br><span class="line">                    <span class="keyword">if</span> i!=<span class="number">0</span> <span class="keyword">and</span> j!=<span class="number">0</span>:</span><br><span class="line">                        dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> i == <span class="number">0</span> <span class="keyword">or</span> j == <span class="number">0</span>:</span><br><span class="line">                        dp[i][j] = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> dp[i][j] &gt; maxlen:</span><br><span class="line">                        maxlen = dp[i][j]</span><br><span class="line">                        maxindex = i + <span class="number">1</span> - maxlen</span><br><span class="line">                        <span class="comment"># print('最长公共子串的长度是:%s' % maxlen)</span></span><br><span class="line">                        <span class="comment"># print('最长公共子串是:%s' % input_x[maxindex:maxindex + maxlen])</span></span><br><span class="line">        <span class="keyword">return</span> input_x[maxindex:maxindex + maxlen]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    lcs3 = LCS3()</span><br><span class="line">    print(lcs3.lcs_dp(<span class="string">'我是美abc国中defg国中间人'</span>, <span class="string">'abdde我是美中国中国中国人'</span>))</span><br><span class="line">    print(lcs3.lcs_dp(<span class="string">'cabdec'</span>,<span class="string">'cbdec'</span>))</span><br></pre></td></tr></table></figure>
<p>参考资料<br>【1】<a href="http://www.ahathinking.com/archives/115.html" target="_blank" rel="external">http://www.ahathinking.com/archives/115.html</a><br>【2】<a href="http://dsqiu.iteye.com/blog/1701541" target="_blank" rel="external">http://dsqiu.iteye.com/blog/1701541</a><br>【3】<a href="http://www.ahathinking.com/archives/122.html" target="_blank" rel="external">http://www.ahathinking.com/archives/122.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/07/02/Python3-beginner-s-handbook-one/" itemprop="url">
                  Python3入门手册之一
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-02T21:41:03+08:00" content="2015-07-02">
              2015-07-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/02/Python3-beginner-s-handbook-one/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/02/Python3-beginner-s-handbook-one/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><em>Version：Python 3.4.3 (v3.4.3:9b73f1c3e601, Feb 24 2015, 22:44:40) [MSC v.1600 64 bit (AMD64)] on win32</em></p>
<p><strong>There are two ways of constructing a software design: one way is to make it so simple that there are obviously no deficiences; the other is to make it so complicated that there are no obvious deficiences.</strong><br>—- C.A.R.Hoare</p>
<p><strong>Success in life is a matter not so much of talent and opportunity as of concentration and perseverance</strong><br>—- C.W.Wendte</p>
<h3 id="选择Python的原因">选择Python的原因</h3><ul>
<li>简单易学，功能强大，具有高效的高层数据结构，支持面向对象编程</li>
<li>解释性语言，可扩展性，可嵌入性，丰富的库</li>
</ul>
<h3 id="选择一个编辑器">选择一个编辑器</h3><p>工欲善其事必先利其器，所以选择编辑器首当其冲。</p>
<ul>
<li>IDLE：Python自带，极简利器，支持语法高亮</li>
<li>Vim/Emacs：<code>Linux/FreeBSD</code>平台上的开发利器，二者择其一</li>
<li>PyCharm：号称最智能的Python编辑器，的确是的，但是略微复杂</li>
</ul>
<h3 id="数据结构和算法">数据结构和算法</h3><h4 id="解压序列赋值给多个变量">解压序列赋值给多个变量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 变量的数量需要和序列元素的数量一致</span></span><br><span class="line">data = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</span><br><span class="line">a, b, c, d = data</span><br><span class="line">print(a, b, c, d)</span><br><span class="line"></span><br><span class="line">data = [<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>, (<span class="number">2012</span>, <span class="number">12</span>, <span class="number">21</span>)]</span><br><span class="line">name, shares, price, (year, month, day) = data</span><br><span class="line">print(year, month, day)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压一部分，其他值丢弃</span></span><br><span class="line">data = [<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>, (<span class="number">2012</span>, <span class="number">12</span>, <span class="number">21</span>)]</span><br><span class="line">_, shares, price, _ = data</span><br><span class="line">print(shares, price)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只取第一个和最后一个，中间的所有元素用通配符接收</span></span><br><span class="line">record = (<span class="string">'Dave'</span>, <span class="string">'dave@example.com'</span>, <span class="string">'773-555-1212'</span>, <span class="string">'847-555-1212'</span>)</span><br><span class="line">name, *_, phone = record</span><br><span class="line">print(name, phone)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span><br><span class="line">OutPut:</span><br><span class="line">a b c d</span><br><span class="line">2012 12 21</span><br><span class="line">50 91.1</span><br><span class="line">Dave 847-555-1212</span><br><span class="line">'''</span></span><br></pre></td></tr></table></figure>
<h4 id="查找最大或最小的N个元素">查找最大或最小的N个元素</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> heapq</span><br><span class="line"></span><br><span class="line">nums = [<span class="number">1</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">23</span>, <span class="number">7</span>, -<span class="number">4</span>, <span class="number">18</span>, <span class="number">23</span>, <span class="number">42</span>, <span class="number">37</span>, <span class="number">2</span>]</span><br><span class="line">print(heapq.nlargest(<span class="number">3</span>, nums))  <span class="comment"># Prints [42, 37, 23]</span></span><br><span class="line">print(heapq.nsmallest(<span class="number">3</span>, nums))  <span class="comment"># Prints [-4, 1, 2]</span></span><br><span class="line"><span class="comment"># heapify会先将集合数据进行堆排序后放入一个列表中</span></span><br><span class="line"><span class="comment"># heappop会先将第一个元素弹出来，然后用下一个最小的元素来取代被弹出元素</span></span><br><span class="line">heapq.heapify(nums)</span><br><span class="line">print(heapq.heappop(nums))  <span class="comment"># Prints -4</span></span><br><span class="line">print(heapq.heappop(nums))  <span class="comment"># Prints 1</span></span><br><span class="line">print(heapq.heappop(nums))  <span class="comment"># Prints 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面代码在对每个元素进行对比的时候，会以price的值进行比较。</span></span><br><span class="line">portfolio = [</span><br><span class="line">    &#123;<span class="string">'name'</span>: <span class="string">'IBM'</span>, <span class="string">'shares'</span>: <span class="number">100</span>, <span class="string">'price'</span>: <span class="number">91.1</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>: <span class="string">'AAPL'</span>, <span class="string">'shares'</span>: <span class="number">50</span>, <span class="string">'price'</span>: <span class="number">543.22</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>: <span class="string">'FB'</span>, <span class="string">'shares'</span>: <span class="number">200</span>, <span class="string">'price'</span>: <span class="number">21.09</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>: <span class="string">'HPQ'</span>, <span class="string">'shares'</span>: <span class="number">35</span>, <span class="string">'price'</span>: <span class="number">31.75</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>: <span class="string">'YHOO'</span>, <span class="string">'shares'</span>: <span class="number">45</span>, <span class="string">'price'</span>: <span class="number">16.35</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>: <span class="string">'ACME'</span>, <span class="string">'shares'</span>: <span class="number">75</span>, <span class="string">'price'</span>: <span class="number">115.65</span>&#125;</span><br><span class="line">]</span><br><span class="line">cheap = heapq.nsmallest(<span class="number">3</span>, portfolio, key=<span class="keyword">lambda</span> s: s[<span class="string">'price'</span>])</span><br><span class="line">expensive = heapq.nlargest(<span class="number">3</span>, portfolio, key=<span class="keyword">lambda</span> s: s[<span class="string">'price'</span>])</span><br><span class="line">print(cheap)</span><br><span class="line">print(expensive)</span><br></pre></td></tr></table></figure>
<h4 id="字典操作相关">字典操作相关</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 求字典中值的最小值、最大值</span></span><br><span class="line">prices = &#123;</span><br><span class="line">    <span class="string">'ACME'</span>: <span class="number">45.23</span>,</span><br><span class="line">    <span class="string">'AAPL'</span>: <span class="number">612.78</span>,</span><br><span class="line">    <span class="string">'IBM'</span>: <span class="number">205.55</span>,</span><br><span class="line">    <span class="string">'HPQ'</span>: <span class="number">37.20</span>,</span><br><span class="line">    <span class="string">'FB'</span>: <span class="number">10.75</span></span><br><span class="line">&#125;</span><br><span class="line">min_price = min(zip(prices.values(), prices.keys()))</span><br><span class="line"><span class="comment"># min_price is (10.75, 'FB')</span></span><br><span class="line">max_price = max(zip(prices.values(), prices.keys()))</span><br><span class="line"><span class="comment"># max_price is (612.78, 'AAPL')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以使用sorted()和zip()函数来排列字典数据</span></span><br><span class="line">prices_sorted = sorted(zip(prices.values(), prices.keys()))</span><br><span class="line"><span class="comment"># prices_sorted is [(10.75, 'FB'), (37.2, 'HPQ'),</span></span><br><span class="line"><span class="comment">#                   (45.23, 'ACME'), (205.55, 'IBM'),</span></span><br><span class="line"><span class="comment">#                   (612.78, 'AAPL')]</span></span><br><span class="line"><span class="comment"># 执行这些计算的时候，需要注意的是zip()函数创建的是一个只能访问一次的迭代器。 比如，下面的代码就会产生错误：</span></span><br><span class="line">prices_and_names = zip(prices.values(), prices.keys())</span><br><span class="line">print(min(prices_and_names))  <span class="comment"># OK</span></span><br><span class="line">print(max(prices_and_names))  <span class="comment"># ValueError: max() arg is an empty sequence</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要注意的是在计算操作中使用到了(值，键)对。当多个实体拥有相同的值的时候，键会决定返回结果。 比如，在执行min()和max()操作的时候，如果恰巧最小或最大值有重复的，那么拥有最小或最大键的实体会返回：</span></span><br><span class="line">prices = &#123;<span class="string">'AAA'</span>: <span class="number">45.23</span>, <span class="string">'ZZZ'</span>: <span class="number">45.23</span>&#125;</span><br><span class="line">min(zip(prices.values(), prices.keys()))</span><br><span class="line"><span class="comment"># OutPut:(45.23, 'AAA')</span></span><br><span class="line">max(zip(prices.values(), prices.keys()))</span><br><span class="line"><span class="comment"># OutPut:(45.23, 'ZZZ')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找两字典的相同点</span></span><br><span class="line">a = &#123;</span><br><span class="line">    <span class="string">'x'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'y'</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">'z'</span>: <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b = &#123;</span><br><span class="line">    <span class="string">'w'</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="string">'x'</span>: <span class="number">11</span>,</span><br><span class="line">    <span class="string">'y'</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># Find keys in common</span></span><br><span class="line">a.keys() &amp; b.keys()  <span class="comment"># &#123; 'x', 'y' &#125;</span></span><br><span class="line"><span class="comment"># Find keys in a that are not in b</span></span><br><span class="line">a.keys() - b.keys()  <span class="comment"># &#123; 'z' &#125;</span></span><br><span class="line"><span class="comment"># Find (key,value) pairs in common</span></span><br><span class="line">a.items() &amp; b.items()  <span class="comment"># &#123; ('y', 2) &#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="序列中出现次数最多的元素">序列中出现次数最多的元素</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">words = [</span><br><span class="line">    <span class="string">'look'</span>, <span class="string">'into'</span>, <span class="string">'my'</span>, <span class="string">'eyes'</span>, <span class="string">'look'</span>, <span class="string">'into'</span>, <span class="string">'my'</span>, <span class="string">'eyes'</span>,</span><br><span class="line">    <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'not'</span>, <span class="string">'around'</span>, <span class="string">'the'</span>,</span><br><span class="line">    <span class="string">'eyes'</span>, <span class="string">"don't"</span>, <span class="string">'look'</span>, <span class="string">'around'</span>, <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'look'</span>, <span class="string">'into'</span>,</span><br><span class="line">    <span class="string">'my'</span>, <span class="string">'eyes'</span>, <span class="string">"you're"</span>, <span class="string">'under'</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line">word_counts = Counter(words)</span><br><span class="line"><span class="comment"># 出现频率最高的3个单词</span></span><br><span class="line">top_three = word_counts.most_common(<span class="number">3</span>)</span><br><span class="line">print(top_three)</span><br><span class="line"><span class="comment"># Outputs [('eyes', 8), ('the', 5), ('look', 4)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Counter 对象可以接受任意的 hashable 序列对象。 在底层实现上，一个 Counter 对象就是一个字典，将元素映射到它出现的次数上</span></span><br><span class="line">print(word_counts[<span class="string">'not'</span>])  <span class="comment"># Prints 1</span></span><br><span class="line">print(word_counts[<span class="string">'eyes'</span>])  <span class="comment"># Prints 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意，对于Counter对象可以直接进行数学运算操作</span></span><br><span class="line">test = Counter([<span class="string">'addone'</span>])</span><br><span class="line">word_counts = word_counts + test</span><br><span class="line">print(word_counts)</span><br><span class="line">word_counts = word_counts - test</span><br><span class="line">print(word_counts)</span><br></pre></td></tr></table></figure>
<h4 id="通过某个关键字排序一个字典列表">通过某个关键字排序一个字典列表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过某个关键字排序一个字典列表</span></span><br><span class="line">rows = [</span><br><span class="line">    &#123;<span class="string">'fname'</span>: <span class="string">'Brian'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1003</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'fname'</span>: <span class="string">'David'</span>, <span class="string">'lname'</span>: <span class="string">'Beazley'</span>, <span class="string">'uid'</span>: <span class="number">1002</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'fname'</span>: <span class="string">'John'</span>, <span class="string">'lname'</span>: <span class="string">'Cleese'</span>, <span class="string">'uid'</span>: <span class="number">1001</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'fname'</span>: <span class="string">'Big'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1004</span>&#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 根据任意的字典字段来排序输入结果行是很容易实现的，代码示例：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"></span><br><span class="line">rows_by_fname = sorted(rows, key=itemgetter(<span class="string">'fname'</span>))</span><br><span class="line">rows_by_uid = sorted(rows, key=itemgetter(<span class="string">'uid'</span>))</span><br><span class="line">print(rows_by_fname)</span><br><span class="line">print(rows_by_uid)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排序不支持原生比较的对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, userId)</span>:</span></span><br><span class="line">        self.userId = userId</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'User(&#123;&#125;)'</span>.format(self.userId)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> attrgetter</span><br><span class="line"></span><br><span class="line">users = [User(<span class="number">23</span>), User(<span class="number">28</span>), User(<span class="number">26</span>)]</span><br><span class="line">print(sorted(users, key=attrgetter(<span class="string">'userId'</span>)))</span><br></pre></td></tr></table></figure>
<h4 id="通过某个字段将记录分组">通过某个字段将记录分组</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">rows = [</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'5412 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/01/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'5148 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/04/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'5800 E 58TH'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'2122 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/03/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'5645 N RAVENSWOOD'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'1060 W ADDISON'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'4801 N BROADWAY'</span>, <span class="string">'date'</span>: <span class="string">'07/01/2012'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'address'</span>: <span class="string">'1039 W GRANVILLE'</span>, <span class="string">'date'</span>: <span class="string">'07/04/2012'</span>&#125;,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 现在假设你想在按date分组后的数据块上进行迭代。为了这样做，你首先需要按照指定的字段(这里就是date)排序， 然后调用 itertools.groupby() 函数：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> groupby</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sort by the desired field first</span></span><br><span class="line">rows.sort(key=itemgetter(<span class="string">'date'</span>))</span><br><span class="line"><span class="comment"># Iterate in groups</span></span><br><span class="line"><span class="keyword">for</span> date, items <span class="keyword">in</span> groupby(rows, key=itemgetter(<span class="string">'date'</span>)):</span><br><span class="line">    print(date)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> items:</span><br><span class="line">        print(<span class="string">' '</span>, i)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span><br><span class="line">OutPut:</span><br><span class="line">07/01/2012</span><br><span class="line">  &#123;'date': '07/01/2012', 'address': '5412 N CLARK'&#125;</span><br><span class="line">  &#123;'date': '07/01/2012', 'address': '4801 N BROADWAY'&#125;</span><br><span class="line">07/02/2012</span><br><span class="line">  &#123;'date': '07/02/2012', 'address': '5800 E 58TH'&#125;</span><br><span class="line">  &#123;'date': '07/02/2012', 'address': '5645 N RAVENSWOOD'&#125;</span><br><span class="line">  &#123;'date': '07/02/2012', 'address': '1060 W ADDISON'&#125;</span><br><span class="line">07/03/2012</span><br><span class="line">  &#123;'date': '07/03/2012', 'address': '2122 N CLARK'&#125;</span><br><span class="line">07/04/2012</span><br><span class="line">  &#123;'date': '07/04/2012', 'address': '5148 N CLARK'&#125;</span><br><span class="line">  &#123;'date': '07/04/2012', 'address': '1039 W GRANVILLE'&#125;</span><br><span class="line">'''</span></span><br></pre></td></tr></table></figure>
<h4 id="过滤序列元素">过滤序列元素</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">values = [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'-3'</span>, <span class="string">'-'</span>, <span class="string">'4'</span>, <span class="string">'N/A'</span>, <span class="string">'5'</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_int</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        x = int(val)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">ivals = list(filter(is_int, values))</span><br><span class="line">print(ivals)</span><br><span class="line"><span class="comment"># Outputs ['1', '2', '-3', '4', '5']</span></span><br></pre></td></tr></table></figure>
<h4 id="转换并同时计算数据">转换并同时计算数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Determine if any .py files exist in a directory</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">files = os.listdir(<span class="string">'dirname'</span>)</span><br><span class="line"><span class="keyword">if</span> any(name.endswith(<span class="string">'.py'</span>) <span class="keyword">for</span> name <span class="keyword">in</span> files):</span><br><span class="line">    print(<span class="string">'There be python!'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Sorry, no python.'</span>)</span><br><span class="line"><span class="comment"># Output a tuple as CSV</span></span><br><span class="line">s = (<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">123.45</span>)</span><br><span class="line">print(<span class="string">','</span>.join(str(x) <span class="keyword">for</span> x <span class="keyword">in</span> s)) <span class="comment"># Prints ACME,50,123.45</span></span><br><span class="line"><span class="comment"># Data reduction across fields of a data structure</span></span><br><span class="line">portfolio = [</span><br><span class="line">    &#123;<span class="string">'name'</span>:<span class="string">'GOOG'</span>, <span class="string">'shares'</span>: <span class="number">50</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>:<span class="string">'YHOO'</span>, <span class="string">'shares'</span>: <span class="number">75</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>:<span class="string">'AOL'</span>, <span class="string">'shares'</span>: <span class="number">20</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'name'</span>:<span class="string">'SCOX'</span>, <span class="string">'shares'</span>: <span class="number">65</span>&#125;</span><br><span class="line">]</span><br><span class="line">min_shares = min(s[<span class="string">'shares'</span>] <span class="keyword">for</span> s <span class="keyword">in</span> portfolio)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Original: Returns 20</span></span><br><span class="line">min_shares = min(s[<span class="string">'shares'</span>] <span class="keyword">for</span> s <span class="keyword">in</span> portfolio)</span><br><span class="line"><span class="comment"># Alternative: Returns &#123;'name': 'AOL', 'shares': 20&#125;</span></span><br><span class="line">min_shares = min(portfolio, key=<span class="keyword">lambda</span> s: s[<span class="string">'shares'</span>])</span><br></pre></td></tr></table></figure>
<h4 id="合并多个字典或映射">合并多个字典或映射</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="string">'x'</span>: <span class="number">1</span>, <span class="string">'z'</span>: <span class="number">3</span> &#125;</span><br><span class="line">b = &#123;<span class="string">'y'</span>: <span class="number">2</span>, <span class="string">'z'</span>: <span class="number">4</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> ChainMap</span><br><span class="line">c = ChainMap(a,b)</span><br><span class="line">print(c[<span class="string">'x'</span>]) <span class="comment"># Outputs 1 (from a)</span></span><br><span class="line">print(c[<span class="string">'y'</span>]) <span class="comment"># Outputs 2 (from b)</span></span><br><span class="line">print(c[<span class="string">'z'</span>]) <span class="comment"># Outputs 3 (from a)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ChianMap使用原来的字典，它自己不创建新的字典。所以它并不会产生上面所说的结果，比如：</span></span><br><span class="line"></span><br><span class="line">a[<span class="string">'x'</span>] = <span class="number">42</span></span><br><span class="line">print(c[<span class="string">'x'</span>]) <span class="comment"># Outputs 42 (from a)</span></span><br></pre></td></tr></table></figure>
<h3 id="字符串和文本">字符串和文本</h3><h4 id="使用多个界定符分割字符串">使用多个界定符分割字符串</h4><p><code>string</code>对象的<code>split()</code>方法只适应于非常简单的字符串分割情形，它并不允许有多个分隔符或者是分隔符周围不确定的空格。当你需要更加灵活的切割字符串的时候，最好使用<code>re.split()</code>方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">line = <span class="string">'abcd efg; hijk , lmn'</span></span><br><span class="line">res = re.split(<span class="string">r'[;,\s]\s*'</span>, line)</span><br><span class="line">print(res) <span class="comment"># Prints ['abcd', 'efg', 'hijk', '', 'lmn']</span></span><br></pre></td></tr></table></figure></p>
<p>函数<code>re.split()</code>是非常实用的，因为它允许你为分隔符指定多个正则模式。比如，在上面的例子中，分隔符可以是逗号(,)，分号(;)或者是空格，并且后面紧跟着任意个的空格。只要这个模式被找到，那么匹配的分隔符两边的实体都会被当成是结果中的元素返回。 返回结果为一个字段列表，这个跟<code>str.split()</code>返回值类型是一样的。<br>当你使用<code>re.split()</code>函数时候，需要特别注意的是正则表达式中是否包含一个括号捕获分组。如果使用了捕获分组，那么被匹配的文本也将出现在结果列表中。比如，观察一下这段代码运行后的结果。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fields = re.split(<span class="string">r'(;|,|\s)\s*'</span>, line)</span><br><span class="line">print(fields) <span class="comment"># Prints ['abcd', ' ', 'efg', ';', 'hijk', ' ', '', ',', 'lmn']</span></span><br></pre></td></tr></table></figure></p>
<p>如果你不想保留分割字符串到结果列表中去，但仍然需要使用到括号来分组正则表达式的话，确保你的分组是非捕获分组，形如<code>(?:...)</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res = re.split(<span class="string">r'(?:,|;|\s)\s*'</span>, line)</span><br><span class="line">print(res) <span class="comment"># Prints ['abcd', 'efg', 'hijk', '', 'lmn']</span></span><br></pre></td></tr></table></figure></p>
<h4 id="字符串匹配">字符串匹配</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查多种匹配可能，需要将所有的匹配项放入到一个元组中，然后传给startswith()或者endswith()方法</span></span><br><span class="line">strs = list()</span><br><span class="line">strs.append(<span class="string">'a.txt'</span>)</span><br><span class="line">strs.append(<span class="string">'b.doc'</span>)</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> strs:</span><br><span class="line">    <span class="comment"># startswith方法类似</span></span><br><span class="line">    <span class="keyword">if</span> s.endswith((<span class="string">'.txt'</span>, <span class="string">'.doc'</span>)):</span><br><span class="line">        print(str(s))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请注意，该方法必须接收一个元组作为输入参数，如果你有一个list或者set类型的选择项，需要先调用tuple()将其转换为元组类型</span></span><br><span class="line">choices = [<span class="string">'.txt'</span>, <span class="string">'.doc'</span>]</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> strs:</span><br><span class="line">    <span class="keyword">if</span> s.endswith(tuple(choices)):</span><br><span class="line">        print(str(s))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fnmatch和fnmatchcase的使用</span></span><br><span class="line"><span class="keyword">from</span> fnmatch <span class="keyword">import</span> fnmatch, fnmatchcase</span><br><span class="line"></span><br><span class="line">print(fnmatch(<span class="string">'foo.txt'</span>, <span class="string">'*.TXT'</span>))  <span class="comment"># On OS X (Mac) Prints False</span></span><br><span class="line">print(fnmatch(<span class="string">'foo.txt'</span>, <span class="string">'*.TXT'</span>))  <span class="comment"># On Windows Prints True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 完全使用你的模式大小写进行匹配</span></span><br><span class="line">print(fnmatchcase(<span class="string">'foo.txt'</span>, <span class="string">'*.TXT'</span>))  <span class="comment"># Prints False</span></span><br></pre></td></tr></table></figure>
<h4 id="字符串搜索和替换">字符串搜索和替换</h4><p>一个替换回调函数的参数是一个<code>match</code>对象，也就是<code>match()</code>或者<code>find()</code>返回的对象。使用<code>group()</code>方法来提取特定的匹配部分。回调函数最后返回替换字符串。如果除了替换后的结果外，你还想知道有多少替换发生了，可以使用<code>re.subn()</code>来代替。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用re模块进行匹配和搜索</span></span><br><span class="line">text = <span class="string">'Today is 11/27/2012. PyCon starts 3/13/2013.'</span></span><br><span class="line">datepat = re.compile(<span class="string">r'(\d+)/(\d+)/(\d+)'</span>)</span><br><span class="line">list_match = datepat.findall(text)  <span class="comment"># findall方法返回的是所有匹配的列表</span></span><br><span class="line">print(list_match)</span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> datepat.finditer(text):  <span class="comment"># finditer方法返回的是迭代器</span></span><br><span class="line">    print(m.groups())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意点，在正则的开头字母‘r’是指定不去解析反斜杠</span></span><br><span class="line"><span class="comment"># r'(\d+)/(\d+)/(\d+)' 相当于 '(\\d+)/(\\d+)/(\\d+)'</span></span><br><span class="line">m = datepat.match(<span class="string">'11/27/2012'</span>)</span><br><span class="line">print(m.group(<span class="number">0</span>))  <span class="comment"># Prints 11/27/2012</span></span><br><span class="line">print(m.group(<span class="number">1</span>))  <span class="comment"># Prints 11</span></span><br><span class="line">print(m.group(<span class="number">2</span>))  <span class="comment"># Prints 27</span></span><br><span class="line">print(m.group(<span class="number">3</span>))  <span class="comment"># Prints 2012</span></span><br><span class="line"></span><br><span class="line">newtext, n = datepat.subn(<span class="string">r'\3-\1-\2'</span>, text)</span><br><span class="line">print(newtext)  <span class="comment"># Prints Today is 2012-11-27. PyCon starts 2013-3-13.</span></span><br><span class="line">print(n)  <span class="comment"># Prints 2</span></span><br></pre></td></tr></table></figure></p>
<p>为了在文本操作时忽略大小写，你需要在使用re模块的时候给这些操作提供<code>re.IGNORECASE</code>标志参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">'UPPER PYTHON, lower python, Mixed Python'</span></span><br><span class="line">re.findall(<span class="string">'python'</span>, text, flags=re.IGNORECASE) <span class="comment"># ['PYTHON', 'python', 'Python']</span></span><br><span class="line">re.sub(<span class="string">'python'</span>, <span class="string">'snake'</span>, text, flags=re.IGNORECASE) <span class="comment"># 'UPPER snake, lower snake, Mixed snake'</span></span><br></pre></td></tr></table></figure></p>
<h4 id="最短匹配模式">最短匹配模式</h4><p>在这个例子中，模式<code>r&#39;\&quot;(.*)\&quot;&#39;</code>的意图是匹配被双引号包含的文本。但是在正则表达式中*操作符是贪婪的，因此匹配操作会查找最长的可能匹配。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">str_pat = re.compile(<span class="string">r'\"(.*)\"'</span>)</span><br><span class="line">text = <span class="string">'Computer says "no." Phone says "yes."'</span></span><br><span class="line">str_pat.findall(text)  <span class="comment"># ['no." Phone says "yes.']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果希望获取最短匹配的结果，需要添加'?'</span></span><br><span class="line">str_pat = re.compile(<span class="string">r'\"(.*?)\"'</span>)</span><br><span class="line">str_pat.findall(text)  <span class="comment"># ['no.', 'yes.']</span></span><br></pre></td></tr></table></figure></p>
<p>这样就使得匹配变成非贪婪模式，从而得到最短的匹配，也就是我们想要的结果。</p>
<h4 id="多行匹配模式">多行匹配模式</h4><p>这个问题很典型的出现在当你用点(.)去匹配任意字符的时候，忘记了点(.)不能匹配换行符的事实。为了修正这个问题，你可以修改模式字符串，增加对换行的支持。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">'''/* this is a</span><br><span class="line">multiline comment */</span><br><span class="line">'''</span></span><br><span class="line">comment = re.compile(<span class="string">r'/\*((?:.|\n)*?)\*/'</span>)</span><br><span class="line">com = comment.findall(text)</span><br><span class="line">print(com)  <span class="comment"># Prints [' this is a\nmultiline comment ']</span></span><br></pre></td></tr></table></figure></p>
<p>在这个模式中，<code>(?:.|\n)</code> 指定了一个非捕获组(也就是它定义了一个仅仅用来做匹配，而不能通过单独捕获或者编号的组)。<br><code>re.compile()</code>函数接受一个标志参数叫 <code>re.DOTALL</code>，在这里非常有用。它可以让正则表达式中的.匹配包括换行符在内的任意字符。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">comment = re.compile(<span class="string">r'/\*(.*?)\*/'</span>, re.DOTALL)</span><br><span class="line">com = comment.findall(text)</span><br><span class="line">print(com)  <span class="comment"># Prints [' this is a\nmultiline comment ']</span></span><br></pre></td></tr></table></figure></p>
<h4 id="删除字符串中不需要的字符">删除字符串中不需要的字符</h4><p><code>strip()</code>方法能用于删除开始或结尾的字符。<code>lstrip()</code>和<code>rstrip()</code>分别从左和从右执行删除操作。默认情况下，这些方法会去除空白字符，但是你也可以指定其他字符。<br>如果你想处理中间的空格，那么你需要求助其他技术。比如使用<code>replace()</code>方法或者是用正则表达式替换。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">s = <span class="string">'Hello        World!'</span></span><br><span class="line">m = re.sub(<span class="string">'\s+'</span>, <span class="string">' '</span>, s)</span><br><span class="line">print(m) <span class="comment"># Prints Hello World!</span></span><br></pre></td></tr></table></figure></p>
<h4 id="字符串对齐">字符串对齐</h4><p>对于基本的字符串对齐操作，可以使用字符串的<code>ljust()</code>,<code>rjust()</code>和<code>center()</code>方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">'Hello World!'</span></span><br><span class="line">text = text.ljust(<span class="number">20</span>)</span><br><span class="line">print(text)  <span class="comment"># Hello World!</span></span><br><span class="line">print(len(text))  <span class="comment"># 20</span></span><br><span class="line"></span><br><span class="line">text = <span class="string">'Hello World!'</span></span><br><span class="line">text = text.rjust(<span class="number">20</span>)</span><br><span class="line">print(text)  <span class="comment">#      Hello World!</span></span><br><span class="line">print(len(text))  <span class="comment"># 20</span></span><br></pre></td></tr></table></figure></p>
<p>所有这些方法都能接受一个可选的填充字符。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">'Hello World!'</span></span><br><span class="line">print(text.rjust(<span class="number">20</span>, <span class="string">'='</span>))</span><br><span class="line">print(text.center(<span class="number">20</span>, <span class="string">'*'</span>))</span><br><span class="line"><span class="comment"># 当格式化多个值的时候，这些格式代码也可以被用在 format() 方法中</span></span><br><span class="line">print(<span class="string">'&#123;:+&gt;10s&#125; &#123;:-&gt;10s&#125;'</span>.format(<span class="string">'Hello'</span>, <span class="string">'World'</span>)) <span class="comment"># Prints +++++Hello -----World</span></span><br></pre></td></tr></table></figure></p>
<h4 id="字符串中插入变量">字符串中插入变量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">'&#123;name&#125; has &#123;n&#125; messages.'</span></span><br><span class="line">print(s.format(name=<span class="string">'Guido'</span>, n=<span class="number">37</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果要被替换的变量能在变量域中找到，那么你可以结合使用format_map()和vars() 。就像下面这样：</span></span><br><span class="line">s = <span class="string">'&#123;name&#125; has &#123;n&#125; messages.'</span></span><br><span class="line">name = <span class="string">'Guido'</span></span><br><span class="line">n = <span class="number">37</span></span><br><span class="line">print(s.format_map(vars()))</span><br></pre></td></tr></table></figure>
<h4 id="以指定列宽格式化字符串">以指定列宽格式化字符串</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import textwrap</span><br><span class="line">&gt;&gt;&gt; print(textwrap.fill(s, 70))</span><br><span class="line">Look into my eyes, look into my eyes, the eyes, the eyes, the eyes,</span><br><span class="line">not around the eyes, don't look around the eyes, look into my eyes,</span><br><span class="line">you're under.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; print(textwrap.fill(s, 40))</span><br><span class="line">Look into my eyes, look into my eyes,</span><br><span class="line">the eyes, the eyes, the eyes, not around</span><br><span class="line">the eyes, don't look around the eyes,</span><br><span class="line">look into my eyes, you're under.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; print(textwrap.fill(s, 40, initial_indent='    '))</span><br><span class="line">    Look into my eyes, look into my</span><br><span class="line">eyes, the eyes, the eyes, the eyes, not</span><br><span class="line">around the eyes, don't look around the</span><br><span class="line">eyes, look into my eyes, you're under.</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; print(textwrap.fill(s, 40, subsequent_indent='    '))</span><br><span class="line">Look into my eyes, look into my eyes,</span><br><span class="line">    the eyes, the eyes, the eyes, not</span><br><span class="line">    around the eyes, don't look around</span><br><span class="line">    the eyes, look into my eyes, you're</span><br><span class="line">    under.</span><br></pre></td></tr></table></figure>
<h4 id="在字符串中处理html和xml">在字符串中处理html和xml</h4><p>如果你想替换文本字符串中的<code>‘&lt;’</code>或者<code>‘&gt;’</code>，使用html.escape()函数可以很容易的完成。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = <span class="string">'Elements are written as "&lt;tag&gt;text&lt;/tag&gt;".'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">import</span> html</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(s)</span><br><span class="line">Elements are written <span class="keyword">as</span> <span class="string">"&lt;tag&gt;text&lt;/tag&gt;"</span>.</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(html.escape(s))</span><br><span class="line">Elements are written <span class="keyword">as</span> <span class="string">"&lt;tag&gt;text&lt;/tag&gt;"</span>.</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="comment"># Disable escaping of quotes</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(html.escape(s, quote=<span class="keyword">False</span>))</span><br><span class="line">Elements are written <span class="keyword">as</span> <span class="string">"&lt;tag&gt;text&lt;/tag&gt;"</span>.</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果你接收到了一些含有编码值的原始文本，需要手动去做替换，通常你只需要使用<code>HTML</code>或者<code>XML</code>解析器的一些相关工具函数/方法即可。比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = <span class="string">'Spicy "Jalape&amp;#241;o&amp;quot.'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>p = HTMLParser()</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>p.unescape(s)</span><br><span class="line"><span class="string">'Spicy "Jalapeño".'</span></span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>t = <span class="string">'The prompt is &gt;&gt;&gt;'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.sax.saxutils <span class="keyword">import</span> unescape</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>unescape(t)</span><br><span class="line"><span class="string">'The prompt is &gt;&gt;&gt;'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="字节字符串上的字符串操作">字节字符串上的字符串操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data = <span class="string">b'Hello World'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line"><span class="string">b'Hello'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data.startswith(<span class="string">b'Hello'</span>)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data.split()</span><br><span class="line">[<span class="string">b'Hello'</span>, <span class="string">b'World'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data.replace(<span class="string">b'Hello'</span>, <span class="string">b'Hello Cruel'</span>)</span><br><span class="line"><span class="string">b'Hello Cruel World'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>这些操作同样也适用于字节数组。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data = bytearray(<span class="string">b'Hello World'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line">bytearray(<span class="string">b'Hello'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data.startswith(<span class="string">b'Hello'</span>)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data.split()</span><br><span class="line">[bytearray(<span class="string">b'Hello'</span>), bytearray(<span class="string">b'World'</span>)]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>data.replace(<span class="string">b'Hello'</span>, <span class="string">b'Hello Cruel'</span>)</span><br><span class="line">bytearray(<span class="string">b'Hello Cruel World'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>大多数情况下，在文本字符串上的操作均可用于字节字符串。然而，这里也有一些需要注意的不同点。首先，字节字符串的索引操作返回整数而不是单独字符。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a = <span class="string">'Hello World'</span> <span class="comment"># Text string</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a[<span class="number">0</span>]</span><br><span class="line"><span class="string">'H'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>a[<span class="number">1</span>]</span><br><span class="line"><span class="string">'e'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b = <span class="string">b'Hello World'</span> <span class="comment"># Byte string</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b[<span class="number">0</span>]</span><br><span class="line"><span class="number">72</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>b[<span class="number">1</span>]</span><br><span class="line"><span class="number">101</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>第二点，字节字符串不会提供一个美观的字符串表示，也不能很好的打印出来，除非它们先被解码为一个文本字符串。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>s = <span class="string">b'Hello World'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(s)</span><br><span class="line"><span class="string">b'Hello World'</span> <span class="comment"># Observe b'...'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(s.decode(<span class="string">'ascii'</span>))</span><br><span class="line">Hello World</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>参考资料<br>【1】<a href="http://code.google.com/p/proden/downloads/detail?name=A%20Byte%20of%20Python3(%E4%B8%AD%E6%96%87%E7%89%88).pdf" target="_blank" rel="external">A Byte of Python3</a><br>【2】<a href="http://python3-cookbook.readthedocs.org/zh_CN/latest/c01/p08_calculating_with_dict.html" target="_blank" rel="external">python3-cookbook</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/22/CentOS-7-1-switch-in-command-line-mode-and-desktop-mode/" itemprop="url">
                  CentOS 7.1 切换命令行模式与桌面模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-06-22T19:37:06+08:00" content="2015-06-22">
              2015-06-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Operating-System/" itemprop="url" rel="index">
                    <span itemprop="name">Operating System</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/22/CentOS-7-1-switch-in-command-line-mode-and-desktop-mode/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/22/CentOS-7-1-switch-in-command-line-mode-and-desktop-mode/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先你需要知道自己的Linux版本信息，下面介绍一些常用的查看Linux系统版本的命令</p>
<ol>
<li><p>查看内核版本命令，以下三个命令任选</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@localhost ~]$ cat /proc/version</span><br><span class="line">Linux version <span class="number">3.10</span>.<span class="number">0</span>-<span class="number">229</span>.el7.x86_64 (builder@kbuilder.dev.centos.org) (gcc version <span class="number">4.8</span>.<span class="number">2</span> <span class="number">20140120</span> (Red Hat <span class="number">4.8</span>.<span class="number">2</span>-<span class="number">16</span>) (GCC) ) <span class="comment">#1 SMP Fri Mar 6 11:36:42 UTC 2015</span></span><br><span class="line"></span><br><span class="line">[hadoop@localhost ~]$ uname <span class="operator">-a</span></span><br><span class="line">Linux localhost.localdomain <span class="number">3.10</span>.<span class="number">0</span>-<span class="number">229</span>.el7.x86_64 <span class="comment">#1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line">[hadoop@localhost ~]$ uname -r</span><br><span class="line"><span class="number">3.10</span>.<span class="number">0</span>-<span class="number">229</span>.el7.x86_64</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看linux版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@localhost ~]$ cat /etc/redhat-release </span><br><span class="line">CentOS Linux release <span class="number">7.1</span>.<span class="number">1503</span> (Core)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>那么知道了版本之后如何修改默认启动时进入命令行还是桌面环境呢？在<code>CentOS7.x</code>之前的版本都是通过修改<code>/etc/inittab</code>文件来设置启动顺序，具体可参考<a href="http://www.habadog.com/2012/03/03/centos-model-switch/" target="_blank" rel="external">这里</a>。但是此种方法并不适应于<code>CentOS7.x</code>版本，在该版本中，我们查看<code>/etc/inittab</code>文件可得<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@localhost ~]$ vim /etc/inittab</span><br><span class="line"><span class="comment"># inittab is no longer used when using systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ADDING CONFIGURATION HERE WILL HAVE NO EFFECT ON YOUR SYSTEM.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Ctrl-Alt-Delete is handled by /usr/lib/systemd/system/ctrl-alt-del.target</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># systemd uses 'targets' instead of runlevels. By default, there are two main targets:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># multi-user.target: analogous to runlevel 3</span></span><br><span class="line"><span class="comment"># graphical.target: analogous to runlevel 5</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To view current default target, run:</span></span><br><span class="line"><span class="comment"># systemctl get-default</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To set a default target, run:</span></span><br><span class="line"><span class="comment"># systemctl set-default TARGET.target</span></span><br></pre></td></tr></table></figure></p>
<p>该文件中已经详细说明了，不再使用inittab文件而是使用systemd代替，并且还指出，现在只有<code>multi-user</code>相当于运行级别是3和<code>graphical</code>相当于运行级别是5，现在可以使用如下命令设置默认启动级别了，注意要以root用户，或者是使用sudo权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost hadoop]<span class="comment"># systemctl set-default multi-user.target</span></span><br><span class="line">rm <span class="string">'/etc/systemd/system/default.target'</span></span><br><span class="line">ln <span class="operator">-s</span> <span class="string">'/usr/lib/systemd/system/multi-user.target'</span> <span class="string">'/etc/systemd/system/default.target'</span></span><br><span class="line">[root@localhost hadoop]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>设置成功之后reboot一下，即可顺利进入命令行界面了，如果想要再次进入图形界面，在命令行中运行<code>startx</code>即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/21/Basic-knowledge-summary-of-Spring/" itemprop="url">
                  Spring基础知识汇总
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-06-21T11:57:22+08:00" content="2015-06-21">
              2015-06-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/21/Basic-knowledge-summary-of-Spring/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/21/Basic-knowledge-summary-of-Spring/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><em>力求用最简洁的文字表述最全面的知识，本Blog不适合零基础人员</em></strong><br><img src="http://7xig3q.com1.z0.glb.clouddn.com/spring-logo.png" alt="logo"></p>
<h3 id="Spring简介">Spring简介</h3><p>Spring框架由Rod Johnson开发，<a href="https://twitter.com/springrod" target="_blank" rel="external">Rod Johnson’s twitter</a>，<a href="http://baike.baidu.com/view/2192255.htm" target="_blank" rel="external">Rod Johnson’s 百度百科</a>，2004年发布了Spring框架的第一版。Spring是一个从实际开发中抽取出来的框架，因此它完成了大量开发中的通用步骤，留给开发者的仅仅是与特定应用相关的部分，从而大大提高了企业应用的开发效率。</p>
<p>Spring总结起来优点如下</p>
<ul>
<li>低侵入式设计，代码的污染极低</li>
<li>独立于各种应用服务器，基于Spring框架的应用，可以真正实现Write Once，Run Anywhere的承诺</li>
<li>Spring的IoC容器降低了业务对象替换的复杂性，提高了组件之间的解耦</li>
<li>Spring的AOP支持允许将一些通用任务如安全、事务、日志等进行集中式管理，从而提供了更好的复用</li>
<li>Spring的ORM和DAO提供了与第三方持久层框架的良好整合，并简化了底层的数据库访问</li>
<li>Spring的高度开放性，并不强制应用完全依赖于Spring，开发者可自由选用Spring框架的部分或全部</li>
</ul>
<p>Spring框架的组成结构图如下所示<br><img src="http://7xig3q.com1.z0.glb.clouddn.com/spring-overview-architecture.png" alt="spring-overview"></p>
<h3 id="Spring的核心机制">Spring的核心机制</h3><h4 id="管理Bean">管理Bean</h4><p>程序主要是通过Spring容器来访问容器中的Bean，ApplicationContext是Spring容器最常用的接口，该接口有如下两个实现类</p>
<ul>
<li>ClassPathXmlApplicationContext: 从类加载路径下搜索配置文件，并根据配置文件来创建Spring容器</li>
<li>FileSystemXmlApplicationContext: 从文件系统的相对路径或绝对路径下去搜索配置文件，并根据配置文件来创建Spring容器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanTest</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"beans.xml"</span>);</span><br><span class="line">        Person p = ctx.getBean(<span class="string">"person"</span>, Person.class);</span><br><span class="line">        p.say();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Eclipse使用Spring">Eclipse使用Spring</h4><p>在Eclipse等IDE工具中，用户可以自建<code>User Library</code>，然后把Spring的Jar包都放入其中，当然也可以将Jar包直接放在项目的<code>/WEB-INF/lib</code>目录下，但是如果使用<code>User Library</code>，在项目发布时，需要将用户库所引用的Jar文件随应用一起发布，就是将User Library所使用的Jar复制到<code>/WEB-INF/lib</code>目录下，这是因为对于一个Web应用，Eclipse部署Web应用时不会将用户库的Jar文件复制到<code>/WEB-INF/lib</code>下，需要手动复制。</p>
<h4 id="依赖注入">依赖注入</h4><p>Spring框架的核心功能有两个</p>
<ul>
<li>Spring容器作为超级大工厂，负责创建、管理所有的Java对象，这些Java对象被称为Bean</li>
<li>Spring容器管理容器中Bean之间的依赖关系，Spring使用一种被称为“依赖注入”的方式来管理Bean之间的依赖关系</li>
</ul>
<p>使用依赖注入，不仅可以为Bean注入普通的属性值，还可以注入其他Bean的引用。依赖注入是一种优秀的解耦方式，其可以让Bean以配置文件组织在一起，而不是以硬编码的方式耦合在一起。</p>
<h5 id="理解依赖注入">理解依赖注入</h5><p>Rod Johnson是第一个高度重视以配置文件来管理Java实例的协作关系的人，他给这种方式起了一个名字：控制反转（Inverse of Control，IoC）。后来Martine Fowler为这种方式起了另一个名称：依赖注入（Dependency Injection），因此不管是依赖注入，还是控制反转，其含义完全相同。当某个Java对象（调用者）需要调用另一个Java对象（被依赖对象）的方法时，在传统模式下通常有两种做法</p>
<ol>
<li>原始做法: 调用者<strong>主动</strong>创建被依赖对象，然后再调用被依赖对象的方法</li>
<li>简单工厂模式: 调用者先找到被依赖对象的工厂，然后<strong>主动</strong>通过工厂去获取被依赖对象，最后再调用被依赖对象的方法</li>
</ol>
<p>注意上面的<strong>主动</strong>二字，这必然会导致调用者与被依赖对象实现类的硬编码耦合，非常不利于项目升级的维护。使用Spring框架之后，调用者无需<strong>主动</strong>获取被依赖对象，调用者只要<strong>被动</strong>接受Spring容器为调用者的成员变量赋值即可，由此可见，使用Spring后，调用者获取被依赖对象的方式由原来的主动获取，变成了被动接受——所以Rod Johnson称之为控制反转。</p>
<p>另外从Spring容器的角度来看，Spring容器负责将被依赖对象赋值给调用者的成员变量——相当于为调用者注入它依赖的实例，因此Martine Fowler称之为依赖注入。</p>
<h5 id="设值注入">设值注入</h5><p>设值注入是指IoC容器通过成员变量的setter方法来注入被依赖对象。这种注入方式简单、直观，因而在Spring的依赖注入里大量使用。</p>
<h5 id="构造注入">构造注入</h5><p>利用构造器来设置依赖关系的方式，被称为构造注入。通俗来说，就是驱动Spring在底层以反射方式执行带指定参数的构造器，当执行带参数的构造器时，就可利用构造器参数对成员变量执行初始化——这就是构造注入的本质。</p>
<h5 id="两种注入方式的对比">两种注入方式的对比</h5><p>设值注入有如下优点</p>
<ul>
<li>与传统的JavaBean的写法更相似，程序开发人员更容易理解、接受。通过setter方法设定依赖关系显得更加直观、自然</li>
<li>对于复杂的依赖关系，如果采用构造注入，会导致构造器过于臃肿，难以阅读。Spring在创建Bean实例时，需要同时实例化其依赖的全部实例，因而导致性能下降。而使用设值注入，则能避免这些问题。</li>
<li>尤其在某些成员变量可选的情况下，多参数的构造器更加笨重</li>
</ul>
<p>构造注入优势如下</p>
<ul>
<li>构造注入可以在构造器中决定依赖关系的注入顺序，优先依赖的优先注入</li>
<li>对于依赖关系无需变化的Bean，构造注入更有用处。因为没有setter方法，所有的依赖关系全部在构造器内设定，无须担心后续的代码对依赖关系产生破坏</li>
<li>依赖关系只能在构造器中设定，则只有组件的创建者才能改变组件的依赖关系，对组件的调用者而言，组件内部的依赖关系完全透明，更符合高内聚的原则</li>
</ul>
<p><strong><em>Notes</em></strong><br>建议采用设值注入为主，构造注入为辅的注入策略。对于依赖关系无须变化的注入，尽量采用构造注入；而其他依赖关系的注入，则考虑采用设值注入。</p>
<h4 id="Spring容器中的Bean">Spring容器中的Bean</h4><p>对于开发者来说，开发者使用Spring框架主要是做两件事：①开发Bean；②配置Bean。对于Spring框架来说，它要做的就是根据配置文件来创建Bean实例，并调用Bean实例的方法完成“依赖注入”——这就是所谓IoC的本质。</p>
<h5 id="容器中Bean的作用域">容器中Bean的作用域</h5><p>当通过Spring容器创建一个Bean实例时，不仅可以完成Bean实例的实例化，还可以为Bean指定特定的作用域。Spring支持如下五种作用域</p>
<ol>
<li>singleton: 单例模式，在整个Spring IoC容器中，singleton作用域的Bean将只生成一个实例</li>
<li>prototype: 每次通过容器的getBean()方法获取prototype作用域的Bean时，都将产生一个新的Bean实例</li>
<li>request: 对于一次HTTP请求，request作用域的Bean将只生成一个实例，这意味着，在同一次HTTP请求内，程序每次请求该Bean，得到的总是同一个实例。只有在Web应用中使用Spring时，该作用域才真正有效</li>
<li>对于一次HTTP会话，session作用域的Bean将只生成一个实例，这意味着，在同一次HTTP会话内，程序每次请求该Bean，得到的总是同一个实例。只有在Web应用中使用Spring时，该作用域才真正有效</li>
<li>global session: 每个全局的HTTP Session对应一个Bean实例。在典型的情况下，仅在使用portlet context的时候有效，同样只在Web应用中有效</li>
</ol>
<p>如果不指定Bean的作用域，Spring默认使用singleton作用域。prototype作用域的Bean的创建、销毁代价比较大。而singleton作用域的Bean实例一旦创建成果，就可以重复使用。因此，应该尽量避免将Bean设置成prototype作用域。</p>
<h4 id="使用自动装配注入合作者Bean">使用自动装配注入合作者Bean</h4><p>Spring能自动装配Bean与Bean之间的依赖关系，即无须使用ref显式指定依赖Bean，而是由Spring容器检查XML配置文件内容，根据某种规则，为调用者Bean注入被依赖的Bean。<br>Spring自动装配可通过<code>&lt;beans/&gt;</code>元素的<code>default-autowire</code>属性指定，该属性对配置文件中所有的Bean起作用；也可通过对<code>&lt;bean/&gt;</code>元素的<code>autowire</code>属性指定，该属性只对该Bean起作用。</p>
<p><code>autowire</code>和<code>default-autowire</code>可以接受如下值</p>
<ul>
<li><code>no</code>: 不使用自动装配。Bean依赖必须通过ref元素定义。这是默认配置，在较大的部署环境中不鼓励改变这个配置，显式配置合作者能够得到更清晰的依赖关系</li>
<li><code>byName</code>: 根据setter方法名进行自动装配。Spring容器查找容器中全部Bean，找出其id与setter方法名去掉set前缀，并小写首字母后同名的Bean来完成注入。如果没有找到匹配的Bean实例，则Spring不会进行任何注入</li>
<li><code>byType</code>: 根据setter方法的形参类型来自动装配。Spring容器查找容器中的全部Bean，如果正好有一个Bean类型与setter方法的形参类型匹配，就自动注入这个Bean；如果找到多个这样的Bean，就抛出一个异常；如果没有找到这样的Bean，则什么都不会发生，setter方法不会被调用</li>
<li><code>constructor</code>: 与byType类似，区别是用于自动匹配构造器的参数。如果容器不能恰好找到一个与构造器参数类型匹配的Bean，则会抛出一个异常</li>
<li><code>autodetect</code>: Spring容器根据Bean内部结构，自行决定使用constructor或byType策略。如果找到一个默认的构造函数，那么就会应用byType策略</li>
</ul>
<p><strong><em>当一个Bean既使用自动装配依赖，又使用ref显式指定依赖时，则显式指定的依赖覆盖自动装配依赖；对于大型的应用，不鼓励使用自动装配。虽然使用自动装配可减少配置文件的工作量，但大大将死了依赖关系的清晰性和透明性。依赖关系的装配依赖于源文件的属性名和属性类型，导致Bean与Bean之间的耦合降低到代码层次，不利于高层次解耦</em></strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--通过设置可以将Bean排除在自动装配之外--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">""</span> <span class="attribute">autowire-candidate</span>=<span class="value">"false"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--除此之外，还可以在beans元素中指定，支持模式字符串，如下所有以abc结尾的Bean都被排除在自动装配之外--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">beans</span> <span class="attribute">default-autowire-candidates</span>=<span class="value">"*abc"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建Bean的3种方式">创建Bean的3种方式</h3><h4 id="使用构造器创建Bean实例">使用构造器创建Bean实例</h4><p>使用构造器来创建Bean实例是最常见的情况，如果不采用构造注入，Spring底层会调用Bean类的无参数构造器来创建实例，因此要求该Bean类提供无参数的构造器。</p>
<p>采用默认的构造器创建Bean实例，Spring对Bean实例的所有属性执行默认初始化，即所有的基本类型的值初始化为0或false；所有的引用类型的值初始化为null。</p>
<h4 id="使用静态工厂方法创建Bean">使用静态工厂方法创建Bean</h4><p>使用静态工厂方法创建Bean实例时，class属性也必须指定，但此时class属性并不是指定Bean实例的实现类，而是静态工厂类，Spring通过该属性知道由哪个工厂类来创建Bean实例。</p>
<p>除此之外，还需要使用factory-method属性来指定静态工厂方法，Spring将调用静态工厂方法返回一个Bean实例，一旦获得了指定Bean实例，Spring后面的处理步骤与采用普通方法创建Bean实例完全一样。如果静态工厂方法需要参数，则使用<code>&lt;constructor-arg.../&gt;</code>元素指定静态工厂方法的参数。</p>
<h4 id="调用实例工厂方法创建Bean">调用实例工厂方法创建Bean</h4><p>实例工厂方法与静态工厂方法只有一个不同：调用静态工厂方法只需使用工厂类即可，而调用实例工厂方法则需要工厂实例。使用实例工厂方法时，配置Bean实例的<code>&lt;bean.../&gt;</code>元素无须class属性，配置实例工厂方法使用<code>factory-bean</code>指定工厂实例。<br>采用实例工厂方法创建Bean的<code>&lt;bean.../&gt;</code>元素时需要指定如下两个属性</p>
<ul>
<li>factory-bean: 该属性的值为工厂Bean的id</li>
<li>factory-method: 该属性指定实例工厂的工厂方法</li>
</ul>
<p>若调用实例工厂方法时需要传入参数，则使用<code>&lt;constructor-arg.../&gt;</code>元素确定参数值。</p>
<h3 id="协调作用域不同步的Bean">协调作用域不同步的Bean</h3><p>当singleton作用域的Bean依赖于prototype作用域的Bean时，会产生不同步的现象，原因是因为当Spring容器初始化时，容器会预初始化容器中所有的<code>singleton Bean</code>，由于<code>singleton Bean</code>依赖于<code>prototype Bean</code>，因此Spring在初始化<code>singleton Bean</code>之前，会先创建<code>prototypeBean</code>——然后才创建<code>singleton Bean</code>，接下里将<code>prototype Bean</code>注入<code>singleton Bean</code>。<br>解决不同步的方法有两种</p>
<ul>
<li>放弃依赖注入: singleton作用域的Bean每次需要prototype作用域的Bean时，主动向容器请求新的Bean实例，即可保证每次注入的<code>prototype Bean</code>实例都是最新的实例</li>
<li>利用方法注入: 方法注入通常使用lookup方法注入，使用lookup方法注入可以让Spring容器重写容器中Bean的抽象或具体方法，返回查找容器中其他Bean的结果，被查找的Bean通常是一个<code>non-singleton Bean</code>。Spring通过使用JDK动态代理或cglib库修改客户端的二进制码，从而实现上述要求</li>
</ul>
<p>建议采用第二种方法，使用方法注入。为了使用lookup方法注入，大致需要如下两步</p>
<ol>
<li>将调用者Bean的实现类定义为抽象类，并定义一个抽象方法来获取被依赖的Bean</li>
<li>在<code>&lt;bean.../&gt;</code>元素中添加<code>&lt;lookup-method.../&gt;</code>子元素让Spring为调用者Bean的实现类实现指定的抽象方法</li>
</ol>
<p><strong><em>Notes</em></strong></p>
<blockquote>
<p>Spring会采用运行时动态增强的方式来实现<code>&lt;lookup-method.../&gt;</code>元素所指定的抽象方法，如果目标抽象类实现过接口，Spring会采用JDK动态代理来实现该抽象类，并为之实现抽象方法；如果目标抽象类没有实现过接口，Spring会采用cglib实现该抽象类，并为之实现抽象方法。Spring4.0的spring-core-xxx.jar包中已经集成了cglib类库。</p>
</blockquote>
<h3 id="两种后处理器">两种后处理器</h3><p>Spring提供了两种常用的后处理器</p>
<ul>
<li>Bean后处理器: 这种后处理器会对容器中Bean进行后处理，对Bean进行额外加强</li>
<li>容器后处理器: 这种后处理器会对IoC容器进行后处理，用于增强容器功能</li>
</ul>
<h4 id="Bean后处理器">Bean后处理器</h4><p>Bean后处理器是一种特殊的Bean，这种特殊的Bean并不对外提供服务，它甚至可以无须id属性，它主要负责对容器中的其他Bean执行后处理，例如为容器中的目标Bean生成代理等，这种Bean称为Bean后处理器。Bean后处理器会在Bean实例创建成功之后，对Bean实例进行进一步的增强处理。Bean后处理器必须实现<code>BeanPostProcessor</code>接口，同时必须实现该接口的两个方法。</p>
<ol>
<li><code>Object postProcessBeforeInitialization(Object bean, String name) throws BeansException</code>: 该方法的第一个参数是系统即将进行后处理的Bean实例，第二个参数是该Bean的配置id</li>
<li><code>Object postProcessAfterinitialization(Object bean, String name) throws BeansException</code>: 该方法的第一个参数是系统即将进行后处理的Bean实例，第二个参数是该Bean的配置id</li>
</ol>
<p>容器中一旦注册了Bean后处理器，Bean后处理器就会自动启动，在容器中每个Bean创建时自动工作，Bean后处理器两个方法的回调时机如下图<br><img src="http://7xig3q.com1.z0.glb.clouddn.com/spring-bean-post-process.jpg" alt="bean-post-process"></p>
<p>注意一点，如果使用<code>BeanFactory</code>作为Spring容器，则必须手动注册Bean后处理器，程序必须获取Bean后处理器实例，然后手动注册。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BeanPostProcessor bp = (BeanPostProcessor)beanFactory.getBean(<span class="string">"bp"</span>);</span><br><span class="line">beanFactory.addBeanPostProcessor(bp);</span><br><span class="line">Person p = (Person)beanFactory.getBean(<span class="string">"person"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="容器后处理器">容器后处理器</h4><p>Bean后处理器负责处理容器中的所有Bean实例，而容器后处理器则负责处理容器本身。容器后处理器必须实现<code>BeanFactoryPostProcessor</code>接口，并实现该接口的一个方法<code>postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)</code>实现该方法的方法体就是对Spring容器进行的处理，这种处理可以对Spring容器进行自定义扩展，当然也可以对Spring容器不进行任何处理。</p>
<p>类似于<code>BeanPostProcessor</code>，<code>ApplicationContext</code>可自动检测到容器中的容器后处理器，并且自动注册容器后处理器。但若使用<code>BeanFactory</code>作为Spring容器，则必须手动调用该容器后处理器来处理<code>BeanFactory</code>容器。</p>
<h3 id="Spring的“零配置”支持">Spring的“零配置”支持</h3><h4 id="搜索Bean类">搜索Bean类</h4><p>Spring提供如下几个Annotation来标注Spring Bean</p>
<ul>
<li><code>@Component</code>: 标注一个普通的Spring Bean类</li>
<li><code>@Controller</code>: 标注一个控制器组件类</li>
<li><code>@Service</code>: 标注一个业务逻辑组件类</li>
<li><code>@Repository</code>: 标注一个DAO组件类</li>
</ul>
<p>在Spring配置文件中做如下配置，指定自动扫描的包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">context:component-scan</span> <span class="attribute">base-package</span>=<span class="value">"edu.shu.spring.domain"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="使用@Resource配置依赖">使用@Resource配置依赖</h4><p><code>@Resource</code>位于<code>javax.annotation</code>包下，是来自JavaEE规范的一个<code>Annotation</code>，Spring直接借鉴了该<code>Annotation</code>，通过使用该<code>Annotation</code>为目标Bean指定协作者Bean。使用<code>@Resource</code>与<code>&lt;property.../&gt;</code>元素的ref属性有相同的效果。<br><code>@Resource</code>不仅可以修饰setter方法，也可以直接修饰实例变量，如果使用<code>@Resource</code>修饰实例变量将会更加简单，此时Spring将会直接使用JavaEE规范的Field注入，此时连setter方法都可以不要。</p>
<h4 id="使用@PostConstruct和@PreDestroy定制生命周期行为">使用@PostConstruct和@PreDestroy定制生命周期行为</h4><p><code>@PostConstruct</code>和<code>@PreDestroy</code>同样位于javax.annotation包下，也是来自JavaEE规范的两个Annotation，Spring直接借鉴了它们，用于定制Spring容器中Bean的生命周期行为。它们都用于修饰方法，无须任何属性。其中前者修饰的方法时Bean的初始化方法；而后者修饰的方法时Bean销毁之前的方法。</p>
<h4 id="Spring4-0增强的自动装配和精确装配">Spring4.0增强的自动装配和精确装配</h4><p>Spring提供了<code>@Autowired</code>注解来指定自动装配，<code>@Autowired</code>可以修饰setter方法、普通方法、实例变量和构造器等。当使用<code>@Autowired</code>标注setter方法时，默认采用byType自动装配策略。在这种策略下，符合自动装配类型的候选Bean实例常常有多个，这个时候就可能引起异常，为了实现精确的自动装配，Spring提供了<code>@Qualifier</code>注解，通过使用<code>@Qualifier</code>，允许根据Bean的id来执行自动装配。</p>
<h3 id="Spring的AOP">Spring的AOP</h3><h4 id="为什么需要AOP">为什么需要AOP</h4><p>AOP（Aspect Orient Programming）也就是面向切面编程，作为面向对象编程的一种补充，已经成为一种比较成熟的编程方式。其实AOP问世的时间并不太长，AOP和OOP互为补充，面向切面编程将程序运行过程分解成各个切面。</p>
<p>AOP专门用于处理系统中分布于各个模块（不同方法）中的交叉关注点的问题，在JavaEE应用中，常常通过AOP来处理一些具有横切性质的系统级服务，如事务管理、安全检查、缓存、对象池管理等，AOP已经成为一种非常常用的解决方案。</p>
<h4 id="使用AspectJ实现AOP">使用AspectJ实现AOP</h4><p>AspectJ是一个基于Java语言的AOP框架，提供了强大的AOP功能，其他很多AOP框架都借鉴或采纳其中的一些思想。其主要包括两个部分：一个部分定义了如何表达、定义AOP编程中的语法规范，通过这套语法规范，可以方便地用AOP来解决Java语言中存在的交叉关注点的问题；另一个部分是工具部分，包括编译、调试工具等。</p>
<p>AOP实现可分为两类</p>
<ol>
<li>静态AOP实现: AOP框架在编译阶段对程序进行修改，即实现对目标类的增强，生成静态的AOP代理类，以AspectJ为代表</li>
<li>动态AOP实现: AOP框架在运行阶段动态生成AOP代理，以实现对目标对象的增强，以Spring AOP为代表</li>
</ol>
<p>一般来说，静态AOP实现具有较好的性能，但需要使用特殊的编译器。动态AOP实现是纯Java实现，因此无须特殊的编译器，但是通常性能略差。</p>
<h4 id="AOP的基本概念">AOP的基本概念</h4><p>关于面向切面编程的一些术语</p>
<ul>
<li>切面（Aspect）: 切面用于组织多个Advice，Advice放在切面中定义</li>
<li>连接点（Joinpoint）: 程序执行过程中明确的点，如方法的调用，或者异常的抛出。在Spring AOP中，连接点总是方法的调用</li>
<li>增强处理（Advice）: AOP框架在特定的切入点执行的增强处理。处理有“around”、“before”和“after”等类型</li>
<li>切入点（Pointcut）: 可以插入增强处理的连接点。简而言之，当某个连接点满足指定要求时，该连接点将被添加增强处理，该连接点也就变成了切入点</li>
</ul>
<h4 id="Spring的AOP支持">Spring的AOP支持</h4><p>Spring中的AOP代理由Spring的IoC容器负责生成、管理，其依赖关系也由IoC容器负责管理。<br>为了在应用中使用<code>@AspectJ</code>支持，Spring需要添加三个库</p>
<ul>
<li><code>aspectjweaver.jar</code></li>
<li><code>aspectjrt.jar</code></li>
<li><code>aopalliance.jar</code></li>
</ul>
<p>并在Spring配置文件中做如下配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--启动@AspectJ支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--指定自动搜索Bean组件、自动搜索切面类--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">context:component-scan</span> <span class="attribute">base-package</span>=<span class="value">"edu.shu.sprint.service"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">context:include-filter</span> <span class="attribute">type</span>=<span class="value">"annotation"</span> <span class="attribute">expression</span>=<span class="value">"org.aspectj.lang.annotation.Aspect"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>参考资料<br>【1】轻量级JavaEE企业应用实战-Struts2+Spring4+Hibernate整合开发</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/19/Basic-knowledge-summary-of-Hibernate/" itemprop="url">
                  Hibernate基础知识汇总
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-06-19T18:59:12+08:00" content="2015-06-19">
              2015-06-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/19/Basic-knowledge-summary-of-Hibernate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/19/Basic-knowledge-summary-of-Hibernate/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><em>力求用最简洁的文字表述最全面的知识，本Blog不适合零基础人员</em></strong></p>
<p><img src="http://7xig3q.com1.z0.glb.clouddn.com/hibernate-logo.gif" alt="logo"></p>
<h3 id="ORM简介">ORM简介</h3><p>ORM（Object/Relation Mapping），对象关系映射，ORM是一种规范，主要完成面向对象的编程语言到关系数据库的映射。<br>ORM框架是面向对象程序设计语言与关系数据库发展不同步时的中间解决方案。ORM工具的唯一作用就是：把对持久化对象的保存、删除、修改等操作，转换成对数据库的操作，从此，就可以以面向对象的方式操作持久化对象，而ORM框架则负责转换成对应的SQL操作。</p>
<h3 id="数据源简介">数据源简介</h3><p>数据源是一种提高数据库连接性能的常规手段，数据源会负责维持一个数据连接池，当程序创建数据源实例时，系统会一次性地创建多个数据库连接，并把这些数据库连接保存在连接池中。当程序需要进行数据库访问时，无需重新获得数据库连接，而是从连接池中取出一个空闲的数据库连接。当程序使用数据库连接访问数据库结束后，无需关闭数据库连接，而是将数据库连接归还给连接池即可。通过此种方式，可以避免频繁地获取数据库连接、关闭数据库连接所导致的性能下降。</p>
<h3 id="Hibernate体系结构">Hibernate体系结构</h3><p><strong>Hibernate的体系架构如下所示</strong></p>
<p><img src="http://7xig3q.com1.z0.glb.clouddn.com/hibernate-architecture.png" alt="architecture"></p>
<p>下面对上图中各对象逐一解释</p>
<ul>
<li>SessionFactory: 这是Hibernate的关键对象，它是单个数据库映射关系经过编译后的内存镜像，也是线程安全的。它是生成Session的工厂，本身需要依赖于ConnectionProvider。该对象可以在进程或集群的级别上，为那些事务之间可以重用的数据提供可选的二级缓存</li>
<li>Session: 它是应用程序与持久存储层直接交互的一个单线程对象。它也是Hibernate持久化操作的管家对象，所有的持久化对象必须在Session管理下才可以进行持久化操作。此对象生存期很短。它底层封装了JDBC连接，它也是Transaction的工厂 。Session对象持有必选的一级缓存，在显式执行flush之前，所有持久化操作的数据都在缓存中的Session对象处</li>
<li>PO（Persistent Object）: 系统创建的POJO实例，一旦与特定的Session关联，并对应数据表的指定记录，该对象就处于持久化状态，这一系列对象都被称为持久化对象。在程序中对持久化对象执行的修改，都将自动被转换为对持久层的修改。持久化对象完全可以是普通的JavaBeans/POJO，唯一的区别是它们正与一个Session关联</li>
<li>瞬态对象和脱管对象: 系统通过new关键字创建的Java实例，没有与Session关联，此时处于瞬态。瞬态实例可能是被应用程序实例化后，尚未进行持久化的对象。如果一个曾经持久化过的实例，如果Session被关闭则转为脱管状态</li>
<li>事务（Transaction）: 代表一次原子操作，它具有数据库事务的概念。Hibernate事务是对底层具体的JDBC、JTA以及CORBA事务的抽象。在某些情况下，一个Session之间可能包含多个Transaction对象。虽然事务操作是可选的，但所有持久化操作都应该在事务管理下进行，即使是只读操作</li>
<li>连接提供者（ConnectionProvider）: 它是生成JDBC连接的工厂，它通过抽象将应用程序与底层DataSource或DriverManager隔离开。这个对象无需应用程序直接访问，仅在应用程序需要扩展时使用</li>
<li>事务工厂（TransactionFactory）: 它是生成Transaction对象实例的工厂。该对象也无需应用程序直接访问。它负责对底层具体的事务实现进行封装，将底层具体的事务抽象成Hibernate事务</li>
</ul>
<h3 id="深入理解持久化对象">深入理解持久化对象</h3><h4 id="持久化类的要求">持久化类的要求</h4><ul>
<li>提供一个无参数的构造器: 所有的持久化类都应该提供一个无参数的构造器，这个构造器可以不采用public访问控制符。只要提供了无参数的构造器，Hibernate就可以使用Constructor.newInstance()来创建持久化类的实例了。通常构造器的访问控制修饰符至少是包可见的</li>
<li>提供一个标识属性: 标识属性通常映射数据库表的主键字段，对于基本类型，建议使用其对应的包装类型</li>
<li>为持久化类的每个成员变量提供setter和getter方法: Hibernate默认采用属性方式来访问持久化类的成员变量</li>
<li>使用非final的类: 在运行时生成代理是Hibernate的一个重要功能，如果非要使用一个有public final方法的类，则必须通过设置lazy=”false”来明确地禁用代理</li>
<li>重写equals()和hashCode()方法: 如果需要把持久化类的实例放入Set中，则应该为持久化类重写equals()和hashCode()方法</li>
</ul>
<h4 id="持久化类对象的状态">持久化类对象的状态</h4><p><img src="http://7xig3q.com1.z0.glb.clouddn.com/Hibernate-life-cycle.gif" alt="life-cycle"></p>
<p>在Hibernate中，PO（Persistent Object）有如下三种状态</p>
<ul>
<li>瞬态: 如果PO实例从未与Session关联过，该PO实例处于瞬态状态，瞬态对象不会被持久化到数据库中，也不会被赋予持久化标识</li>
<li>持久化: 如果PO实例与Session关联起来，且该实例对应到数据库记录，则该实例处于持久化状态</li>
<li>脱管: 如果PO实例曾经与Session关联过，但因为Session的关闭等原因，PO实例脱离了Session管理，这种状态为脱管状态，脱管对象的引用仍然有效，对象可继续被修改。如果重新让脱管对象与某个Session关联，这个脱管对象会重新转换为持久化状态，而脱管期间的改动不会丢失，也可被写入数据库</li>
</ul>
<h4 id="更改持久化对象状态的方法">更改持久化对象状态的方法</h4><p><strong>持久化实体</strong></p>
<ul>
<li>save(): 该方法返回持久化对象的标识属性值（即对应记录的主键值），执行save方法时会立即将持久化对象对应的数据插入数据库</li>
<li>persist(): 该方法保存持久化对象，没有任何返回值，当该方法在一个事务外部被调用时，并不立即转换成insert语句</li>
</ul>
<p><strong>加载持久化实体</strong></p>
<ul>
<li>load(): 该方法具有延迟加载功能，其不会立即访问数据库，当试图加载的记录不存在时，load方法可能返回一个未初始化的代理对象</li>
<li>get(): 该方法总是立即访问数据库，当试图加载的记录不存在时，get方法将直接返回null</li>
</ul>
<p><strong>更新持久化实体</strong><br>程序对持久化实例所做的修改会在Session flush之前被自动保存到数据库，无需程序调用其他方法来将其持久化。也就是说，修改对象最简单的方法就是在Session处于打开状态时load()它，然后直接修改即可。</p>
<p><strong>更新脱管实体</strong><br>当程序使用update()来保存程序对持久化对象所做的修改时，如果不清楚该对象是否曾经持久化过，那么程序可以选择使用updateOrSave()方法，该方法自动判断该对象是否曾经持久化过，如果曾经持久化过，就执行update()操作；否则执行save()操作。merge()方法不会持久化给定的对象，例如<code>session.merge(object)</code>代码后，object依然不是持久化状态，object依然不会被关联到session上，merge()方法会返回object对象的副本——该副本处于持久化状态。</p>
<p><strong>删除持久化实体</strong><br>通过Session的delete()方法来删除持久化实例，一旦删除了该持久化实例，则对应的数据记录也将被删除。</p>
<h3 id="Hibernate进阶">Hibernate进阶</h3><h4 id="Hibernate的关联映射">Hibernate的关联映射</h4><p>关联关系大致有两类，一类是单向关系，另一类是双向关系，单向关系可分为</p>
<ul>
<li>单向1-&gt;1</li>
<li>单向1-&gt;N</li>
<li>单向N-&gt;1</li>
<li>单向N-&gt;N</li>
</ul>
<p>双向关联又可分为</p>
<ul>
<li>双向1-&gt;1</li>
<li>双向1-&gt;N</li>
<li>双向N-&gt;N</li>
</ul>
<h4 id="单向N-1关联">单向N-1关联</h4><p>单向的N-1关联只需从N的一端可以访问1的一端，程序应该在N的一端的持久化类中增加一个属性，该属性引用1的一端的关联实体，对于N-1关联（不管是单向，还是双向）都需要在N的一端使用<code>@ManyToOne</code>修饰代表关联实体的属性。</p>
<h4 id="单向1-1关联">单向1-1关联</h4><p>单向的1-1关联关系，需要在持久化类里增加代表关联实体的成员变量，并为该成员变量增加setter和getter方法。从持久化类的代码上看，单向1-1与单向N-1没有丝毫区别。因为N的一端或者1 的一端都是直接访问关联实体，只需增加代表关联实体的属性即可。对于1-1关联（不管是单向关联，还是双向关联），都需要使用<code>@OneToOne</code>修饰代表关联实体的属性。</p>
<h4 id="单向1-N关联">单向1-N关联</h4><p>单向1-N关联的持久化类发生了改变，持久化类里需要使用集合属性。因为1的一端需要访问N的一端，而N的一端将以集合（Set）形式表现。对于单向1-N关联关系，只需要在1的一端增加Set类型的成员变量，该成员变量记录当前实体所有的关联实体。使用<code>@OneToMany</code>注解修饰1的一端对应N的一端的集合。</p>
<h4 id="单向N-N关联">单向N-N关联</h4><p>单向的N-N关联和1-N关联的持久化类代码完全相同，控制关系的一端需要增加一个Set类型的属性，被关联的持久化实例以集合形式存在。N-N关联必须使用连接表，N-N关联与有连接表的1-N关联非常相似，因此都需要使用<code>@JoinTable</code>来映射连接表，区别是N-N关联要去掉<code>@JoinTable</code>注解的<code>inverseJoinColumns</code>属性所指定的<code>@JoinColumn</code>中的<code>unique=true</code>。</p>
<h4 id="双向1-N关联">双向1-N关联</h4><p>对于1-N关联，Hibernate推荐使用双向关联，而且不要让1的一端控制关联关系，而使用N的一端控制关联关系。双向的1-N关联与N-1关联是完全相同的两种情形，两端都需要增加对关联属性的访问，N的一端增加引用到关联实体的属性，1的一端增加集合属性，集合元素为关联实体。<br>无连接表的双向1-N关联，N的一端需要增加<code>@ManyToOne</code>注解来修饰代表关联实体的属性，而1的一端则需要使用<code>@OneToMany</code>注解来修饰代表关联实体的属性。<br>对于有连接表的双向1-N关联而言，1的一端无需任何改变；只要在N的一端使用<code>@JoinTable</code>显式指定连接表即可。</p>
<h4 id="双向N-N关联">双向N-N关联</h4><p>双向N-N关联需要两端都使用Set集合属性，两端都增加对集合属性的访问。双向N-N关联没有太多选择，只能采用连接表来建立两个实体之间的关联关系。<br>双向N-N关联需要在两端分别使用<code>@ManyToMany</code>修饰Set集合属性，并在两端都使用<code>@JoinTable</code>显式映射连接表。在两端映射连接表时，两端指定的连接表的表明应该相同，而且两端使用<code>@JoinTable</code>时指定的外键列的列名也是相互对应的。<br>如果某一段想放弃控制关联关系，则可在这一段的<code>@ManyToMany</code>注解中指定<code>mappedBy</code>属性，这一段就无需、也不能使用<code>@JoinTable</code>映射连接表了。</p>
<h4 id="双向1-1关联">双向1-1关联</h4><p>双向1-1关联需要使用<code>@OneToOne</code>注解进行映射，并让两个持久化类都增加引用关联实体的属性，并为该属性提供setter和getter方法。</p>
<h4 id="基于复合主键的关联关系">基于复合主键的关联关系</h4><p>在实际项目中并不推荐使用复合主键，总是建议采用没有物理意义的逻辑主键。复合主键的做法不仅会增加数据库建模的难度，而且会增加关联关系的维护成本。</p>
<h4 id="持久化的传播性">持久化的传播性</h4><p>对于关联实体而言，Hibernate默认不会启用级联操作，当父对象被保存时，它关联的子实体不会被保存；父对象被删除时，它关联的子实体不会被删除。为了启用不同持久化操作的级联关系，Hibernate定义了如下级联风格</p>
<ul>
<li><code>CascadeType.ALL</code>: 指定Hibernate将所所有的持久化操作都级联到关联实体</li>
<li><code>CascadeType.MERGE</code>: 指定Hibernate将merge操作级联到关联实体</li>
<li><code>CascadeType.PERSIST</code>: 指定Hibernate将persist操作级联到关联实体</li>
<li><code>CascadeType.REFRESH</code>: 指定Hibernate将refresh操作及镰刀关联实体</li>
<li><code>CascadeType.REMOVE</code>: 指定Hibernate将remove操作级联到关联实体<br>如果程序希望某个操作能被级联传播到关联实体，则可以在配置<code>@OneToMany、@OneToOne、@ManyToMany</code>时通过cascade属性来指定。<em>注意级联风格是可组合的。</em></li>
</ul>
<h3 id="事务控制">事务控制</h3><h4 id="Session与事务">Session与事务</h4><p>SessionFactory对象的创建代价很高，它是线程安全的对象，被设计成可以被所有线程所共享。通常，SessionFactory会在应用程序启动时创建，一旦创建了SessionFactory就不会轻易关闭，只有当应用退出时才关闭SessionFactory。<br>Session对象是轻量级的，它也是线程不安全的。对于单个业务进程、单个工作单元而言，Session只被使用一次。创建Session时，并不会立即打开与数据库之间的连接，只有需要进行数据库操作时，Session才会获取JDBC连接。因此，打开和关闭Session，并不会对性能造成很大的影响。</p>
<h4 id="一级、二级缓存">一级、二级缓存</h4><p>Hibernate包括两个级别的缓存</p>
<ul>
<li>默认总是启用的Session级别的一级缓存</li>
<li>可选的SessionFactory级别的二级缓存</li>
</ul>
<p>其中Session级别的一级缓存不需要开发者关心，默认总是有效的，当应用保存持久化实体、修改持久化实体时，Session并不会立即把这种改变flush到数据库，而是缓存在当前Session的一级缓存中，除非程序显式调用Session的flush()方法，或程序关闭Session时才会把这些改变一次性的flush到底层数据库。</p>
<p>SessionFactory级别的二级缓存是全局性的，应用的所有Session都共享这个二级缓存。不过SessionFactory级别的二级缓存默认是关闭的，必须由程序显式开启。一旦在应用程序中开启了二级缓存，当Session需要抓取数据时，Session将会先查找一级缓存，再查找二级缓存，只有当一级缓存和二级缓存中都没有要抓取的数据时，才会去查找底层数据库。</p>
<h4 id="查询缓存">查询缓存</h4><p>一级、二级缓存都是对整个实体进行缓存，它不会缓存普通属性，如果想对普通属性进行缓存，则可以考虑使用查询缓存。</p>
<p><strong><em>Notes</em></strong></p>
<blockquote>
<p>需要指出的是，在大部分情况下查询缓存并不能提高应用性能，甚至反而会降低应用性能，因此在实际项目中请慎重使用查询缓存。</p>
</blockquote>
<p>对于查询缓存来说，它缓存的key就是查询所用的HQL或SQL语句。需要指出的是，查询缓存不仅要求所使用的HQL或SQL语句相同，甚至要求所传入的参数也相同，Hibernate才能直接从查询缓存中取得数据。</p>
<p>查询缓存默认是关闭的，为了开启需要在hibernate.cfg.xml中配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"hibernate.cache.use_query_cache"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>除此之外，在程序中还必须调用Query对象的<code>setCacheable(true)</code>才会对查询结果进行缓存。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置查询缓存，在第二次查询时不会重新发出SQL语句进行查询</span></span><br><span class="line">session.createQuery(<span class="string">"select name, age from person"</span>).setCacheable(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="事件机制">事件机制</h3><p>在Hibernate执行持久化的过程中，应用程序通常都无法参与其中。所有的数据持久化操作，对用户都是透明的，用户无法插入自己的动作。<br>通过事件框架，Hibernate允许应用程序能响应特定的内部事件，从而允许实现某些通用的功能，或者对Hibernate功能进行扩展。<br>Hibernate的事件框架由两部分组成</p>
<ul>
<li>拦截器机制: 对于特定动作拦截，回调应用中的特定动作</li>
<li>事件系统: 重写Hibernate的事件监听器</li>
</ul>
<h4 id="拦截器">拦截器</h4><p>拦截器通过Interceptor接口，可以从Session中回调应用程序的特定方法，这种回调机制可让应用程序在持久化对象被保存、更新、删除或加载之前，检查并修改其属性。<br>通过Interceptor接口，可以在数据进入数据库之前，对数据进行最后的检查，如果数据不符合要求，则可以修改数据，从而避免非法数据进入数据库。<br>使用拦截器按如下步骤进行</p>
<ul>
<li>定义实现Interceptor接口的拦截器类</li>
<li>通过Session启用拦截器，或者通过Configuration启用全局拦截器</li>
</ul>
<h4 id="事件系统">事件系统</h4><p>Hibernate的事件系统完全可以替代拦截器，也可以作为拦截器的补充来使用。<br>使用事件系统按如下步骤进行</p>
<ul>
<li>实现自己的事件监听器类</li>
<li>注册自定义事件监听器，代替系统默认的事件监听器</li>
</ul>
<p>实现用户的自定义监听器有如下三种方法</p>
<ol>
<li>实现对应的监听器接口: 实现接口必须实现接口内的所有方法，关键是必须实现Hibernate对应的持久化操作，即数据库访问，这以为这程序员完全取代了Hibernate的底层操作</li>
<li>继承事件适配器:  可以有选择则行地实现需要关注的方法，但依然试图取代Hibernate完成数据库的访问</li>
<li>继承系统默认的事件监听器: 扩展特定方法</li>
</ol>
<p>通常推荐采用第三种方法实现自己的事件监听器。Hibernate默认的事件监听器都被声明成non-final，以便用户继承他们。</p>
<p>参考资料<br>【1】轻量级JavaEE企业应用实战-Struts2+Spring4+Hibernate整合开发</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/18/Basic-knowledge-summary-of-Struts2/" itemprop="url">
                  Struts2基础知识汇总
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-06-18T15:41:01+08:00" content="2015-06-18">
              2015-06-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/18/Basic-knowledge-summary-of-Struts2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/18/Basic-knowledge-summary-of-Struts2/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong><em>力求用最简洁的文字表述最全面的知识，本Blog不适合零基础人员</em></strong><br><img src="http://7xig3q.com1.z0.glb.clouddn.com/struts2-logo.png" alt="logo"></p>
<h3 id="Struts2简介">Struts2简介</h3><p>Struts2是由传统的Struts1、WebWork两个经典的MVC框架发展起来，如下图所示，无论从Struts2设计的角度还是在实际项目中的易用性来看，Struts2都是一个非常优秀的MVC框架，当然目前还有另外一个非常优秀的MVC框架——SpringMVC，以后再对它进行介绍。<br><img src="http://7xig3q.com1.z0.glb.clouddn.com/webwork+struts=struts2.png" alt="Struts2"></p>
<h3 id="实现Action">实现Action</h3><p>Struts2的Action类是一个普通的POJO（通常应该包含一个无参数的execute方法），Struts2直接使用Action来封装HTTP请求参数，因此，Action类里还应该包含与请求参数对应的实例变量，并且为这些实例变量提供对应的setter和getter方法。注意其实实例变量是可以省略的，因为Struts2是通过对应的setter和getter方法来处理请求参数的，而不是通过实例变量名来处理请求参数的。</p>
<h4 id="Action访问Servlet_API">Action访问Servlet API</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ActionContext ctx = ActionContext.getContext();<span class="comment">//相当于JSP中内置的request</span></span><br><span class="line">ctx.getApplication();<span class="comment">//返回Map对象，该对象模拟了ServletContext实例，相当于JSP中内置的application</span></span><br><span class="line">ctx.getSession();<span class="comment">//返回Map对象，该对象模拟了HttpSession实例，相当于JSP中内置的session</span></span><br></pre></td></tr></table></figure>
<h4 id="Action直接访问Servlet_API">Action直接访问Servlet API</h4><p>Struts2提供了几个接口供我们直接访问ServletAPI</p>
<ul>
<li><code>ServletContextAware</code>: 实现该接口的Action可以直接访问Web应用的ServletContext实例</li>
<li><code>ServletRequestAware</code>: 实现该接口的Action可以直接访问用户请求的HttpServletRequest实例</li>
<li><code>ServletResponseAware</code>: 实现该接口的Action可以直接访问服务器响应的HttpServletResponse实例</li>
</ul>
<h4 id="使用ServletActionContext访问Servlet_API">使用ServletActionContext访问Servlet API</h4><p>Struts2还提供了一个ServletActionContext工具类，这个类包含如下几个静态方法</p>
<ul>
<li><code>static PageContext getPageContext()</code>: 取得Web应用的PageContext对象</li>
<li><code>static HttpServletRequest getRequest()</code>: 取得Web应用的HttpServletRequest对象</li>
<li><code>static HttpServletResponse getResponse()</code>: 取得Web应用的HttpServletResponse对象</li>
<li><code>static ServletContext getServletContext()</code>: 取得Web应用的ServletContext对象</li>
</ul>
<h3 id="Action包和命名空间">Action包和命名空间</h3><p>在struts.xml中配置Action，如果没有指定namespace属性，那么该包使用默认的命名空间，如果namespace=”/“表示指定根命名空间。默认命名空间里的Action可以处理任何命名空间下的Action请求，但根命名空间下的Action只处理根命名空间下的Action请求，这是根命名空间和默认命名空间的区别。</p>
<h4 id="配置默认Action">配置默认Action</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">package</span> <span class="attribute">name</span>=<span class="value">"..."</span> <span class="attribute">extends</span>=<span class="value">"struts-default"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">default-action-ref</span> <span class="attribute">name</span>=<span class="value">"simpleViewAction"</span>/&gt;</span></span><br><span class="line">    //当用户请求找不到对应的Action时，系统默认的Action将处理用户请求</span><br><span class="line">    <span class="tag">&lt;<span class="title">action</span> <span class="attribute">name</span>=<span class="value">"simpleViewAction"</span> <span class="attribute">class</span>=<span class="value">"..."</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">result...</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">action</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">package</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将默认Action配置在默认命名空间里就可以让该Action处理所有用户请求，因为默认命名空间的Action可以处理任何命名空间的请求。</p>
<h3 id="Struts2内建的支持结果类型">Struts2内建的支持结果类型</h3><ul>
<li>chain: Action链式处理的结果类型</li>
<li>dispatcher: 用于指定使用JSP作为视图的结果类型，默认值</li>
<li>freemarker: 用于指定使用FreeMarker模板作为视图的结果类型</li>
<li>httpheader: 用于控制特殊的HTTP行为的结果类型</li>
<li>redirect: 用于直接跳转到其他URL的结果类型</li>
<li>redirectAction: 用于直接跳转到其他Action的结果类型</li>
<li>stream: 用于向浏览器返回一个InputStream</li>
<li>velocity: 用于指定使用Velocity模板作为视图的结果类型</li>
<li>xslt: 用于与XML/XSLT整合的结果类型</li>
<li>plainText: 用于显示某个页面的原始代码的结果类型</li>
</ul>
<p><strong><em>Notes</em></strong></p>
<ol>
<li>dispatcher结果类型是将请求forward（转发）到指定的JSP资源；而redirect结果类型，是将请求redirect（重定向）到指定的视图资源，重定向会丢失所有的请求参数、请求属性——当然也丢失了Action的处理结果。</li>
<li>使用redirect类型的结果时，不能重定向到<code>/WEB-INF/</code>路径下任何资源，因为重定向相当于重新发送请求，而Web应用的<code>/WEB-INF/</code>路径下资源是受保护资源。</li>
<li>使用redirectAction结果类型时，系统将重新生成一个新请求，只是该请求的URL是一个Action，因此前一个Action处理结果、请求参数、请求属性都会丢失。</li>
</ol>
<h3 id="Struts2异常处理">Struts2异常处理</h3><h4 id="Struts2开启异常映射">Struts2开启异常映射</h4><p>默认的在struts-default.xml中已经开启了异常映射，代码如下<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">interceptors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置异常处理的拦截器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">interceptor</span> <span class="attribute">name</span>=<span class="value">"exception"</span> <span class="attribute">class</span>=<span class="value">"com.opensymphony.xwork.interceptor.ExceptionMapping.Interceptor"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">interceptor-stakc</span> <span class="attribute">name</span>=<span class="value">"defaultStack"</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">&lt;!--加入默认的拦截器栈--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">interceptor-ref</span> <span class="attribute">name</span>=<span class="value">"exception"</span>/&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="title">interceptor-stakc</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Struts2输出异常信息">Struts2输出异常信息</h4><p><code>&lt;s:property value=&quot;exception&quot;/&gt;</code>: 输出异常对象本身<br><code>&lt;s:property value=&quot;exceptionStck&quot;/&gt;</code>: 输出异常堆栈信息<br><code>&lt;s:property value=&quot;exception.message&quot;/&gt;</code>: 输出异常的message消息</p>
<h4 id="Convention插件与“约定”支持">Convention插件与“约定”支持</h4><p>有Ruby on Rails开发经验的朋友知道Rails有一条重要原则：约定优于配置。Rails开发者只需要按约定开发ActiveRecord/ActiveController即可，无需进行配置。Struts2的Convention插件借鉴了Rails的创意。</p>
<h5 id="Action的搜索和映射约定">Action的搜索和映射约定</h5><p>使用Convention插件，将Struts2项目下的struts2-convention-plugin-2.3.16.3.jar复制到项目的WEB-INF/lib下即可。<br>对于Convention插件而言，它会自动搜索位于action、actions、struts、struts2包下的所有Java类，Convention插件会把如下两种Java类当成Action处理。</p>
<ul>
<li>所有实现了com.opensymphony.xwork2.Action的Java类</li>
<li>所有类名以Action结尾的Java类</li>
</ul>
<p>Struts2的Convention插件还允许设置如下三个常量</p>
<ul>
<li>struts.convention.exclude.packages: 指定不扫描哪些包下的Java类，位于这些包结构下的Java类将不会被自动映射成Action</li>
<li>struts.convention.package.locators: Convention插件使用该常量指定的包作为搜寻Action的根包。例如actions.base.LoginAction类，按约定原本映射到/base/login；如果将该常量设置为base，则该Action将会映射到/login</li>
<li>struts.convention.action.packages: Convention插件以该常量指定包作为根包来搜索Action类，Convention插件除了扫描action、actions、struts、struts2四个包的类之外，还会扫描该常量指定的一个或多个包，Convention会视图从中发现Action类</li>
</ul>
<p>部署Action时，action、actions、struts、struts2包会映射成根（/）命名空间，而这些包下的子包则被映射成对应的命名空间。<br>例如：edu.shu.action.base.LoginAction 映射到/base/命名空间</p>
<p>Action的那么属性（即该Action处理的URL）根据Action的类名映射，需遵循如下两步规则：</p>
<ul>
<li>如果该Action类名包含Action后缀，将该Acting类名的Action后缀去掉，否则不做任何处理</li>
<li>将Action类名的驼峰写法转成中划线写法，所有字母小写</li>
</ul>
<p>例如edu.shu.action.base.UserLoginAction映射的URL是/base/user-login.action</p>
<h5 id="按约定映射Result">按约定映射Result</h5><p>Convention默认也为作为逻辑视图和物理视图之间的映射提供了约定，默认情况下，Convention总会到Web应用的WEB-INF/content路径下定位物理资源，定位资源的约定是actionName+resultcode+suffix。当某个逻辑视图找不到对应的视图资源时，Convention会自动视图使用actionName+sufix作为物理视图资源。</p>
<table>
<thead>
<tr>
<th>Action的URL</th>
<th style="text-align:right">返回的逻辑视图名</th>
<th style="text-align:center">结果类型</th>
<th>对应的物理视图</th>
</tr>
</thead>
<tbody>
<tr>
<td>/login</td>
<td style="text-align:right">success</td>
<td style="text-align:center">Dispatcher</td>
<td>\WEB-INF\content\login-success.jsp</td>
</tr>
<tr>
<td>/login</td>
<td style="text-align:right">success</td>
<td style="text-align:center">Dispatcher</td>
<td>\WEB-INF\content\login-success.html</td>
</tr>
<tr>
<td>/login</td>
<td style="text-align:right">success</td>
<td style="text-align:center">Dispatcher</td>
<td>\WEB-INF\content\login.jsp</td>
</tr>
<tr>
<td>/login</td>
<td style="text-align:right">success</td>
<td style="text-align:center">Dispatcher</td>
<td>\WEB-INF\content\login.html</td>
</tr>
<tr>
<td>/shu/get-book</td>
<td style="text-align:right">error</td>
<td style="text-align:center">FreeMarker</td>
<td>\WEB-INF\content\shu\get-book-error.ftl</td>
</tr>
<tr>
<td>/shu/get-book</td>
<td style="text-align:right">error</td>
<td style="text-align:center">FreeMarker</td>
<td>\WEB-INF\content\shu\get-book.ftl</td>
</tr>
<tr>
<td>/shu/get-book</td>
<td style="text-align:right">input</td>
<td style="text-align:center">Velocity</td>
<td>\WEB-INF\content\shu\get-book-input.vm</td>
</tr>
<tr>
<td>/shu/get</td>
<td style="text-align:right">input</td>
<td style="text-align:center">Velocity</td>
<td>\WEB-INF\content\shu\get-input.vm</td>
</tr>
</tbody>
</table>
<h5 id="Action链的约定">Action链的约定</h5><p>如果希望一个Action处理结束后不是进入视图页面，而是进入另一个Action形成的Action链，则通过Convention插件只需遵守如下三个约定</p>
<ul>
<li>第一个Action返回的逻辑视图字符串没有对应的视图资源</li>
<li>第二个Action与第一个Action处于同一个包下</li>
<li>第二个Action映射的URL为: firstactionName+resultcode</li>
</ul>
<h5 id="自动重加载映射">自动重加载映射</h5><p>在struts.xml中配置如下两个常量即可使Convention插件重加载映射<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">constant</span> <span class="attribute">name</span>=<span class="value">"struts.devMode"</span> <span class="attribute">value</span>=<span class="value">"true"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">constant</span> <span class="attribute">name</span>=<span class="value">"struts.convention.classes.reload"</span> <span class="attribute">value</span>=<span class="value">"true"</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Struts2标签库">Struts2标签库</h3><h4 id="Struts2标签库概述">Struts2标签库概述</h4><p>从最大的范围来分，Struts2可以将所有标签分成如下三类</p>
<ol>
<li>UI标签: 主要用于生成HTML元素的标签<br>1.1. 表单标签: 主要用于生成HTML页面的form元素，以及普通表单元素的标签<br>1.2. 非表单元素: 主要用于生成页面的树、Tab页等标签</li>
<li>非UI标签: 主要用于数据访问、逻辑控制等的标签<br>2.1 流程控制标签: 主要包含用于实现分支、循环等流程控制的标签<br>2.2 数据访问标签: 主要包含用于输出ValueStack中的值、完成国际化等功能的标签</li>
<li>Ajax标签: 用于Ajax支持的标签</li>
</ol>
<h4 id="OGNL表达式语言">OGNL表达式语言</h4><p>OGNL的顶级对象是Stack Context，Stack Context对象就是一个Map类型的实例，其根对象就是Value Stack。OGNL的Stack Context里除了包括ValueStack这个根之外，还包括parameters、request、session、application、attr等命名对象，但这些命名对象都不是根。Stack Context“根”对象和普通命名对象的区别在于</p>
<ul>
<li>访问Stack Context里的命名对象需要在对象名之前添加#前缀</li>
<li>访问OGNL的Stack Context里“根”对象的属性时，可以省略对象名</li>
</ul>
<h3 id="Struts2拦截器">Struts2拦截器</h3><h4 id="配置默认拦截器">配置默认拦截器</h4><p>当配置一个包时，可以为其指定默认拦截器。一旦为某个包指定了默认的拦截器，如果该包中的Action没有显式指定拦截器，则默认的拦截器将会起作用。如果一旦为该包中的Action显式应用了某个拦截器，则默认的拦截器不会起作用，如果该Action还需要使用默认拦截器，则必须手动配置该拦截器的引用。</p>
<h4 id="拦截器的执行顺序">拦截器的执行顺序</h4><p>在Action的控制方法执行之前，位于拦截器链前面的拦截器将先发生作用；在Action的控制方法执行之后，位于拦截器链前面的拦截器将后发生作用。</p>
<p>参考资料<br>【1】轻量级JavaEE企业应用实战-Struts2+Spring4+Hibernate整合开发</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/17/Basic-knowledge-summary-of-JSP-Servlet/" itemprop="url">
                  JSP/Servlet基础知识汇总
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-06-17T18:25:37+08:00" content="2015-06-17">
              2015-06-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Programming-Notes/" itemprop="url" rel="index">
                    <span itemprop="name">Programming Notes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/17/Basic-knowledge-summary-of-JSP-Servlet/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/17/Basic-knowledge-summary-of-JSP-Servlet/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><strong><em>力求用最简洁的文字表述最全面的知识，本Blog不适合零基础人员</em></strong></p>
<h3 id="JSP与Servlet">JSP与Servlet</h3><p>所有的JSP页面最终都会被编译成Servlet执行，而在Servlet类中主要有三个方法，分别是</p>
<ul>
<li>init(): 初始化JSP/Servlet的方法</li>
<li>destroy(): 销毁JSP/Servlet的方法</li>
<li>service(): 对用户请求生成响应的方法</li>
</ul>
<p>JSP页面必须放到应用服务器中运行，当第一次访问JSP页面时，该JSP页面会被编译成Servlet，如果JSP没有改动的话，以后访问的都是第一次编译成功的Servlet。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2015/06/17/Basic-knowledge-summary-of-JSP-Servlet/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/06/03/MySql-dump-Import-Export-Database-Command-Summary/" itemprop="url">
                  MySql dump导入导出数据库命令汇总
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-06-03T18:26:46+08:00" content="2015-06-03">
              2015-06-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index">
                    <span itemprop="name">Database</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/06/03/MySql-dump-Import-Export-Database-Command-Summary/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/03/MySql-dump-Import-Export-Database-Command-Summary/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="导出所有的数据库">导出所有的数据库</h4><blockquote>
<p>mysqldump -uuserName -ppassword —all-database &gt; D:/all.sql</p>
</blockquote>
<p>需要注意的是，该命令需要在MySql的安装目录的bin目录下使用，例如在bin下输入mysqldump，会给出提示信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\MySQL\MySQL Server <span class="number">5.6</span>\bin &gt; mysqldump</span><br><span class="line">Usage: mysqldump [OPTIONS] database [tables]</span><br><span class="line">OR     mysqldump [OPTIONS] --databases [OPTIONS] DB1 [DB2 DB3...]</span><br><span class="line">OR     mysqldump [OPTIONS] --all-databases [OPTIONS]</span><br><span class="line">For more options, use mysqldump --help</span><br></pre></td></tr></table></figure></p>
<h4 id="导入所有的数据库">导入所有的数据库</h4><blockquote>
<p>source D:/all.sql</p>
</blockquote>
<p>需要注意的是，该命令需要在MySql的命令行窗口中使用（<strong>MySql commond line client</strong>），例如在命令行中输入source，给出提示信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">source</span></span><br><span class="line">ERROR:</span><br><span class="line">Usage: \. &lt;filename&gt; | <span class="built_in">source</span> &lt;filename&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="导出某个数据库">导出某个数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\MySQL\MySQL Server <span class="number">5.6</span>\bin&gt;mysqldump -uroot -padmin --databases</span><br><span class="line"> mysql mywebsite &gt; D:/mysqlmywebsite.sql</span><br><span class="line">Warning: Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br></pre></td></tr></table></figure>
<p>这种方式会将<strong>mysql和mywebsite</strong>两个数据库导入到一个sql文件中，文件名称为<strong>mysqlmywebsite</strong></p>
<h4 id="导入某个数据库">导入某个数据库</h4><blockquote>
<p>mysql&gt;source D:/mysqlmywebsite.sql<br>或者在cmd的命令行中指定导入的数据库<br>C:\Program Files\MySQL\MySQL Server 5.6\bin&gt;mysql -uroot -padmin db1 &lt; D:/db1.sql</p>
</blockquote>
<h4 id="导出某些数据表">导出某些数据表</h4><blockquote>
<p>C:\Program Files\MySQL\MySQL Server 5.6\bin&gt; mysqldump -uusername -ppassword db1 table1 table2 &gt; tb1tb2.sql</p>
</blockquote>
<h4 id="导入某些数据表">导入某些数据表</h4><blockquote>
<p>在系统命令行<br> mysql -uusername -ppassword db1 &lt; tb1tb2.sql<br> 或MySql命令行<br> mysql&gt; use db1;<br> mysql&gt; source tb1tb2.sql;</p>
</blockquote>
<h4 id="mysqldump字符集设置">mysqldump字符集设置</h4><blockquote>
<p> mysqldump -uusername -ppassword —default-character-set=UTF8 db1 table1 &gt; tb1.sql</p>
</blockquote>
<p>注意在MySql中，用UTF8表示UTF-8编码，比如在MySql命令行中输入<strong>show charset;</strong>可以查看到MySql所支持的所有字符集</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&#62; show charset;&#10;+----------+-----------------------------+---------------------+--------+&#10;| Charset  | Description                 | Default collation   | Maxlen |&#10;+----------+-----------------------------+---------------------+--------+&#10;| big5     | Big5 Traditional Chinese    | big5_chinese_ci     |      2 |&#10;| dec8     | DEC West European           | dec8_swedish_ci     |      1 |&#10;| cp850    | DOS West European           | cp850_general_ci    |      1 |&#10;| hp8      | HP West European            | hp8_english_ci      |      1 |&#10;| koi8r    | KOI8-R Relcom Russian       | koi8r_general_ci    |      1 |&#10;| latin1   | cp1252 West European        | latin1_swedish_ci   |      1 |&#10;| latin2   | ISO 8859-2 Central European | latin2_general_ci   |      1 |&#10;| swe7     | 7bit Swedish                | swe7_swedish_ci     |      1 |&#10;| ascii    | US ASCII                    | ascii_general_ci    |      1 |&#10;| ujis     | EUC-JP Japanese             | ujis_japanese_ci    |      3 |&#10;| sjis     | Shift-JIS Japanese          | sjis_japanese_ci    |      2 |&#10;| hebrew   | ISO 8859-8 Hebrew           | hebrew_general_ci   |      1 |&#10;| tis620   | TIS620 Thai                 | tis620_thai_ci      |      1 |&#10;| euckr    | EUC-KR Korean               | euckr_korean_ci     |      2 |&#10;| koi8u    | KOI8-U Ukrainian            | koi8u_general_ci    |      1 |&#10;| gb2312   | GB2312 Simplified Chinese   | gb2312_chinese_ci   |      2 |&#10;| greek    | ISO 8859-7 Greek            | greek_general_ci    |      1 |&#10;| cp1250   | Windows Central European    | cp1250_general_ci   |      1 |&#10;| gbk      | GBK Simplified Chinese      | gbk_chinese_ci      |      2 |&#10;| latin5   | ISO 8859-9 Turkish          | latin5_turkish_ci   |      1 |&#10;| armscii8 | ARMSCII-8 Armenian          | armscii8_general_ci |      1 |&#10;| utf8     | UTF-8 Unicode               | utf8_general_ci     |      3 |&#10;| ucs2     | UCS-2 Unicode               | ucs2_general_ci     |      2 |&#10;| cp866    | DOS Russian                 | cp866_general_ci    |      1 |&#10;| keybcs2  | DOS Kamenicky Czech-Slovak  | keybcs2_general_ci  |      1 |&#10;| macce    | Mac Central European        | macce_general_ci    |      1 |&#10;| macroman | Mac West European           | macroman_general_ci |      1 |&#10;| cp852    | DOS Central European        | cp852_general_ci    |      1 |&#10;| latin7   | ISO 8859-13 Baltic          | latin7_general_ci   |      1 |&#10;| utf8mb4  | UTF-8 Unicode               | utf8mb4_general_ci  |      4 |&#10;| cp1251   | Windows Cyrillic            | cp1251_general_ci   |      1 |&#10;| utf16    | UTF-16 Unicode              | utf16_general_ci    |      4 |&#10;| utf16le  | UTF-16LE Unicode            | utf16le_general_ci  |      4 |&#10;| cp1256   | Windows Arabic              | cp1256_general_ci   |      1 |&#10;| cp1257   | Windows Baltic              | cp1257_general_ci   |      1 |&#10;| utf32    | UTF-32 Unicode              | utf32_general_ci    |      4 |&#10;| binary   | Binary pseudo charset       | binary              |      1 |&#10;| geostd8  | GEOSTD8 Georgian            | geostd8_general_ci  |      1 |&#10;| cp932    | SJIS for Windows Japanese   | cp932_japanese_ci   |      2 |&#10;| eucjpms  | UJIS for Windows Japanese   | eucjpms_japanese_ci |      3 |&#10;+----------+-----------------------------+---------------------+--------+&#10;40 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/author.jpg"
               alt="Wang Xu" />
          <p class="site-author-name" itemprop="name">Wang Xu</p>
          <p class="site-description motion-element" itemprop="description">志不强者智不达，言不信者行不果</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">43</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="shijiebei2009" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="wangx89@126.com" target="_blank">
                  
                    <i class="fa fa-globe"></i> email
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="codepub" target="_blank">
                  
                    <i class="fa fa-globe"></i> linkedin
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="4204922" target="_blank">
                  
                    <i class="fa fa-globe"></i> stackoverflow
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="codepub.cn" target="_blank">
                  
                    <i class="fa fa-globe"></i> zhihu
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="shijiebei2009" target="_blank">
                  
                    <i class="fa fa-globe"></i> douban
                  
                </a>
              </span>
            
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Xu</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"codepub"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  


</body>
</html>
